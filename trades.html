<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>보통주(숏) - 우선주(롱) 매매 리포트</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 30px;
        }

        .trade-table,
        .trade-table th,
        .trade-table td {
            border: 1px solid #888;
            border-collapse: collapse;
            padding: 7px;
        }

        .trade-table {
            margin-top: 15px;
            min-width: 900px;
        }

        input {
            margin: 0 4px;
        }

        .status-완료 {
            color: green;
            font-weight: bold;
        }

        .status-진행중 {
            color: orange;
        }

        #liveMsg {
            color: #d00;
            font-size: 13px;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <h2>보통주(숏) - 우선주(롱) 매매 리포트</h2>
    <label for="tickSelect">종목 선택:</label>
    <select id="tickSelect"></select>
    <span id="liveMsg"></span>
    <div style="margin:10px 0;">
        <b>실시간 가격</b> -
        보통주: <span id="liveCommon">-</span>
        / 우선주: <span id="livePref">-</span>
        / 날짜: <span id="liveDate">-</span>
        / SZ: <span id="liveSz">-</span>
    </div>
    <form onsubmit="event.preventDefault(); addTrade();">
        <input type="number" id="shortPrice" placeholder="보통주(숏) 진입가" required min="1000">
        <input type="number" id="longPrice" placeholder="우선주(롱) 진입가" required min="1000">
        <input type="number" id="qty" placeholder="수량" required min="1">
        <input type="number" id="fee" value="0.02" step="0.01" min="0" max="1" style="width:50px;">%
        <input type="number" id="shortExit" placeholder="보통주 청산가(선택)">
        <input type="number" id="longExit" placeholder="우선주 청산가(선택)">
        <button>내역 추가/수정</button>
        <button type="button" onclick="clearTrades();">내역 초기화</button>
    </form>
    <table class="trade-table" id="tradeTable"></table>
    <script>
        // 1. 종목 리스트 및 셀렉트박스 채우기
        const TICK_PAIRS = [
            ['005930', '005935', '삼성전자'],
            ['450140', '450145', '코오롱모빌리티그룹'],
            ['004100', '004105', '태양금속'],
            ['004250', '004255', 'NPC'],
            ['001790', '001795', '대한제당'],
            ['004830', '004835', '덕성'],
            ['007810', '007815', '코리아써키트'],
            ['002020', '002025', '코오롱'],
            ['005380', '005385', '현대차'],
            ['003540', '003545', '대신증권'],
            ['004980', '004985', '성신양회'],
            ['003070', '003075', '코오롱글로벌'],
            ['005940', '005945', 'NH투자증권'],
            ['019170', '019175', '신풍제약'],
            ['066570', '066575', 'LG전자'],
            ['009830', '009835', '한화솔루션'],
            ['004360', '004365', '세방'],
            ['003530', '003535', '한화투자증권'],
            ['051900', '051905', 'LG생활건강'],
            ['090430', '090435', '아모레퍼시픽'],
            ['051910', '051915', 'LG화학'],
            ['002790', '002795', '아모레G'],
            ['003490', '003495', '대한항공'],
            ['010950', '010955', 'S-Oil'],
            ['180640', '180645', '한진칼'],
            ['001510', '001515', 'SK증권'],
            ['071050', '071055', '한국금융지주'],
            ['363280', '363285', '티와이홀딩스'],
            ['006800', '006805', '미래에셋증권'],
            ['005960', '005965', '동부건설'],
            ['264900', '264905', '크라운제과'],
            ['000150', '000155', '두산'],
            ['008350', '008355', '남선알미늄'],
            ['011780', '011785', '금호석유'],
            ['005720', '005725', '넥센'],
            ['108670', '108675', 'LX하우시스'],
            ['000810', '000815', '삼성화재'],
            ['084690', '084695', '대상홀딩스'],
            ['285130', '285135', 'SK케미칼'],
            ['032680', '032685', '소프트센'],
            ['009150', '009155', '삼성전기'],
            ['000320', '000325', '노루홀딩스'],
            ['003550', '003555', 'LG'],
            ['006400', '006405', '삼성SDI'],
            ['120110', '120115', '코오롱인더'],
            ['006340', '006345', '대원전선'],
            ['009410', '009415', '태영건설'],
            ['000540', '000545', '흥국화재'],
            ['021040', '021045', '대호특수강'],
            ['012200', '012205', '계양전기'],
            ['001750', '001755', '한양증권'],
            ['008770', '008775', '호텔신라'],
            ['096770', '096775', 'SK이노베이션'],
            ['004410', '004415', '서울식품'],
            ['000720', '000725', '현대건설'],
            ['375500', '375505', 'DL이앤씨'],
            ['078930', '078935', 'GS'],
            ['014280', '014285', '금강공업'],
            ['001680', '001685', '대상'],
            ['002990', '002995', '금호건설'],
            ['097950', '097955', 'CJ제일제당'],
            ['006120', '006125', 'SK디스커버리'],
            ['000210', '000215', 'DL'],
            ['090350', '090355', '노루페인트'],
            ['001520', '001525', '동양'],
            ['000880', '000885', '한화'],
            ['001040', '001045', 'CJ'],
            ['005740', '005745', '크라운해태홀딩스'],
            ['005300', '005305', '롯데칠성'],
            ['034730', '034735', 'SK'],
            ['014910', '014915', '성문전자'],
            ['007570', '007575', '일양약품'],
            ['004990', '004995', '롯데지주'],
            ['004540', '004545', '깨끗한나라'],
            ['000100', '000105', '유한양행'],
            ['001270', '001275', '부국증권'],
            ['003920', '003925', '남양유업'],
            ['003460', '003465', '유화증권'],
            ['145990', '145995', '삼양사'],
            ['001060', '001065', 'JW중외제약'],
            ['000140', '000145', '하이트진로홀딩스'],
            ['001460', '001465', 'BYC'],
            ['000070', '000075', '삼양홀딩스']
        ];
        let selectedTick = TICK_PAIRS[0][0];  // 보통주 코드
        let selectedPref = TICK_PAIRS[0][1];  // 우선주 코드
        let selectedName = TICK_PAIRS[0][2];

        const tickSelect = document.getElementById('tickSelect');
        TICK_PAIRS.forEach(([code, pref, name]) => {
            const opt = document.createElement('option');
            opt.value = code + '|' + pref + '|' + name;
            opt.innerText = `${name} (${code}/${pref})`;
            tickSelect.appendChild(opt);
        });
        tickSelect.onchange = function () {
            [selectedTick, selectedPref, selectedName] = this.value.split('|');
            fetchLiveData();
            renderTradeTable();
        };

        // 2. 실시간 데이터 fetch
        let liveData = {}, lastIdx = -1;
        async function fetchLiveData() {
            const url = `data/trends/${selectedTick}.json?_t=${Date.now()}`;
            document.getElementById('liveMsg').textContent = '';
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error('데이터 파일 없음');
                liveData = await res.json();
                lastIdx = (liveData['dates'] || []).length - 1;
                document.getElementById('liveCommon').textContent = liveData.common_prices?.[lastIdx] ?? '-';
                document.getElementById('livePref').textContent = liveData.preferred_prices?.[lastIdx] ?? '-';
                document.getElementById('liveDate').textContent = liveData.dates?.[lastIdx] ?? '-';
                document.getElementById('liveSz').textContent = liveData.sz_values?.[lastIdx]?.toFixed(2) ?? '-';
            } catch (e) {
                document.getElementById('liveCommon').textContent = '-';
                document.getElementById('livePref').textContent = '-';
                document.getElementById('liveDate').textContent = '-';
                document.getElementById('liveSz').textContent = '-';
                document.getElementById('liveMsg').textContent = '⚠️ 실시간 데이터 파일을 불러올 수 없습니다.';
                liveData = {}; lastIdx = -1;
            }
        }

        // 3. 거래내역 (종목별로 분리)
        function getTradeLog() {
            try { return JSON.parse(localStorage.getItem('trades_v2')) || []; } catch { return []; }
        }
        function setTradeLog(arr) { localStorage.setItem('trades_v2', JSON.stringify(arr)); }

        // 4. 거래 추가/수정
        function addTrade() {
            const shortPrice = Number(shortPriceEl.value);
            const longPrice = Number(longPriceEl.value);
            const qty = Number(qtyEl.value);
            const fee = Number(feeEl.value) / 100;
            const shortExit = shortExitEl.value ? Number(shortExitEl.value) : null;
            const longExit = longExitEl.value ? Number(longExitEl.value) : null;
            if (!shortPrice || !longPrice || !qty) { alert('진입가, 수량 입력!'); return; }
            let list = getTradeLog();
            // 동일 진입/수량 미청산 거래는 업데이트(수정), 아니면 추가
            let updated = false;
            for (let t of list) {
                if (t.tick == selectedTick && t.pref == selectedPref && !t.shortExit && !t.longExit &&
                    t.shortPrice == shortPrice && t.longPrice == longPrice && t.qty == qty) {
                    t.shortExit = shortExit; t.longExit = longExit; t.fee = fee;
                    updated = true; break;
                }
            }
            if (!updated) list.push({
                tick: selectedTick,
                pref: selectedPref,
                name: selectedName,
                shortPrice, longPrice, qty, fee, shortExit, longExit,
                date: liveData.dates?.[lastIdx] || new Date().toISOString().slice(0, 10)
            });
            setTradeLog(list); renderTradeTable();
        }

        // 5. 거래 초기화
        function clearTrades() {
            if (confirm('모든 거래 내역을 삭제하시겠습니까?')) {
                localStorage.removeItem('trades_v2');
                renderTradeTable();
            }
        }

        // 6. 손익/수익률 계산
        function calcPnL(trade) {
            const shortExit = (trade.shortExit != null) ? trade.shortExit : (liveData.common_prices?.[lastIdx] || trade.shortPrice);
            const longExit = (trade.longExit != null) ? trade.longExit : (liveData.preferred_prices?.[lastIdx] || trade.longPrice);
            const shortPnL = (trade.shortPrice - shortExit) * trade.qty;
            const longPnL = (longExit - trade.longPrice) * trade.qty;
            const feeAmt = (trade.shortPrice + shortExit + trade.longPrice + longExit) * trade.qty * trade.fee;
            const totalPnL = shortPnL + longPnL - feeAmt;
            const base = (trade.shortPrice + trade.longPrice) * trade.qty;
            const pnlRate = base > 0 ? totalPnL / base * 100 : 0;
            return { totalPnL, pnlRate };
        }

        // 7. 테이블 렌더링 (종목별 내역만)
        function renderTradeTable() {
            let list = getTradeLog();
            let filtered = list.filter(t => t.tick === selectedTick && t.pref === selectedPref);
            let html = '<tr><th>#</th><th>진입일</th><th>보통주(숏) 진입</th><th>우선주(롱) 진입</th><th>수량</th><th>보통주 청산</th><th>우선주 청산</th><th>손익(수수료포함)</th><th>수익률(%)</th><th>상태</th></tr>';
            let i = 1, total = 0;
            filtered.forEach(t => {
                const { totalPnL, pnlRate } = calcPnL(t);
                let status = (t.shortExit && t.longExit) ? "완료" : "진행중";
                total += totalPnL;
                html += `<tr>
      <td>${i++}</td>
      <td>${t.date || ''}</td>
      <td>${t.shortPrice}</td>
      <td>${t.longPrice}</td>
      <td>${t.qty}</td>
      <td>${t.shortExit ?? '-'}</td>
      <td>${t.longExit ?? '-'}</td>
      <td>${Number.isFinite(totalPnL) ? totalPnL.toFixed(0) : '-'}</td>
      <td>${Number.isFinite(pnlRate) ? pnlRate.toFixed(2) : '-'}</td>
      <td class="status-${status}">${status}</td>
    </tr>`;
            });
            html += `<tr style="font-weight:bold;"><td colspan="7">총 손익합계</td><td>${total.toFixed(0)}</td><td colspan="2"></td></tr>`;
            document.getElementById('tradeTable').innerHTML = html;
        }

        // 8. 입력요소 참조
        const shortPriceEl = document.getElementById('shortPrice');
        const longPriceEl = document.getElementById('longPrice');
        const qtyEl = document.getElementById('qty');
        const feeEl = document.getElementById('fee');
        const shortExitEl = document.getElementById('shortExit');
        const longExitEl = document.getElementById('longExit');

        // 9. 주기적 fetch/표 갱신
        window.onload = function () {
            fetchLiveData(); renderTradeTable();
            setInterval(fetchLiveData, 10000);   // 10초마다 실시간 갱신
            setInterval(renderTradeTable, 10000);
        }
    </script>
</body>

</html>