<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>Trend Detail - Scenario Analysis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .signal-card {
            transition: all 0.3s ease;
        }

        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .blink {
            animation: blink 2s linear infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .signal-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 4px;
        }

        .signal-IN {
            background-color: #FEE2E2;
            color: #DC2626;
        }

        .signal-OUT {
            background-color: #DCFCE7;
            color: #16A34A;
        }

        .signal-CHK {
            background-color: #FEF3C7;
            color: #D97706;
        }

        .sz-high {
            color: #DC2626;
            font-weight: bold;
        }

        .sz-medium {
            color: #EA580C;
            font-weight: bold;
        }

        .sz-low {
            color: #16A34A;
        }

        .slider-wrapper {
            width: 100%;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: #d1d5db;
            border-radius: 5px;
            outline: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-top: -7px;
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            margin-top: -7px;
        }

        input[type="range"]::-webkit-slider-runnable-track {
            background: #d1d5db;
            height: 10px;
            border-radius: 5px;
        }

        input[type="range"]::-moz-range-track {
            background: #d1d5db;
            height: 10px;
            border-radius: 5px;
        }

        input[type="number"] {
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.875rem;
        }
        thead {
            background: #f9fafb;
        }
        th {
            font-weight: 500;
            text-transform: uppercase;
            color: #6b7280;
        }
        tbody {
            background: #fff;
        }
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }

        @media (max-width: 1024px) {
            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-cols-2 {
                grid-template-columns: repeat(1, 1fr);
            }
        }

        @media (max-width: 640px) {

            .grid-cols-3,
            .grid-cols-4,
            .grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .tab-button {
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .signal-card {
                padding: 0.75rem;
            }

            .signal-card h3 {
                font-size: 0.875rem;
                line-height: 1.25rem;
            }

            .text-3xl {
                font-size: 1.5rem;
            }

            .text-xl {
                font-size: 1.2rem;
            }

            button,
            a {
                min-height: 44px;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .flex.justify-between.items-center {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            input[type="range"] {
                height: 8px;
            }

            input[type="range"]::-webkit-slider-thumb {
                width: 20px;
                height: 20px;
                margin-top: -6px;
            }

            input[type="range"]::-moz-range-thumb {
                width: 20px;
                height: 20px;
                margin-top: -6px;
            }

            input[type="number"] {
                font-size: 0.875rem;
                padding: 0.5rem;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen"
    style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Noto Sans KR', sans-serif;">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2" id="stock-name">Scenario Analysis</h1>
                <p class="text-sm text-gray-600">SZ 2.0 target: Price fluctuations</p>
                <p class="text-xs text-gray-500 mt-1">Last Updated: <span id="last-updated-time">Loading...</span></p>
            </div>
            <div class="flex space-x-2">
                <a href="index.html"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-home mr-2"></i> Home
                </a>
                <a href="pair-report.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i> Report
                </a>
            </div>
        </header>

        <div id="loading-container" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-600">Loading data...</p>
        </div>

        <div id="content-container" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Current stock information</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-blue-700 text-sm font-medium mb-1">보통주 가격 [Short]</div>
                        <div class="text-xl font-bold" id="current-common-price">-</div>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <div class="text-purple-700 text-sm font-medium mb-1">우선주 가격 [Long]</div>
                        <div class="text-xl font-bold" id="current-preferred-price">-</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="text-green-700 text-sm font-medium mb-1">현재 SZ 값</div>
                        <div class="text-xl font-bold" id="current-sz-value">-</div>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <div class="text-yellow-700 text-sm font-medium mb-1">현재 괴리율</div>
                        <div class="text-xl font-bold" id="current-discount-rate">-</div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Scenario Analysis Tool</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4"><strong class="text-xl">Price
                                Control</strong></h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                보통주 [Short] ◀
                                <span class="text-xs text-gray-500">(현재: <span
                                        id="common-base-price">-</span>원)</span>
                            </label>
                            <div class="slider-wrapper">
                                <input type="range" id="common-price-slider" class="slider mb-2" min="-5" max="5"
                                    step="0.1" value="0">
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>-5%</span>
                                <span id="common-price-percent">0%</span>
                                <span>+5%</span>
                            </div>
                            <div class="mt-2 text-sm">
                                <span class="font-medium">조정 가격:</span>
                                <span id="common-price-adjusted" class="font-bold text-blue-600">-</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                우선주 [Long] ▶
                                <span class="text-xs text-gray-500">(현재: <span
                                        id="preferred-base-price">-</span>원)</span>
                            </label>
                            <div class="slider-wrapper">
                                <input type="range" id="preferred-price-slider" class="slider mb-2" min="-5" max="5"
                                    step="0.1" value="0">
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>-5%</span>
                                <span id="preferred-price-percent">0%</span>
                                <span>+5%</span>
                            </div>
                            <div class="mt-2 text-sm">
                                <span class="font-medium">조정 가격:</span>
                                <span id="preferred-price-adjusted" class="font-bold text-blue-600">-</span>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-2 gap-2">
                            <button id="reset-sliders-button"
                                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                초기화
                            </button>
                            <button id="calculate-button"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                계산하기
                            </button>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                종목별 투입금 입력 (Unit: 백만원)
                                <span class="text-xs text-gray-500">(Ex: 50 = 5천, 100 = 1억)</span>
                            </label>
                            <input type="number" id="investment-amount"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="백만원 단위로 입력" min="0" step="1">
                        </div>
                    </div>
                    <div id="manual-result" class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4"><strong class="text-xl">SZ Result</strong>
                        </h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-gray-700 text-sm font-medium mb-1">조정된 SZ 값</div>
                                <div class="text-xl font-bold" id="adjusted-sz-value">-</div>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-gray-700 text-sm font-medium mb-1">조정된 괴리율</div>
                                <div class="text-xl font-bold" id="adjusted-discount-rate">-</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-gray-700 text-sm font-medium mb-1">보통주 [Short] 수량</div>
                                <div class="text-xl font-bold" id="common-share-quantity">-</div>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-gray-700 text-sm font-medium mb-1">우선주 [Long] 수량</div>
                                <div class="text-xl font-bold" id="preferred-share-quantity">-</div>
                            </div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow mt-4">
                            <div class="text-gray-700 text-sm font-medium mb-2">Result Analysis</div>
                            <div id="scenario-interpretation" class="text-sm text-gray-800">
                                Adjust the price to calculate the scenario.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- SZ Value Trend -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">SZ Value Trend</h2>
                <div class="chart-container h-96 md:h-80 sm:h-64" style="position: relative;">
                    <canvas id="sz-chart"></canvas>
                </div>
            </div>

            <!-- Price Trend -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Price Trend</h2>
                <div class="chart-container h-96 md:h-80 sm:h-64" style="position: relative;">
                    <canvas id="price-chart"></canvas>
                </div>
            </div>

            <!-- SZ History -->
            <div class="bg-white rounded-lg shadow-md p-6 signal-card">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">SZ History</h2>
                <div class="overflow-x-auto">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>SZ Value</th>
                                <th>Trend</th>
                                <th>Common Stock Price</th>
                                <th>Preferred Stock Price</th>
                            </tr>
                        </thead>
                        <tbody id="signals-table-body">
                            <tr>
                                <td>Loading history data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>© 2025 EQ Pair Monitoring System.</p>
        </div>
    </footer>

    <script>
        function getStockCodeByName(stockName) {
            return stockName ? stockName.toLowerCase().replace(/\s/g, '-') : 'unknown';
        }
        async function fetchLastUpdateTime() {
            try {
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;
                const response = await fetch(stockDataUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch update time (${response.status})`);
                }
                const data = await response.json();
                const updateTime = data.timestamp || data.last_updated || new Date().toLocaleString();
                let formattedDate;
                try {
                    const date = new Date(updateTime);
                    formattedDate = date.toLocaleString();
                } catch (e) {
                    formattedDate = updateTime;
                }
                document.getElementById('last-updated-time').textContent = formattedDate;
            } catch (error) {
                console.error('업데이트 시간 가져오기 실패:', error);
                document.getElementById('last-updated-time').textContent = 'Unknown';
            }
        }
        function resetSliders() {
            document.getElementById('common-price-slider').value = 0;
            document.getElementById('preferred-price-slider').value = 0;
            document.getElementById('common-price-percent').textContent = '0%';
            document.getElementById('preferred-price-percent').textContent = '0%';
            document.getElementById('common-price-adjusted').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('preferred-price-adjusted').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('investment-amount').value = '';
            document.getElementById('adjusted-discount-rate').textContent = '-';
            document.getElementById('adjusted-sz-value').textContent = '-';
            document.getElementById('common-share-quantity').textContent = '-';
            document.getElementById('preferred-share-quantity').textContent = '-';
            document.getElementById('scenario-interpretation').textContent = '가격을 조정하여 시나리오를 계산하세요.';
        }
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const stockCode = urlParams.get('code');
            let stockName = decodeURIComponent(urlParams.get('name') || '');
            stockName = stockName.replace(/<\/?[^>]+(>|$)/g, "");
            if (!stockCode || !stockName) {
                alert('종목 정보가 없습니다. 메인 페이지로 이동합니다.');
                window.location.href = 'index.html';
                return;
            }
            document.title = `${stockName} - Stock Details & Scenario Analysis`;
            document.getElementById('stock-name').textContent = stockName;
            loadAndProcessStockData(stockCode, stockName);
            setupSliderListeners();
            document.getElementById('reset-sliders-button').addEventListener('click', resetSliders);
            document.getElementById('calculate-button').addEventListener('click', calculateManualScenario);
        });

        let stockData = {
            current: {
                commonPrice: 0,
                preferredPrice: 0,
                szValue: 0,
                discountRate: 0,
                signal: ''
            },
            history: {
                dates: [],
                szValues: [],
                discountRates: [],
                mean: 0,
                stdDev: 0,
                commonPrices: [],
                preferredPrices: []
            }
        };

        async function loadAndProcessStockData(stockCode, stockName) {
            console.log(`데이터 로드 시작 - 코드: ${stockCode}, 이름: ${stockName}`);
            try {
                document.getElementById('loading-container').style.display = 'flex';
                document.getElementById('content-container').classList.add('hidden');
                fetchLastUpdateTime();

                const trendData = await loadStockData(stockCode, stockName);
                console.log('Loaded trendData:', trendData);

                const realtimeData = await fetchRealtimeData(stockCode, stockName);

                stockData.current = {
                    commonPrice: realtimeData.commonPrice ||
                        (trendData.common_prices && trendData.common_prices.length > 0 ? trendData.common_prices[trendData.common_prices.length - 1] : 0),
                    preferredPrice: realtimeData.preferredPrice ||
                        (trendData.preferred_prices && trendData.preferred_prices.length > 0 ? trendData.preferred_prices[trendData.preferred_prices.length - 1] : 0),
                    szValue: realtimeData.szValue || 0,
                    signal: realtimeData.signal || '',
                    discountRate: calculateDiscountRate(
                        realtimeData.commonPrice || (trendData.common_prices && trendData.common_prices.length > 0 ? trendData.common_prices[trendData.common_prices.length - 1] : 0),
                        realtimeData.preferredPrice || (trendData.preferred_prices && trendData.preferred_prices.length > 0 ? trendData.preferred_prices[trendData.preferred_prices.length - 1] : 0)
                    )
                };

                stockData.history.dates = trendData.dates ? trendData.dates.slice(-150) : [];
                stockData.history.discountRates = trendData.discount_rates ? trendData.discount_rates.slice(-150) : [];
                stockData.history.commonPrices = trendData.common_prices ? trendData.common_prices.slice(-150) : [];
                stockData.history.preferredPrices = trendData.preferred_prices ? trendData.preferred_prices.slice(-150) : [];
                const windowData = trendData.discount_rates ? trendData.discount_rates.slice(-250, -1) : [];

                if (!windowData.length) {
                    console.warn('windowData is empty. Mean and StdDev will be set to 0.');
                } else if (windowData.every(val => val === windowData[0])) {
                    console.warn('windowData has identical values. StdDev will be 0.');
                }

                stockData.history.mean = calculateMean(windowData);
                stockData.history.stdDev = calculateStdDev(windowData, stockData.history.mean);

                console.log('Mean:', stockData.history.mean, 'StdDev:', stockData.history.stdDev);
                console.log('Discount Rates:', trendData.discount_rates);

                stockData.history.szValues = calculateSZValues(trendData.discount_rates || []).slice(-150);

                console.log('Calculated SZ Values:', stockData.history.szValues);

                updateCurrentInfo();
                renderCharts(trendData);
                renderHistoryData(trendData);

                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('content-container').classList.remove('hidden');
            } catch (error) {
                console.error('데이터 로드 및 처리 오류:', error);
                document.getElementById('loading-container').innerHTML = `
                <div class="text-red-500 text-center">
                    <p>데이터를 로드할 수 없습니다.</p>
                    <p>오류: ${error.message}</p>
                    <p>종목 코드: ${stockCode}, 이름: ${stockName}</p>
                    <div class="mt-4 flex justify-center space-x-4">
                        <button onclick="window.location.reload()" class="px-4 py-2 bg-blue-500 text-white rounded">다시 시도</button>
                        <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-500 text-white rounded">메인 페이지로 돌아가기</button>
                    </div>
                </div>
            `;
            }
        }

        function renderPriceChart(dates, commonPrices, preferredPrices, chartHeight, pointRadius) {
            const ctx = document.getElementById('price-chart').getContext('2d');
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 640;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Common Stock Price',
                            data: commonPrices,
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointRadius: pointRadius,
                            tension: 0.1
                        },
                        {
                            label: 'Preferred Stock Price',
                            data: preferredPrices,
                            backgroundColor: 'rgba(255, 206, 86, 0.2)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 2,
                            pointRadius: pointRadius,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: chartHeight,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw ? context.raw.toLocaleString() : 'N/A'} KRW`;
                                }
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: 'Recent 5-month Price Trend',
                            font: {
                                size: isMobile ? 12 : 16
                            }
                        }
                    },
                    elements: {
                        point: {
                            hitRadius: isMobile ? 10 : 5
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Price (KRW)',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 9 : 12
                                },
                                callback: function (value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 5 : 10,
                                autoSkip: true,
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderCharts(trendData) {
            try {
                const screenWidth = window.innerWidth;
                const isMobile = screenWidth <= 640;
                const chartHeight = isMobile ? 250 : 300;
                const pointRadius = isMobile ? 0 : 1;

                const recentDates = trendData.dates ? trendData.dates.slice(-150) : [];
                const recentCommonPrices = trendData.common_prices ? trendData.common_prices.slice(-150) : [];
                const recentPreferredPrices = trendData.preferred_prices ? trendData.preferred_prices.slice(-150) : [];
                const recentSzValues = stockData.history.szValues || [];

                if (!recentDates.length || !recentCommonPrices.length || !recentPreferredPrices.length || !recentSzValues.length) {
                    throw new Error(`차트 렌더링을 위한 데이터가 부족합니다: dates=${recentDates.length}, common_prices=${recentCommonPrices.length}, preferred_prices=${recentPreferredPrices.length}, sz_values=${recentSzValues.length}`);
                }

                renderSZChart(recentDates, recentSzValues, chartHeight, pointRadius);
                renderPriceChart(recentDates, recentCommonPrices, recentPreferredPrices, chartHeight, pointRadius);
            } catch (error) {
                console.error('차트 렌더링 오류:', error);
                document.getElementById('sz-chart').parentElement.innerHTML = `<p class="text-red-500 text-center">차트 데이터를 로드할 수 없습니다: ${error.message}</p>`;
                document.getElementById('price-chart').parentElement.innerHTML = `<p class="text-red-500 text-center">차트 데이터를 로드할 수 없습니다: ${error.message}</p>`;
            }
        }

        function renderHistoryData(trendData) {
            try {
                const tableBody = document.getElementById('signals-table-body');
                const fiveMonthsInDays = 150;
                const startIndex = Math.max(0, trendData.dates.length - fiveMonthsInDays);
                const displayIndices = [];
                for (let i = trendData.dates.length - 1; i >= startIndex; i -= 1) {
                    displayIndices.push(i);
                }

                if (!trendData || !trendData.dates || trendData.dates.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">이 종목에 대한 히스토리 데이터가 없습니다.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';

                const calculatedSZ = calculateSZValues(trendData.discount_rates);
                const szValueMap = {};
                calculatedSZ.forEach(item => {
                    szValueMap[item.index] = item.value ?? 0;
                });

                for (const i of displayIndices) {
                    const date = trendData.dates[i];
                    const szValue = szValueMap[i] ?? 0;

                    if (szValue === undefined) continue;

                    let szClass = 'text-green-600';
                    if (szValue >= 2.5) {
                        szClass = 'text-red-600 font-bold';
                    } else if (szValue >= 1.5) {
                        szClass = 'text-orange-600 font-bold';
                    }

                    let trendIcon = '-';
                    if (displayIndices.indexOf(i) < displayIndices.length - 1) {
                        const prevIndex = displayIndices[displayIndices.indexOf(i) + 1];
                        const prevSZ = szValueMap[prevIndex] ?? 0;

                        if (szValue > prevSZ) {
                            trendIcon = '<i class="fas fa-arrow-up text-red-500"></i>';
                        } else if (szValue < prevSZ) {
                            trendIcon = '<i class="fas fa-arrow-down text-green-500"></i>';
                        } else {
                            trendIcon = '<i class="fas fa-minus text-gray-500"></i>';
                        }
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${szClass}">${szValue.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${trendIcon}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(trendData.common_prices[i] ?? 0).toLocaleString()} KRW</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(trendData.preferred_prices[i] ?? 0).toLocaleString()} KRW</td>
                `;

                    tableBody.appendChild(row);
                }

                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">이 종목에 대한 히스토리 데이터가 없습니다.</td></tr>';
                }
            } catch (error) {
                console.error('히스토리 데이터 렌더링 오류:', error);
                document.getElementById('signals-table-body').innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">히스토리 데이터를 로드할 수 없습니다.</td></tr>';
            }
        }

        async function fetchRealtimeData(stockCode, stockName) {
            try {
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;
                const response = await fetch(stockDataUrl, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                if (!response.ok) {
                    throw new Error(`실시간 데이터를 가져올 수 없습니다: ${response.status}`);
                }
                const data = await response.json();

                const normalizeStockName = (name) => {
                    if (!name) return '';
                    let cleanName = name.replace(/<[^>]+>/g, '');
                    cleanName = cleanName.replace(/^[\u{1F534}\u{1F7E0}\u{1F7E2}\u{1F535}]\s+/u, '');
                    cleanName = cleanName.replace(/-\d+(\.\d+)?-$/, '').replace(/\s*\(\d+(\.\d+)?\)$/, '');
                    return cleanName.trim();
                };

                const normalizedCurrentName = normalizeStockName(stockName);
                let matchedSignal = null;

                for (const signal of data.all_signals) {
                    const normalizedSignalName = normalizeStockName(signal.stock_name);
                    if (normalizedSignalName === normalizedCurrentName) {
                        matchedSignal = signal;
                        console.log("정확히 일치하는 종목 발견:", normalizedSignalName);
                        break;
                    }
                }

                if (!matchedSignal) {
                    for (const signal of data.all_signals) {
                        const normalizedSignalName = normalizeStockName(signal.stock_name);
                        if (normalizedSignalName.includes(normalizedCurrentName) ||
                            normalizedCurrentName.includes(normalizedSignalName)) {
                            matchedSignal = signal;
                            console.log("부분 일치하는 종목 발견:", normalizedSignalName);
                            break;
                        }
                    }
                }

                if (!matchedSignal && stockCode !== 'unknown') {
                    for (const signal of data.all_signals) {
                        try {
                            const signalCode = getStockCodeByName(normalizeStockName(signal.stock_name));
                            if (signalCode === stockCode) {
                                matchedSignal = signal;
                                console.log("종목 코드로 일치하는 항목 발견:", signalCode);
                                break;
                            }
                        } catch (codeError) {
                            console.warn("종목 코드 추출 실패:", codeError);
                        }
                    }
                }

                if (!matchedSignal) {
                    console.warn("일치하는 종목을 찾을 수 없음:", stockName, stockCode);
                    return {
                        commonPrice: null,
                        preferredPrice: null,
                        szValue: 0,
                        signal: ''
                    };
                }

                return {
                    commonPrice: matchedSignal.price_a || null,
                    preferredPrice: matchedSignal.price_b || null,
                    szValue: matchedSignal.sz_value || 0,
                    signal: matchedSignal.signal || ''
                };
            } catch (error) {
                console.error('실시간 데이터 가져오기 오류:', error);
                return {
                    commonPrice: null,
                    preferredPrice: null,
                    szValue: 0,
                    signal: ''
                };
            }
        }

        function calculateDiscountRate(commonPrice, preferredPrice) {
            if (!commonPrice || !preferredPrice || commonPrice === 0) {
                return 0;
            }
            return (commonPrice - preferredPrice) / commonPrice;
        }

        function getStockCodeByName(stockName) {
            return stockName ? stockName.toLowerCase().replace(/\s/g, '-') : 'unknown';
        }

        async function loadStockData(stockCode, stockName) {
            try {
                // stockCode를 stock-detail.html과 동일하게 처리
                stockCode = getStockCodeByName(stockCode);
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const trendDataUrl = `${baseUrl}/data/trends/${stockCode}.json?t=${new Date().getTime()}`;
                console.log(`Loading trend data from: ${trendDataUrl}`);

                const trendDataResponse = await fetch(trendDataUrl);
                if (!trendDataResponse.ok) {
                    console.error(`트렌드 데이터 요청 실패: ${trendDataResponse.status}`);
                    throw new Error(`트렌드 데이터를 로드할 수 없습니다: ${stockName} (${trendDataResponse.status})`);
                }

                const trendDataText = await trendDataResponse.text();
                console.log(`응답 데이터 샘플: ${trendDataText.substring(0, 100)}...`);

                const cleanedTrendDataText = trendDataText
                    .replace(/"NaN"/g, 'null')
                    .replace(/NaN/g, 'null')
                    .replace(/Infinity/g, 'null')
                    .replace(/-Infinity/g, 'null');

                try {
                    return JSON.parse(cleanedTrendDataText, (key, value) => {
                        if (value === null || value === undefined ||
                            (typeof value === 'string' && (value === 'NaN' || value === 'Infinity' || value === '-Infinity'))) {
                            return null;
                        }
                        if (typeof value === 'number' && !isFinite(value)) {
                            return null;
                        }
                        return value;
                    });
                } catch (parseError) {
                    console.error('트렌드 데이터 JSON 파싱 오류:', parseError);
                    throw new Error(`JSON 파싱 중 오류 발생: ${parseError.message}`);
                }
            } catch (error) {
                console.error('loadStockData 오류:', error);
                throw error;
            }
        }

        async function loadStockDataJson() {
            const response = await fetch(`data/stock_data.json?t=${new Date().getTime()}`);
            if (!response.ok) {
                throw new Error('신호 데이터를 로드할 수 없습니다.');
            }
            const dataText = await response.text();
            const cleanedDataText = dataText
                .replace(/"NaN"/g, 'null')
                .replace(/NaN/g, 'null')
                .replace(/Infinity/g, 'null')
                .replace(/-Infinity/g, 'null');
            return JSON.parse(cleanedDataText);
        }
        function calculateMean(data) {
            const validData = data.filter(val => val !== null && !isNaN(val));
            if (validData.length === 0) return 0;
            const sum = validData.reduce((acc, val) => acc + val, 0);
            return sum / validData.length;
        }
        function calculateStdDev(data, mean) {
            const validData = data.filter(val => val !== null && !isNaN(val));
            if (validData.length === 0) return 0;
            const squaredDiffs = data.map(val => Math.pow(val - mean, 2));
            const variance = squaredDiffs.reduce((acc, val) => acc + val, 0) / validData.length;
            return Math.sqrt(variance);
        }
        function calculateSZValues(discountRates) {
            const avgPeriod = 249;
            const result = [];

            for (let i = avgPeriod + 1; i < discountRates.length; i++) {
                const windowData = discountRates.slice(i - avgPeriod - 1, i - 1);
                const mean = windowData.reduce((sum, val) => sum + (val ?? 0), 0) / windowData.length;

                let sumSquaredDiff = 0;
                for (let j = 0; j < windowData.length; j++) {
                    const val = windowData[j] ?? 0;
                    sumSquaredDiff += Math.pow(val - mean, 2);
                }
                const stdDev = Math.sqrt(sumSquaredDiff / windowData.length);

                const sz = stdDev !== 0 ? ((discountRates[i] ?? 0) - mean) / stdDev : 0;
                result.push({
                    index: i,
                    value: sz
                });
            }

            return result;
        }
        function calculateSZValue(discountRate) {
            if (stockData.history.stdDev === 0) return 0;
            return (discountRate - stockData.history.mean) / stockData.history.stdDev;
        }
        function updateCurrentInfo() {
            document.getElementById('current-common-price').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('current-preferred-price').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() + ' KRW' : 'N/A';
            const szElement = document.getElementById('current-sz-value');
            szElement.textContent = stockData.current.szValue.toFixed(2);
            szElement.classList.remove('sz-high', 'sz-medium', 'sz-low');
            if (stockData.current.szValue >= 2.5) {
                szElement.classList.add('sz-high');
            } else if (stockData.current.szValue >= 1.5) {
                szElement.classList.add('sz-medium');
            } else {
                szElement.classList.add('sz-low');
            }
            const discountElement = document.getElementById('current-discount-rate');
            const discountPercent = (stockData.current.discountRate * 100).toFixed(2);
            discountElement.textContent = discountPercent + '%';
            document.getElementById('common-base-price').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() : 'N/A';
            document.getElementById('preferred-base-price').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() : 'N/A';
            document.getElementById('common-price-adjusted').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('preferred-price-adjusted').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('common-price-slider').value = 0;
            document.getElementById('preferred-price-slider').value = 0;
            document.getElementById('common-price-percent').textContent = '0%';
            document.getElementById('preferred-price-percent').textContent = '0%';
        }

        function renderSZChart(dates, szValues, chartHeight, pointRadius) {
            const ctx = document.getElementById('sz-chart').getContext('2d');
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 640;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'SZ Value',
                            data: szValues.map(item => item.value),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            pointRadius: pointRadius,
                            tension: 0.1
                        },
                        {
                            label: 'SZ = 2.0 Threshold',
                            data: Array(dates.length).fill(2.0),
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: chartHeight,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `SZ Value: ${context.raw ? context.raw.toFixed(2) : 'N/A'}`;
                                }
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: 'Recent 5-month SZ Value Trend',
                            font: {
                                size: isMobile ? 12 : 16
                            }
                        }
                    },
                    elements: {
                        point: {
                            hitRadius: isMobile ? 10 : 5
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'SZ Value',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 5 : 10,
                                autoSkip: true,
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function setupSliderListeners() {
            const commonSlider = document.getElementById('common-price-slider');
            const commonPercent = document.getElementById('common-price-percent');
            const commonAdjusted = document.getElementById('common-price-adjusted');
            commonSlider.step = "0.1";
            commonSlider.addEventListener('input', function () {
                const percent = parseFloat(this.value);
                commonPercent.textContent = `${percent.toFixed(1)}%`;
                const adjusted = stockData.current.commonPrice * (1 + percent / 100);
                const roundedPrice = roundToTickSize(adjusted);
                commonAdjusted.textContent = roundedPrice.toLocaleString() + ' KRW';
                updateShareQuantities();
            });
            const preferredSlider = document.getElementById('preferred-price-slider');
            const preferredPercent = document.getElementById('preferred-price-percent');
            const preferredAdjusted = document.getElementById('preferred-price-adjusted');
            preferredSlider.step = "0.1";
            preferredSlider.addEventListener('input', function () {
                const percent = parseFloat(this.value);
                preferredPercent.textContent = `${percent.toFixed(1)}%`;
                const adjusted = stockData.current.preferredPrice * (1 + percent / 100);
                const roundedPrice = roundToTickSize(adjusted);
                preferredAdjusted.textContent = roundedPrice.toLocaleString() + ' KRW';
                updateShareQuantities();
            });
            document.getElementById('investment-amount').addEventListener('input', updateShareQuantities);
        }
        function roundToTickSize(price) {
            const tickSizes = [
                { max: 1000, step: 1 },
                { max: 5000, step: 5 },
                { max: 10000, step: 10 },
                { max: 50000, step: 50 },
                { max: 100000, step: 100 },
                { max: 500000, step: 500 },
                { step: 1000 }
            ];
            const tickRule = tickSizes.find(rule => !rule.max || price < rule.max);
            return Math.round(price / tickRule.step) * tickRule.step;
        }
        function calculateManualScenario() {
            const commonPct = parseFloat(document.getElementById('common-price-slider').value);
            const preferredPct = parseFloat(document.getElementById('preferred-price-slider').value);
            const adjustedCommon = roundToTickSize(stockData.current.commonPrice * (1 + commonPct / 100));
            const adjustedPreferred = roundToTickSize(stockData.current.preferredPrice * (1 + preferredPct / 100));
            const adjustedDiscountRate = (adjustedCommon - adjustedPreferred) / adjustedCommon;
            const adjustedSZValue = calculateSZValue(adjustedDiscountRate);
            const investmentInput = parseFloat(document.getElementById('investment-amount').value) || 0;
            const investmentAmount = investmentInput * 1000000;
            const commonShareQuantity = investmentAmount && adjustedCommon ? Math.floor(investmentAmount / adjustedCommon) : 0;
            const preferredShareQuantity = investmentAmount && adjustedPreferred ? Math.floor(investmentAmount / adjustedPreferred) : 0;
            const discountRateEl = document.getElementById('adjusted-discount-rate');
            discountRateEl.textContent = (adjustedDiscountRate * 100).toFixed(2) + '%';
            const szValueEl = document.getElementById('adjusted-sz-value');
            szValueEl.textContent = adjustedSZValue.toFixed(2);
            szValueEl.classList.remove('sz-high', 'sz-medium', 'sz-low');
            if (adjustedSZValue >= 2.5) {
                szValueEl.classList.add('sz-high');
            } else if (adjustedSZValue >= 1.5) {
                szValueEl.classList.add('sz-medium');
            } else {
                szValueEl.classList.add('sz-low');
            }
            document.getElementById('common-share-quantity').textContent = commonShareQuantity.toLocaleString() + ' 주';
            document.getElementById('preferred-share-quantity').textContent = preferredShareQuantity.toLocaleString() + ' 주';
            const interpretationEl = document.getElementById('scenario-interpretation');
            const commonChangeText = commonPct >= 0 ? '상승' : '하락';
            const preferredChangeText = preferredPct >= 0 ? '상승' : '하락';
            interpretationEl.innerHTML = `
                <p>
                    보통주가 ${Math.abs(commonPct)}% ${commonChangeText}하고,
                    우선주가 ${Math.abs(preferredPct)}% ${preferredChangeText}할 경우,
                </p>
                <p class="mt-1">
                    SZ 값은 <span class="${adjustedSZValue >= 2.5 ? 'sz-high' : adjustedSZValue >= 1.5 ? 'sz-medium' : 'sz-low'}">${adjustedSZValue.toFixed(2)}</span>가 됩니다.
                </p>
                <p class="mt-1 ${adjustedSZValue >= 2.0 ? 'text-red-600 font-medium' : ''}">
                    ${adjustedSZValue >= 2.0 ? 'SZ 값이 2.0 이상입니다!' : 'SZ 값이 2.0 미만입니다.'}
                </p>
                ${investmentAmount ? `
                    <p class="mt-2">
                        종목별 투입금 ${investmentAmount.toLocaleString()}원 기준,
                    </p>
                    <p class="mt-1">
                        보통주 ${commonShareQuantity.toLocaleString()}주, 우선주 ${preferredShareQuantity.toLocaleString()}주 가능합니다.
                    </p>
                ` : ''}
            `;
        }
        function updateShareQuantities() {
            const commonPct = parseFloat(document.getElementById('common-price-slider').value);
            const preferredPct = parseFloat(document.getElementById('preferred-price-slider').value);
            const investmentInput = parseFloat(document.getElementById('investment-amount').value) || 0;
            const investmentAmount = investmentInput * 1000000;
            const adjustedCommon = roundToTickSize(stockData.current.commonPrice * (1 + commonPct / 100));
            const adjustedPreferred = roundToTickSize(stockData.current.preferredPrice * (1 + preferredPct / 100));
            const commonShareQuantity = investmentAmount && adjustedCommon ? Math.floor(investmentAmount / adjustedCommon) : 0;
            const preferredShareQuantity = investmentAmount && adjustedPreferred ? Math.floor(investmentAmount / adjustedPreferred) : 0;
            document.getElementById('common-share-quantity').textContent = commonShareQuantity.toLocaleString() + ' 주';
            document.getElementById('preferred-share-quantity').textContent = preferredShareQuantity.toLocaleString() + ' 주';
        }
    </script>
</body>

</html>