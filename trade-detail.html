<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>Trend Detail - Scenario Analysis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .sz-high {
            color: #DC2626;
            font-weight: bold;
        }

        .sz-medium {
            color: #EA580C;
            font-weight: bold;
        }

        .sz-low {
            color: #16A34A;
        }

        .signal-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 4px;
        }

        .signal-R {
            background-color: #FEE2E2;
            color: #DC2626;
        }

        .signal-I {
            background-color: #E0F2FE;
            color: #0284C7;
        }

        .signal-O {
            background-color: #DCFCE7;
            color: #16A34A;
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 15px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .scenario-result {
            transition: all 0.3s;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Noto Sans KR", sans-serif;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ ê°œì„  */
        @media (max-width: 1024px) {
            .grid-cols-2 {
                grid-template-columns: repeat(1, 1fr) !important;
            }
        }

        @media (max-width: 640px) {
            .chart-container {
                height: 250px;
            }

            .slider {
                height: 12px;
            }

            .slider::-webkit-slider-thumb,
            .slider::-moz-range-thumb {
                width: 25px;
                height: 25px;
            }

            .flex.justify-between.items-center {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start !important;
            }

            .flex.space-x-2 {
                width: 100%;
                display: flex;
                justify-content: space-between;
                margin-top: 0.5rem;
            }

            .flex.space-x-2 a {
                flex: 1;
                text-align: center;
                margin-right: 0.25rem !important;
                margin-left: 0.25rem !important;
            }

            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .text-3xl {
                font-size: 1.5rem;
            }

            .text-xl,
            .text-lg {
                font-size: 1.2rem;
            }

            .text-sm {
                font-size: 0.75rem;
            }

            button,
            a.px-4 {
                padding: 0.75rem 1rem;
                min-height: 44px;
                font-size: 0.875rem;
            }

            .fa-home,
            .fa-arrow-left {
                font-size: 1rem;
            }

            #calculate-button {
                height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2" id="stock-name">Scenario Analysis</h1>
                <p class="text-sm text-gray-600">SZ 2.0 target: Price fluctuations</p>
                <!-- ì—…ë°ì´íŠ¸ ì •ë³´ ì¶”ê°€ -->
                <p class="text-xs text-gray-500 mt-1">Last Updated: <span id="last-updated-time">Loading...</span></p>
            </div>
            <div class="flex space-x-2">
                <a href="index.html"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-home mr-2"></i> Home
                </a>
                <a href="javascript:history.back()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loading-container" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4"></div>
            <p class="text-gray-600">Loading data...</p>
        </div>

        <!-- Content Container -->
        <div id="content-container" class="hidden">
            <!-- Current Stock Info Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Current stock information</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-blue-700 text-sm font-medium mb-1">ë³´í†µì£¼ ê°€ê²© [Short]</div>
                        <div class="text-xl font-bold" id="current-common-price">-</div>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg">
                        <div class="text-purple-700 text-sm font-medium mb-1">ìš°ì„ ì£¼ ê°€ê²© [Long]</div>
                        <div class="text-xl font-bold" id="current-preferred-price">-</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="text-green-700 text-sm font-medium mb-1">í˜„ì¬ SZ ê°’</div>
                        <div class="text-xl font-bold" id="current-sz-value">-</div>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <div class="text-yellow-700 text-sm font-medium mb-1">í˜„ì¬ ê´´ë¦¬ìœ¨</div>
                        <div class="text-xl font-bold" id="current-discount-rate">-</div>
                    </div>
                </div>
            </div>
            <!-- Scenario Tool -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Scenario Analysis Tool</h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Manual Scenario Controls -->
                    <div class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4"><strong class="text-xl">Price
                                Control</strong></h3>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ë³´í†µì£¼ [Short] â—€ ê°€ê²© ì¡°ì •
                                <span class="text-xs text-gray-500">(í˜„ì¬ ê°€ê²©: <span
                                        id="common-base-price">-</span>ì›)</span>
                            </label>
                            <div class="slider-wrapper">
                                <input type="range" id="common-price-slider" class="slider mb-2" min="-5" max="5"
                                    step="0.1" value="0">
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>-5%</span>
                                <span id="common-price-percent">0%</span>
                                <span>+5%</span>
                            </div>
                            <div class="mt-2 text-sm">
                                <span class="font-medium">ë³€ê²½ëœ ê°€ê²©:</span>
                                <span id="common-price-adjusted" class="font-bold text-blue-600">-</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ìš°ì„ ì£¼ [Long] â–¶ ê°€ê²© ì¡°ì •
                                <span class="text-xs text-gray-500">(í˜„ì¬ ê°€ê²©: <span
                                        id="preferred-base-price">-</span>ì›)</span>
                            </label>
                            <div class="slider-wrapper">
                                <input type="range" id="preferred-price-slider" class="slider mb-2" min="-5" max="5"
                                    step="0.1" value="0">
                            </div>
                            <div class="flex justify-between text-xs text-gray-500">
                                <span>-5%</span>
                                <span id="preferred-price-percent">0%</span>
                                <span>+5%</span>
                            </div>
                            <div class="mt-2 text-sm">
                                <span class="font-medium">ë³€ê²½ëœ ê°€ê²©:</span>
                                <span id="preferred-price-adjusted" class="font-bold text-blue-600">-</span>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-2 gap-2">
                            <button id="reset-sliders-button"
                                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                ì´ˆê¸°í™”
                            </button>
                            <button id="calculate-button"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                ê³„ì‚°í•˜ê¸°
                            </button>
                        </div>
                    </div>

                    <!-- Calculation Results -->
                    <div id="manual-result" class="bg-gray-50 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-800 mb-4"><strong class="text-xl">SZ Result</strong>
                        </h3>

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-gray-700 text-sm font-medium mb-1">ì¡°ì •ëœ ê´´ë¦¬ìœ¨</div>
                                <div class="text-xl font-bold" id="adjusted-discount-rate">-</div>
                            </div>
                            <div class="p-4 bg-white rounded-lg shadow">
                                <div class="text-gray-700 text-sm font-medium mb-1">ì¡°ì •ëœ SZ ê°’</div>
                                <div class="text-xl font-bold" id="adjusted-sz-value">-</div>
                            </div>
                        </div>

                        <div class="p-4 bg-white rounded-lg shadow mt-4">
                            <div class="text-gray-700 text-sm font-medium mb-2">Result Analysis</div>
                            <div id="scenario-interpretation" class="text-sm text-gray-800">
                                Adjust the price to calculate the scenario.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Historical SZ Value Chart -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">SZ value trend</h2>
                <div class="chart-container">
                    <canvas id="sz-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>Â© 2025 EQ Pair Monitoring System.</p>
        </div>
    </footer>
    <script>
        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ì„ ê°€ì ¸ì™€ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function fetchLastUpdateTime() {
            try {
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;

                const response = await fetch(stockDataUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch update time (${response.status})`);
                }

                const data = await response.json();

                // íƒ€ì„ìŠ¤íƒ¬í”„ ê°€ì ¸ì˜¤ê¸°
                const updateTime = data.timestamp || data.last_updated || new Date().toLocaleString();

                // í•œêµ­ì–´ ë‚ ì§œ í¬ë§·íŒ…
                let formattedDate;
                try {
                    const date = new Date(updateTime);
                    formattedDate = date.toLocaleString();
                } catch (e) {
                    formattedDate = updateTime; // ë³€í™˜ ì‹¤íŒ¨ì‹œ ì›ë³¸ ì‚¬ìš©
                }

                document.getElementById('last-updated-time').textContent = formattedDate;
            } catch (error) {
                console.error('ì—…ë°ì´íŠ¸ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                document.getElementById('last-updated-time').textContent = 'Unknown';
            }
        }
        // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” í•¨ìˆ˜
        function resetSliders() {
            // ìŠ¬ë¼ì´ë” ê°’ ì´ˆê¸°í™”
            document.getElementById('common-price-slider').value = 0;
            document.getElementById('preferred-price-slider').value = 0;

            // í¼ì„¼íŠ¸ í‘œì‹œ ì´ˆê¸°í™”
            document.getElementById('common-price-percent').textContent = '0%';
            document.getElementById('preferred-price-percent').textContent = '0%';

            // ì¡°ì •ëœ ê°€ê²© ì´ˆê¸°í™”
            document.getElementById('common-price-adjusted').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('preferred-price-adjusted').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() + ' KRW' : 'N/A';

            // ê²°ê³¼ ê°’ë„ ì´ˆê¸°í™”
            document.getElementById('adjusted-discount-rate').textContent = '-';
            document.getElementById('adjusted-sz-value').textContent = '-';
            document.getElementById('scenario-interpretation').textContent = 'ê°€ê²©ì„ ì¡°ì •í•˜ì—¬ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ê³„ì‚°í•˜ì„¸ìš”.';
        }


        // í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ê°œì„ 
        document.addEventListener('DOMContentLoaded', () => {
            // URLì—ì„œ ì¢…ëª© ì •ë³´ ì¶”ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            const stockCode = urlParams.get('code');
            let stockName = decodeURIComponent(urlParams.get('name') || '');

            // HTML íƒœê·¸ ì œê±°
            stockName = stockName.replace(/<\/?[^>]+(>|$)/g, "");

            if (!stockCode || !stockName) {
                alert('ì¢…ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }

            // í˜ì´ì§€ ì œëª© ì„¤ì •
            document.title = `${stockName} - Scenario Analysis`;
            document.getElementById('stock-name').textContent = stockName;

            // ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬
            loadAndProcessStockData(stockCode, stockName);

            // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            setupSliderListeners();

            // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.getElementById('reset-sliders-button').addEventListener('click', resetSliders);

            // ê³„ì‚° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            document.getElementById('calculate-button').addEventListener('click', calculateManualScenario);
        });

        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let stockData = {
            current: {
                commonPrice: 0,
                preferredPrice: 0,
                szValue: 0,
                discountRate: 0
            },
            history: {
                dates: [],
                szValues: [],
                discountRates: [],
                mean: 0,
                stdDev: 0
            }
        };

        // loadAndProcessStockData í•¨ìˆ˜ ê°œì„  - ì‹¤ì‹œê°„ ë°ì´í„° í™œìš©
        async function loadAndProcessStockData(stockCode, stockName) {
            console.log(`ë°ì´í„° ë¡œë“œ ì‹œì‘ - ì½”ë“œ: ${stockCode}, ì´ë¦„: ${stockName}`);
            try {
                // ë¡œë”© í‘œì‹œ
                document.getElementById('loading-container').style.display = 'flex';
                document.getElementById('content-container').classList.add('hidden');

                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
                fetchLastUpdateTime();

                // 1. íŠ¸ë Œë“œ ë°ì´í„° ë¡œë“œ
                const trendData = await loadStockData(stockCode, stockName);

                // 2. ì‹¤ì‹œê°„ ë°ì´í„° ë¡œë“œ - stock_data.jsonì—ì„œ í˜„ì¬ ì¢…ëª© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const realtimeData = await fetchRealtimeData(stockCode, stockName);

                // 3. ë‘ ë°ì´í„° í†µí•© ì²˜ë¦¬
                stockData.current = {
                    // ì‹¤ì‹œê°„ ë°ì´í„° ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ íŠ¸ë Œë“œ ë°ì´í„°ì˜ ë§ˆì§€ë§‰ ê°’ ì‚¬ìš©
                    commonPrice: realtimeData.commonPrice ||
                        (trendData.common_prices.length > 0 ? trendData.common_prices[trendData.common_prices.length - 1] : 0),
                    preferredPrice: realtimeData.preferredPrice ||
                        (trendData.preferred_prices.length > 0 ? trendData.preferred_prices[trendData.preferred_prices.length - 1] : 0),
                    szValue: realtimeData.szValue || 0,
                    signal: realtimeData.signal || ''
                };

                // 4. ê´´ë¦¬ìœ¨ ê³„ì‚°
                stockData.current.discountRate = calculateDiscountRate(
                    stockData.current.commonPrice,
                    stockData.current.preferredPrice
                );

                // 5. íˆìŠ¤í† ë¦¬ ë°ì´í„° ì²˜ë¦¬
                stockData.history.dates = trendData.dates.slice(-150); // ìµœê·¼ 5ê°œì›”ë§Œ
                stockData.history.discountRates = trendData.discount_rates.slice(-150);

                // 6. SZ ê°’ ê³„ì‚°ì„ ìœ„í•œ í†µê³„ ë°ì´í„°
                const windowData = trendData.discount_rates.slice(-250, -1); // ìµœê·¼ 250ì¼(ì•½ 1ë…„) ë°ì´í„°ë¡œ ê³„ì‚°
                stockData.history.mean = calculateMean(windowData);
                stockData.history.stdDev = calculateStdDev(windowData, stockData.history.mean);
                stockData.history.szValues = trendData.sz_values ? trendData.sz_values.slice(-150) :
                    calculateSZValues(trendData.discount_rates, stockData.history.mean, stockData.history.stdDev).slice(-150);

                // 7. UI ì—…ë°ì´íŠ¸
                updateCurrentInfo();
                renderSZChart();

                // 8. ë¡œë”© ì™„ë£Œ ì²˜ë¦¬
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('content-container').classList.remove('hidden');
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬ ì˜¤ë¥˜:', error);

                // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                const loadingContainer = document.getElementById('loading-container');
                loadingContainer.innerHTML = `
                <div class="text-red-500 text-center">
                    <p>ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p>${error.message}</p>
                    <button onclick="window.location.reload()" 
                            class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">
                        ë‹¤ì‹œ ì‹œë„
                    </button>
                    <button onclick="window.location.href='index.html'" 
                            class="mt-4 ml-2 px-4 py-2 bg-gray-500 text-white rounded">
                        ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            `;
            }
        }

        // ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
        async function fetchRealtimeData(stockCode, stockName) {
            try {
                // ê¸°ë³¸ URL ì„¤ì • (GitHub Pages í™˜ê²½ ê³ ë ¤)
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;

                // ìºì‹œ ë°©ì§€ ì˜µì…˜ìœ¼ë¡œ ë°ì´í„° ìš”ì²­
                const response = await fetch(stockDataUrl, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (!response.ok) {
                    throw new Error(`ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${response.status}`);
                }

                const data = await response.json();

                // ì¢…ëª©ëª… ì •ê·œí™” í•¨ìˆ˜
                const normalizeStockName = (name) => {
                    if (!name) return '';
                    // HTML íƒœê·¸ ì œê±°
                    let cleanName = name.replace(/<[^>]+>/g, '');
                    // ì´ëª¨ì§€ ì•„ì´ì½˜ ì œê±° (ğŸ”´ ğŸŸ  ğŸŸ¢ ğŸ”µ)
                    cleanName = cleanName.replace(/^[\u{1F534}\u{1F7E0}\u{1F7E2}\u{1F535}]\s+/u, '');
                    // ê°€ì¤‘ì¹˜ í˜•ì‹ ì œê±° (ì˜ˆ: -0.5- ë˜ëŠ” (0.5))
                    cleanName = cleanName.replace(/-\d+(\.\d+)?-$/, '').replace(/\s*\(\d+(\.\d+)?\)$/, '');
                    return cleanName.trim();
                };

                // í˜„ì¬ ì¢…ëª© ì •ê·œí™”
                const normalizedCurrentName = normalizeStockName(stockName);

                // ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ ì¼ì¹˜í•˜ëŠ” ì¢…ëª© ì°¾ê¸°
                let matchedSignal = null;

                // 1. ì •í™•í•œ ì´ë¦„ ì¼ì¹˜
                for (const signal of data.all_signals) {
                    const normalizedSignalName = normalizeStockName(signal.stock_name);
                    if (normalizedSignalName === normalizedCurrentName) {
                        matchedSignal = signal;
                        console.log("ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì¢…ëª© ë°œê²¬:", normalizedSignalName);
                        break;
                    }
                }

                // 2. ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰
                if (!matchedSignal) {
                    for (const signal of data.all_signals) {
                        const normalizedSignalName = normalizeStockName(signal.stock_name);
                        if (normalizedSignalName.includes(normalizedCurrentName) ||
                            normalizedCurrentName.includes(normalizedSignalName)) {
                            matchedSignal = signal;
                            console.log("ë¶€ë¶„ ì¼ì¹˜í•˜ëŠ” ì¢…ëª© ë°œê²¬:", normalizedSignalName);
                            break;
                        }
                    }
                }

                // 3. ì¢…ëª© ì½”ë“œë¡œ ê²€ìƒ‰
                if (!matchedSignal && stockCode !== 'unknown') {
                    for (const signal of data.all_signals) {
                        // ì¢…ëª© ì½”ë“œ ì¶”ì¶œ ì‹œë„
                        try {
                            const signalCode = getStockCodeByName(normalizeStockName(signal.stock_name));
                            if (signalCode === stockCode) {
                                matchedSignal = signal;
                                console.log("ì¢…ëª© ì½”ë“œë¡œ ì¼ì¹˜í•˜ëŠ” í•­ëª© ë°œê²¬:", signalCode);
                                break;
                            }
                        } catch (codeError) {
                            console.warn("ì¢…ëª© ì½”ë“œ ì¶”ì¶œ ì‹¤íŒ¨:", codeError);
                        }
                    }
                }

                // ì¼ì¹˜í•˜ëŠ” ì¢…ëª©ì´ ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´ ë°˜í™˜
                if (!matchedSignal) {
                    console.warn("ì¼ì¹˜í•˜ëŠ” ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:", stockName, stockCode);
                    return {};
                }

                // ê²°ê³¼ ë°˜í™˜
                return {
                    commonPrice: matchedSignal.price_a || null,
                    preferredPrice: matchedSignal.price_b || null,
                    szValue: matchedSignal.sz_value || 0,
                    signal: matchedSignal.signal || ''
                };

            } catch (error) {
                console.error('ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:', error);
                return {}; // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ê°ì²´ ë°˜í™˜
            }
        }

        // ê´´ë¦¬ìœ¨ ê³„ì‚° í•¨ìˆ˜
        function calculateDiscountRate(commonPrice, preferredPrice) {
            if (!commonPrice || !preferredPrice || commonPrice === 0) {
                return 0;
            }
            return (commonPrice - preferredPrice) / commonPrice;
        }

        async function loadStockData(stockCode, stockName) {
            const trendDataResponse = await fetch(`data/trends/${stockCode}.json?t=${new Date().getTime()}`);
            if (!trendDataResponse.ok) {
                throw new Error(`íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${stockName}`);
            }

            const trendDataText = await trendDataResponse.text();

            // JSON íŒŒì‹± ì „ì— "NaN" ë¬¸ìì—´ì„ nullë¡œ ëŒ€ì²´
            const cleanedTrendDataText = trendDataText
                .replace(/"NaN"/g, 'null')
                .replace(/NaN/g, 'null')
                .replace(/Infinity/g, 'null')
                .replace(/-Infinity/g, 'null');

            return JSON.parse(cleanedTrendDataText, (key, value) => {
                // íŒŒì‹± ì¤‘ì— íŠ¹ìˆ˜ê°’ ì²˜ë¦¬
                if (value === null || value === undefined ||
                    (typeof value === 'string' && (value === 'NaN' || value === 'Infinity' || value === '-Infinity'))) {
                    return null;
                }
                if (typeof value === 'number' && !isFinite(value)) {
                    return null;
                }
                return value;
            });
        }

        async function loadStockDataJson() {
            const response = await fetch(`data/stock_data.json?t=${new Date().getTime()}`);
            if (!response.ok) {
                throw new Error('ì‹ í˜¸ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            const dataText = await response.text();

            // íŠ¹ìˆ˜ê°’ ì²˜ë¦¬
            const cleanedDataText = dataText
                .replace(/"NaN"/g, 'null')
                .replace(/NaN/g, 'null')
                .replace(/Infinity/g, 'null')
                .replace(/-Infinity/g, 'null');

            return JSON.parse(cleanedDataText);
        }

        function calculateMean(data) {
            const validData = data.filter(val => val !== null && !isNaN(val));
            if (validData.length === 0) return 0;

            const sum = validData.reduce((acc, val) => acc + val, 0);
            return sum / validData.length;
        }

        function calculateStdDev(data, mean) {
            const validData = data.filter(val => val !== null && !isNaN(val));
            if (validData.length === 0) return 0;

            const squaredDiffs = validData.map(val => Math.pow(val - mean, 2));
            const variance = squaredDiffs.reduce((acc, val) => acc + val, 0) / validData.length;
            return Math.sqrt(variance);
        }

        function calculateSZValues(discountRates, mean, stdDev) {
            if (!discountRates || discountRates.length === 0) return [];

            return discountRates.map(rate => {
                if (rate === null || isNaN(rate)) return null;
                if (stdDev === 0) return 0;
                return (rate - mean) / stdDev;
            });
        }

        function calculateSZValue(discountRate) {
            if (stockData.history.stdDev === 0) return 0;
            return (discountRate - stockData.history.mean) / stockData.history.stdDev;
        }

        // updateCurrentInfo í•¨ìˆ˜ ê°œì„  - ì‹¤ì‹œê°„ ë°ì´í„° ë°˜ì˜
        function updateCurrentInfo() {
            // í˜„ì¬ ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸
            document.getElementById('current-common-price').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('current-preferred-price').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() + ' KRW' : 'N/A';

            // SZ ê°’ í‘œì‹œ
            const szElement = document.getElementById('current-sz-value');
            szElement.textContent = stockData.current.szValue.toFixed(2);

            // SZ ê°’ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
            szElement.classList.remove('sz-high', 'sz-medium', 'sz-low');
            if (stockData.current.szValue >= 2.5) {
                szElement.classList.add('sz-high');
            } else if (stockData.current.szValue >= 1.5) {
                szElement.classList.add('sz-medium');
            } else {
                szElement.classList.add('sz-low');
            }

            // ê´´ë¦¬ìœ¨ í‘œì‹œ (ë°±ë¶„ìœ¨ë¡œ ë³€í™˜)
            const discountElement = document.getElementById('current-discount-rate');
            const discountPercent = (stockData.current.discountRate * 100).toFixed(2);
            discountElement.textContent = discountPercent + '%';

            // ìŠ¬ë¼ì´ë” ê¸°ë³¸ ê°€ê²© ì—…ë°ì´íŠ¸
            document.getElementById('common-base-price').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() : 'N/A';
            document.getElementById('preferred-base-price').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() : 'N/A';

            // ì¡°ì •ëœ ê°€ê²© ì´ˆê¸°í™”
            document.getElementById('common-price-adjusted').textContent =
                stockData.current.commonPrice ? stockData.current.commonPrice.toLocaleString() + ' KRW' : 'N/A';
            document.getElementById('preferred-price-adjusted').textContent =
                stockData.current.preferredPrice ? stockData.current.preferredPrice.toLocaleString() + ' KRW' : 'N/A';

            // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™” (0% ìœ„ì¹˜ë¡œ)
            document.getElementById('common-price-slider').value = 0;
            document.getElementById('preferred-price-slider').value = 0;
            document.getElementById('common-price-percent').textContent = '0%';
            document.getElementById('preferred-price-percent').textContent = '0%';
        }

        function renderSZChart() {
            const ctx = document.getElementById('sz-chart').getContext('2d');
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 640;

            const chartHeight = isMobile ? 250 : 300;
            const pointRadius = isMobile ? 0 : 1;

            // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
            const chartLabels = stockData.history.dates;
            const chartValues = stockData.history.szValues;

            // ì°¨íŠ¸ ìƒì„±
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'SZ Value',
                        data: chartValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        pointRadius: pointRadius,
                        tension: 0.1
                    },
                    {
                        label: 'SZ = 2.0 Threshold',
                        data: Array(chartLabels.length).fill(2.0),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: chartHeight,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `SZ Value: ${context.raw ? context.raw.toFixed(2) : 'N/A'}`;
                                }
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: 'Recent 5-month SZ value trend',
                            font: {
                                size: isMobile ? 12 : 16
                            }
                        }
                    },
                    elements: {
                        point: {
                            hitRadius: isMobile ? 10 : 5
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'SZ Value',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 5 : 10,
                                autoSkip: true,
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function setupSliderListeners() {
            const commonSlider = document.getElementById('common-price-slider');
            const commonPercent = document.getElementById('common-price-percent');
            const commonAdjusted = document.getElementById('common-price-adjusted');

            // í˜¸ê°€ ë‹¨ìœ„ì— ë§ëŠ” ìŠ¤í… ì‚¬ì´ì¦ˆ ê³„ì‚° í•¨ìˆ˜ - ì´ í•¨ìˆ˜ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
            function calculateStepSize(price) {
                const tickSizes = [
                    { max: 1000, step: 1 },
                    { max: 5000, step: 5 },
                    { max: 10000, step: 10 },
                    { max: 50000, step: 50 },
                    { max: 100000, step: 100 },
                    { max: 500000, step: 500 },
                    { step: 1000 }
                ];

                const tickRule = tickSizes.find(rule => !rule.max || price < rule.max);
                return tickRule.step / price * 100; // í¼ì„¼íŠ¸ë¡œ í™˜ì‚°
            }

            // ìŠ¬ë¼ì´ë” ìŠ¤í… ê³ ì •ê°’ ì‚¬ìš© (0.1%)
            commonSlider.step = "0.1";

            // í•˜ì§€ë§Œ ê°€ê²© ê³„ì‚° ì‹œì—ëŠ” ì—¬ì „íˆ í˜¸ê°€ ë‹¨ìœ„ ì ìš©
            commonSlider.addEventListener('input', function () {
                const percent = parseFloat(this.value);
                commonPercent.textContent = `${percent.toFixed(1)}%`;

                const adjusted = stockData.current.commonPrice * (1 + percent / 100);
                // í˜¸ê°€ ë‹¨ìœ„ì— ë§ê²Œ ë°˜ì˜¬ë¦¼
                const roundedPrice = roundToTickSize(adjusted);
                commonAdjusted.textContent = roundedPrice.toLocaleString() + ' KRW';
            });

            // ìš°ì„ ì£¼ ìŠ¬ë¼ì´ë”ë„ ë™ì¼í•œ ë°©ì‹ ì ìš©
            const preferredSlider = document.getElementById('preferred-price-slider');
            const preferredPercent = document.getElementById('preferred-price-percent');
            const preferredAdjusted = document.getElementById('preferred-price-adjusted');

            // ìŠ¬ë¼ì´ë” ìŠ¤í… ê³ ì •ê°’ ì‚¬ìš© (0.1%)
            preferredSlider.step = "0.1";

            preferredSlider.addEventListener('input', function () {
                const percent = parseFloat(this.value);
                preferredPercent.textContent = `${percent.toFixed(1)}%`;

                const adjusted = stockData.current.preferredPrice * (1 + percent / 100);
                // í˜¸ê°€ ë‹¨ìœ„ì— ë§ê²Œ ë°˜ì˜¬ë¦¼
                const roundedPrice = roundToTickSize(adjusted);
                preferredAdjusted.textContent = roundedPrice.toLocaleString() + ' KRW';
            });
        }
        // ì£¼ê°€ í˜¸ê°€ ë‹¨ìœ„ì— ë§ê²Œ ë°˜ì˜¬ë¦¼í•˜ëŠ” í•¨ìˆ˜
        function roundToTickSize(price) {
            // ì£¼ê°€ ë²”ìœ„ë³„ í˜¸ê°€ ë‹¨ìœ„ ì •ì˜
            const tickSizes = [
                { max: 1000, step: 1 },     // 1000ì› ë¯¸ë§Œ: 1ì› ë‹¨ìœ„
                { max: 5000, step: 5 },     // 5000ì› ë¯¸ë§Œ: 5ì› ë‹¨ìœ„
                { max: 10000, step: 10 },   // 10000ì› ë¯¸ë§Œ: 10ì› ë‹¨ìœ„
                { max: 50000, step: 50 },   // 50000ì› ë¯¸ë§Œ: 50ì› ë‹¨ìœ„
                { max: 100000, step: 100 }, // 100000ì› ë¯¸ë§Œ: 100ì› ë‹¨ìœ„
                { max: 500000, step: 500 }, // 500000ì› ë¯¸ë§Œ: 500ì› ë‹¨ìœ„
                { step: 1000 }               // ê·¸ ì´ìƒ: 1000ì› ë‹¨ìœ„
            ];

            // ì ì ˆí•œ í˜¸ê°€ ë‹¨ìœ„ ì°¾ê¸°
            const tickRule = tickSizes.find(rule => !rule.max || price < rule.max);

            // í•´ë‹¹ ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼
            return Math.round(price / tickRule.step) * tickRule.step;
        }
        function calculateManualScenario() {
            // ìŠ¬ë¼ì´ë”ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
            const commonPct = parseFloat(document.getElementById('common-price-slider').value);
            const preferredPct = parseFloat(document.getElementById('preferred-price-slider').value);

            // ì¡°ì •ëœ ê°€ê²© ê³„ì‚° (í˜¸ê°€ ë‹¨ìœ„ì— ë§ê²Œ ë°˜ì˜¬ë¦¼)
            const adjustedCommon = roundToTickSize(stockData.current.commonPrice * (1 + commonPct / 100));
            const adjustedPreferred = roundToTickSize(stockData.current.preferredPrice * (1 + preferredPct / 100));

            // ì¡°ì •ëœ ê´´ë¦¬ìœ¨ ê³„ì‚°
            const adjustedDiscountRate = (adjustedCommon - adjustedPreferred) / adjustedCommon;

            // ì¡°ì •ëœ SZ ê°’ ê³„ì‚°
            const adjustedSZValue = calculateSZValue(adjustedDiscountRate);

            // UI ì—…ë°ì´íŠ¸
            const discountRateEl = document.getElementById('adjusted-discount-rate');
            discountRateEl.textContent = (adjustedDiscountRate * 100).toFixed(2) + '%';

            const szValueEl = document.getElementById('adjusted-sz-value');
            szValueEl.textContent = adjustedSZValue.toFixed(2);

            // SZ ê°’ì— ë”°ë¥¸ ìƒ‰ìƒ ì ìš©
            szValueEl.classList.remove('sz-high', 'sz-medium', 'sz-low');
            if (adjustedSZValue >= 2.5) {
                szValueEl.classList.add('sz-high');
            } else if (adjustedSZValue >= 1.5) {
                szValueEl.classList.add('sz-medium');
            } else {
                szValueEl.classList.add('sz-low');
            }

            // ì‹œë‚˜ë¦¬ì˜¤ í•´ì„ ì—…ë°ì´íŠ¸
            const interpretationEl = document.getElementById('scenario-interpretation');

            // ê°€ê²© ë³€ë™ ë°©í–¥ í…ìŠ¤íŠ¸
            const commonChangeText = commonPct >= 0 ? 'ìƒìŠ¹' : 'í•˜ë½';
            const preferredChangeText = preferredPct >= 0 ? 'ìƒìŠ¹' : 'í•˜ë½';

            interpretationEl.innerHTML = `
                <p>
                    ë³´í†µì£¼ê°€ ${Math.abs(commonPct)}% ${commonChangeText}í•˜ê³ ,
                    ìš°ì„ ì£¼ê°€ ${Math.abs(preferredPct)}% ${preferredChangeText}í•  ê²½ìš°,
                </p>
                <p class="mt-1">
                    SZ ê°’ì€ <span class="${adjustedSZValue >= 2.5 ? 'sz-high' : adjustedSZValue >= 1.5 ? 'sz-medium' : 'sz-low'}">${adjustedSZValue.toFixed(2)}</span>ê°€ ë©ë‹ˆë‹¤.
                </p>
                <p class="mt-1 ${adjustedSZValue >= 2.0 ? 'text-red-600 font-medium' : ''}">
                    ${adjustedSZValue >= 2.0 ? 'SZ ê°’ì´ 2.0 ì´ìƒì…ë‹ˆë‹¤!' : 'SZ ê°’ì´ 2.0 ë¯¸ë§Œì…ë‹ˆë‹¤.'}
                </p>
            `;
        }        
    </script>
</body>

</html>