<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> --> <!-- 호환성 문제로 주석 처리 -->
    <title>Stock Details - EQ Pairs Monitoring System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .signal-card {
            transition: all 0.3s ease;
        }
        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .blink {
            animation: blink 2s linear infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.875rem;
        }
        thead {
            background: #f9fafb;
        }
        th {
            font-weight: 500;
            text-transform: uppercase;
            color: #6b7280;
        }
        tbody {
            background: #fff;
        }
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        @media (max-width: 1024px) {
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-2 { grid-template-columns: repeat(1, 1fr); }
        }
        @media (max-width: 640px) {
            th, td {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            .text-3xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.2rem; }
            button, a { min-height: 44px; padding: 0.75rem 1rem; font-size: 0.875rem; }
            .flex.justify-between.items-center { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Noto Sans KR', sans-serif;">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2" id="stock-name">Stock Details</h1>
                <p class="text-sm text-gray-600">Recent 5 month trend overview</p>
                <p class="text-xs text-gray-500 mt-1">Last Updated: <span id="last-updated-time">Loading...</span></p>
            </div>
            <div class="flex space-x-2">
                <a href="#" id="trade-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i> Marketability
                </a>
                <a href="index.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </header>

        <div id="loading-container" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4 blink"></div>
            <p class="text-gray-600">Loading data...</p>
        </div>

        <div id="content-container" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Current stock information</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <div class="text-blue-700 text-sm font-medium mb-1">보통주 가격 [Short]</div>
                    <div class="text-xl font-bold" id="common-price">-</div>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <div class="text-purple-700 text-sm font-medium mb-1">우선주 가격 [Long]</div>
                    <div class="text-xl font-bold" id="preferred-price">-</div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <div class="text-green-700 text-sm font-medium mb-1">현재 SZ 값</div>
                    <div class="text-xl font-bold" id="sz-value">-</div>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg">
                    <div class="text-yellow-700 text-sm font-medium mb-1">현재 시그널</div>
                    <div class="text-xl font-bold" id="current-signal">-</div>
                </div>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">SZ Value Trend</h2>
            <div class="chart-container h-96 md:h-80 sm:h-64" style="position: relative;">
                <!-- 차트 콘텐츠 (예: Canvas 또는 Chart.js) -->
                <canvas id="sz-chart"></canvas>
            </div>
        </div>

        <!-- Price Trend Chart -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Price Trend</h2>
            <div class="chart-container h-96 md:h-80 sm:h-64" style="position: relative;">
                <canvas id="price-chart"></canvas>
            </div>
        </div>

        <!-- History Signals Table -->
        <div class="bg-white rounded-lg shadow-md p-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">SZ History</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>SZ Value</th>
                            <th>Trend</th>
                            <th>Common Stock Price</th>
                            <th>Preferred Stock Price</th>
                        </tr>
                    </thead>
                    <tbody id="signals-table-body">
                        <tr>
                            <td>Loading history data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <footer class="bg-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>© 2025 EQ Pair Monitoring System.</p>
        </div>
    </footer>

    <script>
        // 종목 코드를 이름으로부터 추출하는 함수 (간단히 구현)
        function getStockCodeByName(stockName) {
            // 실제 구현에서는 종목 이름과 코드 매핑 데이터 필요
            // 여기서는 더미 코드 반환
            return stockName ? stockName.toLowerCase().replace(/\s/g, '-') : 'unknown';
        }
        // 마지막 업데이트 시간을 가져와 표시하는 함수
        async function fetchLastUpdateTime() {
            try {
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;

                const response = await fetch(stockDataUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch update time (${response.status})`);
                }

                const data = await response.json();

                // 타임스탬프 가져오기
                const updateTime = data.timestamp || data.last_updated || new Date().toLocaleString();

                // 한국어 날짜 포맷팅
                let formattedDate;
                try {
                    const date = new Date(updateTime);
                    formattedDate = date.toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    formattedDate = updateTime; // 변환 실패시 원본 사용
                }

                document.getElementById('last-updated-time').textContent = formattedDate;
            } catch (error) {
                console.error('업데이트 시간 가져오기 실패:', error);
                document.getElementById('last-updated-time').textContent = 'Unknown';
            }
        }
        // HTML 태그 제거 함수
        function stripHtmlTags(html) {
            if (!html) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        // 페이지 로드 이벤트
        document.addEventListener('DOMContentLoaded', () => {
            // URL에서 종목 정보 추출
            const urlParams = new URLSearchParams(window.location.search);
            const stockCode = urlParams.get('code');
            let stockName = decodeURIComponent(urlParams.get('name') || '');
            // HTML 태그 제거
            stockName = stockName.replace(/<\/?[^>]+(>|$)/g, "");

            if (!stockCode || !stockName) {
                alert('종목 정보가 없습니다. 메인 페이지로 이동합니다.');
                window.location.href = 'index.html';
                return;
            }

            // 페이지 제목 설정
            document.title = `${stockName} - Stock Details`;
            document.getElementById('stock-name').textContent = stockName;

            // 데이터 로드 및 처리
            loadAndProcessStockData(stockCode, stockName);
        });

        // loadAndProcessStockData 함수 수정
        async function loadAndProcessStockData(stockCode, stockName) {
            console.log(`데이터 로드 시작 - 코드: ${stockCode}, 이름: ${stockName}`);
            try {
                // 로딩 표시
                document.getElementById('loading-container').style.display = 'flex';
                document.getElementById('content-container').classList.add('hidden');
                // 마지막 업데이트 시간 가져오기
                fetchLastUpdateTime();

                // Marketability 버튼 링크 설정
                document.getElementById('trade-button').href = `trade-detail.html?code=${stockCode}&name=${encodeURIComponent(stockName)}`;
                console.log("Trade button href updated:", document.getElementById('trade-button').href);

                // 트렌드 데이터 로드
                const trendData = await loadStockData(stockCode, stockName);

                // 현재 정보 업데이트 - 실시간 데이터 가져오기
                const currentInfo = await updateCurrentInfo(trendData, stockName, stockCode);

                // 차트 렌더링
                renderCharts(trendData);

                // 히스토리 데이터 렌더링
                renderHistoryData(trendData);

                // 로딩 컨테이너 숨기기, 콘텐츠 표시
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('content-container').classList.remove('hidden');
            } catch (error) {
                console.error('데이터 로드 및 처리 오류:', error);
                // 오류 메시지 표시
                document.getElementById('loading-container').innerHTML = `
                <div class="text-red-500 text-center">
                    <p>데이터를 로드할 수 없습니다.</p>
                    <p>${error.message}</p>
                    <div class="mt-4 flex justify-center space-x-4">
                        <button onclick="window.location.reload()" class="px-4 py-2 bg-blue-500 text-white rounded">다시 시도</button>
                        <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-500 text-white rounded">메인 페이지로 돌아가기</button>
                    </div>
                </div>
            `;
            }
        }

        // loadStockData 함수 수정
        async function loadStockData(stockCode, stockName) {
            try {
                // 기본 URL 설정 (GitHub Pages 환경 고려)
                const baseUrl = window.location.hostname.includes('github.io')
                    ? '/stmon'
                    : '';

                // 데이터 요청 URL
                const trendDataUrl = `${baseUrl}/data/trends/${stockCode}.json?t=${new Date().getTime()}`;
                console.log(`데이터 요청 URL: ${trendDataUrl}`);

                const trendDataResponse = await fetch(trendDataUrl);
                if (!trendDataResponse.ok) {
                    console.error(`트렌드 데이터 요청 실패: ${trendDataResponse.status}`);
                    throw new Error(`트렌드 데이터를 로드할 수 없습니다: ${stockName} (${trendDataResponse.status})`);
                }

                const trendDataText = await trendDataResponse.text();
                console.log(`응답 데이터 샘플: ${trendDataText.substring(0, 100)}...`);

                // JSON 파싱 전에 "NaN" 문자열을 null로 대체
                const cleanedTrendDataText = trendDataText
                    .replace(/"NaN"/g, 'null')
                    .replace(/NaN/g, 'null')
                    .replace(/Infinity/g, 'null')
                    .replace(/-Infinity/g, 'null');

                // 안전한 JSON 파싱
                try {
                    return JSON.parse(cleanedTrendDataText, (key, value) => {
                        // 파싱 중에 특수값 처리
                        if (value === null || value === undefined ||
                            (typeof value === 'string' && (value === 'NaN' || value === 'Infinity' || value === '-Infinity'))) {
                            return null;
                        }
                        if (typeof value === 'number' && !isFinite(value)) {
                            return null;
                        }
                        return value;
                    });
                } catch (parseError) {
                    console.error('트렌드 데이터 JSON 파싱 오류:', parseError);
                    throw new Error(`JSON 파싱 중 오류 발생: ${parseError.message}`);
                }
            } catch (error) {
                console.error('데이터 로드 중 전체 오류:', error);
                throw error;
            }
        }

        // 현재 종목 정보 업데이트 함수 수정 - 실시간 데이터를 가져오는 부분 개선
        async function updateCurrentInfo(trendData, stockName, stockCode) {
            try {
                // 1. 실시간 데이터 가져오기 (stock_data.json)
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;

                const response = await fetch(stockDataUrl, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (!response.ok) {
                    throw new Error(`실시간 데이터를 가져올 수 없습니다 (${response.status})`);
                }

                const stockData = await response.json();

                // 2. 실시간 API를 통해 현재 가격 가져오기 시도
                let realTimeData = null;
                try {
                    // 이 부분을 네이버 금융 API 대신 기존 데이터를 사용
                    // 네이버 금융 API는 CORS 제한이 있을 수 있음
                    realTimeData = await fetchLatestPrices(stockCode);
                } catch (rtError) {
                    console.warn('실시간 가격 데이터를 가져오는데 실패했습니다:', rtError);
                    // 실패 시 트렌드 데이터에서 마지막 가격 사용 (폴백)
                    const lastIndex = trendData.dates.length - 1;
                    realTimeData = {
                        commonPrice: trendData.common_prices[lastIndex],
                        preferredPrice: trendData.preferred_prices[lastIndex]
                    };
                }

                // 3. 종목명 정규화 함수 - HTML 태그, 아이콘, 가중치 정보 모두 제거
                const normalizeStockName = (name) => {
                    // HTML 태그 제거
                    let cleanName = name.replace(/<[^>]+>/g, '');
                    // 이모지 아이콘 제거 (🔴 🟠 🟢 🔵)
                    cleanName = cleanName.replace(/^[\u{1F534}\u{1F7E0}\u{1F7E2}\u{1F535}]\s+/u, '');
                    // 가중치 형식 제거 (예: -0.5- 또는 (0.5))
                    cleanName = cleanName.replace(/-\d+(\.\d+)?-$/, '').replace(/\s*\(\d+(\.\d+)?\)$/, '');
                    return cleanName.trim();
                };

                // 4. 현재 종목에 대한 정규화된 이름
                const normalizedCurrentName = normalizeStockName(stockName);
                console.log("정규화된 현재 종목명:", normalizedCurrentName);

                // 5. 일치하는 종목 찾기 - 다양한 방식으로 시도
                let matchedSignal = null;

                // 5.1 정규화된 이름으로 정확히 일치하는 항목 찾기
                for (const signal of stockData.all_signals) {
                    const normalizedSignalName = normalizeStockName(signal.stock_name);
                    if (normalizedSignalName === normalizedCurrentName) {
                        matchedSignal = signal;
                        console.log("정확히 일치하는 종목 발견:", normalizedSignalName);
                        break;
                    }
                }

                // 5.2 포함 관계로 찾기
                if (!matchedSignal) {
                    for (const signal of stockData.all_signals) {
                        const normalizedSignalName = normalizeStockName(signal.stock_name);
                        if (normalizedSignalName.includes(normalizedCurrentName) ||
                            normalizedCurrentName.includes(normalizedSignalName)) {
                            matchedSignal = signal;
                            console.log("부분 일치하는 종목 발견:", normalizedSignalName);
                            break;
                        }
                    }
                }

                // 5.3 종목 코드로 검색 (마지막 시도)
                if (!matchedSignal && stockCode !== 'unknown') {
                    for (const signal of stockData.all_signals) {
                        const signalCode = getStockCodeByName(normalizeStockName(signal.stock_name));
                        if (signalCode === stockCode) {
                            matchedSignal = signal;
                            console.log("종목 코드로 일치하는 항목 발견:", signalCode);
                            break;
                        }
                    }
                }

                // 6. SZ 값과 신호 정보 가져오기
                let szValue = 0;
                let signalText = '';

                if (matchedSignal) {
                    szValue = matchedSignal.sz_value || 0;
                    signalText = matchedSignal.signal || '';
                    console.log("매칭된 신호 정보:", { szValue, signalText });

                    // 6.1 최신 가격 정보가 없는 경우에만 매칭된 신호에서 가격 정보 가져오기
                    if (!realTimeData.commonPrice && matchedSignal.price_a) {
                        realTimeData.commonPrice = matchedSignal.price_a;
                    }
                    if (!realTimeData.preferredPrice && matchedSignal.price_b) {
                        realTimeData.preferredPrice = matchedSignal.price_b;
                    }
                } else {
                    console.warn("일치하는 종목을 찾을 수 없음:", stockName, stockCode);
                }

                // 7. 가격 정보 업데이트 - 실시간 데이터 우선 사용
                document.getElementById('common-price').textContent =
                    (realTimeData.commonPrice !== null && realTimeData.commonPrice !== undefined)
                        ? realTimeData.commonPrice.toLocaleString() + ' KRW'
                        : 'N/A';

                document.getElementById('preferred-price').textContent =
                    (realTimeData.preferredPrice !== null && realTimeData.preferredPrice !== undefined)
                        ? realTimeData.preferredPrice.toLocaleString() + ' KRW'
                        : 'N/A';

                // 8. SZ 값 표시
                const szElement = document.getElementById('sz-value');
                szElement.textContent = szValue.toFixed(2);

                // 9. SZ 값에 따른 색상 변경
                szElement.classList.remove('sz-high', 'sz-medium', 'sz-low');
                if (szValue >= 2.5) {
                    szElement.classList.add('sz-high');
                } else if (szValue >= 1.5) {
                    szElement.classList.add('sz-medium');
                } else {
                    szElement.classList.add('sz-low');
                }

                // 10. 신호 표시
                const signalElement = document.getElementById('current-signal');
                let signalHtml = '';

                if (signalText) {
                    if (signalText.includes('R')) {
                        signalHtml += '<span class="signal-tag signal-R">R</span>';
                    }
                    if (signalText.includes('I')) {
                        signalHtml += '<span class="signal-tag signal-I">I</span>';
                    }
                    if (signalText.includes('O')) {
                        signalHtml += '<span class="signal-tag signal-O">O</span>';
                    }
                }

                signalElement.innerHTML = signalHtml || 'N/A';

                return {
                    commonPrice: realTimeData.commonPrice,
                    preferredPrice: realTimeData.preferredPrice,
                    szValue: szValue,
                    signal: signalText
                };

            } catch (error) {
                console.error('현재 정보 업데이트 중 오류:', error);
                document.getElementById('common-price').textContent = 'N/A';
                document.getElementById('preferred-price').textContent = 'N/A';
                document.getElementById('sz-value').textContent = '0.00';
                document.getElementById('current-signal').textContent = 'N/A';
                return null;
            }
        }

        // 최신 가격 데이터를 가져오는 함수 추가
        async function fetchLatestPrices(stockCode) {
            try {
                // 1. 기본 stock_data.json에서 price_a와 price_b 정보 가져오기
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const response = await fetch(`${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`, {
                    cache: 'no-store'
                });

                if (!response.ok) {
                    throw new Error(`데이터를 가져올 수 없습니다: ${response.status}`);
                }

                const data = await response.json();

                // 2. 종목 코드로 매칭되는 항목 찾기
                let matchedItem = null;
                for (const signal of data.all_signals) {
                    // 코드 매핑 함수를 사용하여 종목 코드 찾기
                    const signalCode = getStockCodeByName(signal.stock_name);
                    if (signalCode === stockCode) {
                        matchedItem = signal;
                        break;
                    }
                }

                // 3. 결과 반환
                if (matchedItem && matchedItem.price_a && matchedItem.price_b) {
                    console.log("최신 가격 데이터 발견:", {
                        commonPrice: matchedItem.price_a,
                        preferredPrice: matchedItem.price_b
                    });
                    return {
                        commonPrice: matchedItem.price_a,
                        preferredPrice: matchedItem.price_b
                    };
                }

                // 4. 일치하는 항목이 없으면 null 반환
                throw new Error("일치하는 가격 데이터를 찾을 수 없음");

            } catch (error) {
                console.warn("최신 가격 데이터 가져오기 실패:", error);
                throw error;
            }
        }

        // 차트 렌더링 함수 (5개월 데이터로 제한)
        function renderCharts(trendData) {
            try {
                // 화면 크기 감지
                const screenWidth = window.innerWidth;
                const isMobile = screenWidth <= 640;

                // 차트 높이와 포인트 크기 동적 조정
                const chartHeight = isMobile ? 250 : 300;
                const pointRadius = isMobile ? 0 : 1;

                // 최근 데이터 슬라이스 (5개월 데이터)
                const recentDates = trendData.dates.slice(-150);
                const recentCommonPrices = trendData.common_prices.slice(-150);
                const recentPreferredPrices = trendData.preferred_prices.slice(-150);

                // 데이터 유효성 검사
                if (!recentDates.length || !recentCommonPrices.length || !recentPreferredPrices.length) {
                    throw new Error('차트 렌더링을 위한 데이터가 부족합니다.');
                }

                // SZ 값 차트 렌더링
                renderSZChart(trendData.dates, trendData.discount_rates, chartHeight, pointRadius);

                // 가격 차트 렌더링
                renderPriceChart(recentDates, recentCommonPrices, recentPreferredPrices, chartHeight, pointRadius);

                // 디버깅 정보 출력
                console.log('데이터 로드 성공! 데이터 크기:', {
                    '전체 데이터 길이': trendData.dates.length,
                    '최근 5개월 길이': recentDates.length,
                    '최초 날짜': trendData.dates[0],
                    '최근 날짜': trendData.dates[trendData.dates.length - 1]
                });
            } catch (error) {
                console.error('차트 렌더링 오류:', error);
                document.getElementById('sz-chart').parentElement.innerHTML = '<p class="text-red-500 text-center">차트 데이터를 로드할 수 없습니다.</p>';
                document.getElementById('price-chart').parentElement.innerHTML = '<p class="text-red-500 text-center">차트 데이터를 로드할 수 없습니다.</p>';
            }
        }

        // SZ 값 계산 함수 - 개선된 버전
        function calculateSZValues(discountRates) {
            const avgPeriod = 249;
            const result = [];

            for (let i = avgPeriod + 1; i < discountRates.length; i++) {
                // 이전 기간 데이터 (1일 시프트 적용)
                const windowData = discountRates.slice(i - avgPeriod - 1, i - 1);

                // 평균 계산
                const mean = windowData.reduce((sum, val) => sum + (val ?? 0), 0) / windowData.length;

                // 표준편차 계산
                let sumSquaredDiff = 0;
                for (let j = 0; j < windowData.length; j++) {
                    const val = windowData[j] ?? 0;
                    sumSquaredDiff += Math.pow(val - mean, 2);
                }
                const stdDev = Math.sqrt(sumSquaredDiff / windowData.length);

                // SZ 값 계산
                const sz = stdDev !== 0 ? ((discountRates[i] ?? 0) - mean) / stdDev : 0;

                result.push({
                    index: i,
                    value: sz
                });
            }

            return result;
        }

        function processSignals(signals) {
            return signals.map(signal => {
                const processedSignal = { ...signal };
                let newSignal = '';

                // R 신호 (SZ 값이 2.0 이상)
                if (signal.sz_value >= 2.0) {
                    newSignal += 'R';
                }

                // I 신호 (SZ 값이 1.5 이상이고 2.5 미만)
                if (signal.sz_value >= 1.5 && signal.sz_value < 2.5) {
                    newSignal += 'I';
                }

                // O 신호 (SZ 값이 0.5 미만)
                if (signal.sz_value < 0.5) {
                    newSignal += 'O';
                }

                // 새로 계산된 신호 할당
                processedSignal.signal = newSignal;
                return processedSignal;
            });
        }

        // SZ 차트 렌더링 함수 수정
        function renderSZChart(dates, discountRates, chartHeight, pointRadius) {
            const ctx = document.getElementById('sz-chart').getContext('2d');
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 640;

            // 기존 SZ 값 계산 로직 유지
            const calculatedSZ = calculateSZValues(discountRates);
            const fiveMonthsInDays = 150;
            const startIndex = Math.max(0, discountRates.length - fiveMonthsInDays);
            const recentSZ = calculatedSZ.filter(item => item.index >= startIndex);

            const chartLabels = [];
            const chartValues = [];

            for (const sz of recentSZ) {
                if (sz.index < dates.length) {
                    chartLabels.push(dates[sz.index]);
                    chartValues.push(sz.value);
                }
            }

            // 기존 차트 제거
            if (window.szChart) {
                window.szChart.destroy();
            }

            // 새 차트 생성 (모바일 최적화 옵션 추가)
            window.szChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'SZ Value',
                        data: chartValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        pointRadius: pointRadius,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: chartHeight,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `SZ Value: ${context.raw.toFixed(2)}`;
                                }
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: '5 Month SZ Value Trend',
                            font: {
                                size: isMobile ? 12 : 16
                            }
                        }
                    },
                    elements: {
                        point: {
                            hitRadius: isMobile ? 10 : 5
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'SZ Value',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 5 : 10,
                                autoSkip: true,
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // 가격 차트 렌더링 함수도 유사하게 수정
        function renderPriceChart(dates, commonPrices, preferredPrices, chartHeight, pointRadius) {
            const ctx = document.getElementById('price-chart').getContext('2d');
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 640;

            // 기존 차트 생성 로직 유지하되, 모바일 최적화 옵션 추가
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Common Stock Price',
                            data: commonPrices.map(val => val ?? 0),
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            pointRadius: pointRadius,
                            tension: 0.2
                        },
                        {
                            label: 'Preferred Stock Price',
                            data: preferredPrices.map(val => val ?? 0),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointRadius: pointRadius,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: chartHeight,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw.toLocaleString()} KRW`;
                                }
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: '5 Month Price Trend',
                            font: {
                                size: isMobile ? 12 : 16
                            }
                        }
                    },
                    elements: {
                        point: {
                            hitRadius: isMobile ? 10 : 5
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Price (KRW)',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                },
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 5 : 10,
                                autoSkip: true,
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // 히스토리 데이터 렌더링 - 5개월 제한 적용 (완전히 개선된 버전)
        function renderHistoryData(trendData) {
            try {
                const tableBody = document.getElementById('signals-table-body');
                const fiveMonthsInDays = 150;
                const startIndex = Math.max(0, trendData.dates.length - fiveMonthsInDays);
                const displayDates = [];
                for (let i = trendData.dates.length - 1; i >= startIndex; i -= 1) {
                    displayDates.push(i);
                }

                if (!trendData || !trendData.dates || trendData.dates.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">이 종목에 대한 히스토리 데이터가 없습니다.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';

                const calculatedSZ = calculateSZValues(trendData.discount_rates);
                const szValueMap = {};
                calculatedSZ.forEach(item => {
                    szValueMap[item.index] = item.value ?? 0; // null을 0으로 대체
                });

                for (const i of displayDates) {
                    const row = document.createElement('tr');
                    const date = trendData.dates[i];
                    const szValue = szValueMap[i] ?? 0; // null을 0으로 대체

                    if (szValue === undefined) continue;

                    let szClass = 'text-green-600';
                    if (szValue >= 2.5) {
                        szClass = 'text-red-600 font-bold';
                    } else if (szValue >= 1.5) {
                        szClass = 'text-orange-600 font-bold';
                    }

                    let trendIcon = '-';
                    if (displayDates.indexOf(i) < displayDates.length - 1) {
                        const prevIndex = displayDates[displayDates.indexOf(i) + 1];
                        const prevSZ = szValueMap[prevIndex] ?? 0; // null을 0으로 대체

                        if (szValue > prevSZ) {
                            trendIcon = '<i class="fas fa-arrow-up text-red-500"></i>';
                        } else if (szValue < prevSZ) {
                            trendIcon = '<i class="fas fa-arrow-down text-green-500"></i>';
                        } else {
                            trendIcon = '<i class="fas fa-minus text-gray-500"></i>';
                        }
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${szClass}">${szValue.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${trendIcon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(trendData.common_prices[i] ?? 0).toLocaleString()} KRW</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(trendData.preferred_prices[i] ?? 0).toLocaleString()} KRW</td>
                    `;

                    tableBody.appendChild(row);
                }

                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">이 종목에 대한 히스토리 데이터가 없습니다.</td></tr>';
                }
            } catch (error) {
                console.error('히스토리 데이터 렌더링 오류:', error);
                const tableBody = document.getElementById('signals-table-body');
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">히스토리 데이터를 로드할 수 없습니다.</td></tr>';
            }
        }
    </script>
</body>

</html>