<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- <meta http-equiv="Permissions-Policy" content="interest-cohort=()"> --> <!-- í˜¸í™˜ì„± ë¬¸ì œë¡œ ì£¼ì„ ì²˜ë¦¬ -->
    <title>Stock Details - EQ Pairs Monitoring System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .signal-card {
            transition: all 0.3s ease;
        }
        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .blink {
            animation: blink 2s linear infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1.5rem;
            text-align: left;
            font-size: 0.875rem;
        }
        thead {
            background: #f9fafb;
        }
        th {
            font-weight: 500;
            text-transform: uppercase;
            color: #6b7280;
        }
        tbody {
            background: #fff;
        }
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        @media (max-width: 1024px) {
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-2 { grid-template-columns: repeat(1, 1fr); }
        }
        @media (max-width: 640px) {
            th, td {
                padding: 0.5rem 0.75rem;
                font-size: 0.75rem;
            }
            .text-3xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.2rem; }
            button, a { min-height: 44px; padding: 0.75rem 1rem; font-size: 0.875rem; }
            .flex.justify-between.items-center { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Noto Sans KR', sans-serif;">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2" id="stock-name">Stock Details</h1>
                <p class="text-sm text-gray-600">Recent 5 month trend overview</p>
                <p class="text-xs text-gray-500 mt-1">Last Updated: <span id="last-updated-time">Loading...</span></p>
            </div>
            <div class="flex space-x-2">
                <a href="#" id="trade-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                    <i class="fas fa-chart-line mr-2"></i> Marketability
                </a>
                <a href="index.html" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Dashboard
                </a>
            </div>
        </header>

        <div id="loading-container" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4 blink"></div>
            <p class="text-gray-600">Loading data...</p>
        </div>

        <div id="content-container" class="hidden">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Current stock information</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-4 bg-blue-50 rounded-lg">
                    <div class="text-blue-700 text-sm font-medium mb-1">ë³´í†µì£¼ ê°€ê²© [Short]</div>
                    <div class="text-xl font-bold" id="common-price">-</div>
                </div>
                <div class="p-4 bg-purple-50 rounded-lg">
                    <div class="text-purple-700 text-sm font-medium mb-1">ìš°ì„ ì£¼ ê°€ê²© [Long]</div>
                    <div class="text-xl font-bold" id="preferred-price">-</div>
                </div>
                <div class="p-4 bg-green-50 rounded-lg">
                    <div class="text-green-700 text-sm font-medium mb-1">í˜„ì¬ SZ ê°’</div>
                    <div class="text-xl font-bold" id="sz-value">-</div>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg">
                    <div class="text-yellow-700 text-sm font-medium mb-1">í˜„ì¬ ì‹œê·¸ë„</div>
                    <div class="text-xl font-bold" id="current-signal">-</div>
                </div>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">SZ Value Trend</h2>
            <div class="chart-container h-96 md:h-80 sm:h-64" style="position: relative;">
                <!-- ì°¨íŠ¸ ì½˜í…ì¸  (ì˜ˆ: Canvas ë˜ëŠ” Chart.js) -->
                <canvas id="sz-chart"></canvas>
            </div>
        </div>

        <!-- Price Trend Chart -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Price Trend</h2>
            <div class="chart-container h-96 md:h-80 sm:h-64" style="position: relative;">
                <canvas id="price-chart"></canvas>
            </div>
        </div>

        <!-- History Signals Table -->
        <div class="bg-white rounded-lg shadow-md p-6 signal-card">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">SZ History</h2>
            <div class="overflow-x-auto">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>SZ Value</th>
                            <th>Trend</th>
                            <th>Common Stock Price</th>
                            <th>Preferred Stock Price</th>
                        </tr>
                    </thead>
                    <tbody id="signals-table-body">
                        <tr>
                            <td>Loading history data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <footer class="bg-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>Â© 2025 EQ Pair Monitoring System.</p>
        </div>
    </footer>

    <script>
        // ì¢…ëª© ì½”ë“œë¥¼ ì´ë¦„ìœ¼ë¡œë¶€í„° ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (ê°„ë‹¨íˆ êµ¬í˜„)
        function getStockCodeByName(stockName) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì¢…ëª© ì´ë¦„ê³¼ ì½”ë“œ ë§¤í•‘ ë°ì´í„° í•„ìš”
            // ì—¬ê¸°ì„œëŠ” ë”ë¯¸ ì½”ë“œ ë°˜í™˜
            return stockName ? stockName.toLowerCase().replace(/\s/g, '-') : 'unknown';
        }
        // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ì„ ê°€ì ¸ì™€ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        async function fetchLastUpdateTime() {
            try {
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;

                const response = await fetch(stockDataUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch update time (${response.status})`);
                }

                const data = await response.json();

                // íƒ€ì„ìŠ¤íƒ¬í”„ ê°€ì ¸ì˜¤ê¸°
                const updateTime = data.timestamp || data.last_updated || new Date().toLocaleString();

                // í•œêµ­ì–´ ë‚ ì§œ í¬ë§·íŒ…
                let formattedDate;
                try {
                    const date = new Date(updateTime);
                    formattedDate = date.toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    formattedDate = updateTime; // ë³€í™˜ ì‹¤íŒ¨ì‹œ ì›ë³¸ ì‚¬ìš©
                }

                document.getElementById('last-updated-time').textContent = formattedDate;
            } catch (error) {
                console.error('ì—…ë°ì´íŠ¸ ì‹œê°„ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                document.getElementById('last-updated-time').textContent = 'Unknown';
            }
        }
        // HTML íƒœê·¸ ì œê±° í•¨ìˆ˜
        function stripHtmlTags(html) {
            if (!html) return '';
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            return tempDiv.textContent || tempDiv.innerText || '';
        }

        // í˜ì´ì§€ ë¡œë“œ ì´ë²¤íŠ¸
        document.addEventListener('DOMContentLoaded', () => {
            // URLì—ì„œ ì¢…ëª© ì •ë³´ ì¶”ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            const stockCode = urlParams.get('code');
            let stockName = decodeURIComponent(urlParams.get('name') || '');
            // HTML íƒœê·¸ ì œê±°
            stockName = stockName.replace(/<\/?[^>]+(>|$)/g, "");

            if (!stockCode || !stockName) {
                alert('ì¢…ëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = 'index.html';
                return;
            }

            // í˜ì´ì§€ ì œëª© ì„¤ì •
            document.title = `${stockName} - Stock Details`;
            document.getElementById('stock-name').textContent = stockName;

            // ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬
            loadAndProcessStockData(stockCode, stockName);
        });

        // loadAndProcessStockData í•¨ìˆ˜ ìˆ˜ì •
        async function loadAndProcessStockData(stockCode, stockName) {
            console.log(`ë°ì´í„° ë¡œë“œ ì‹œì‘ - ì½”ë“œ: ${stockCode}, ì´ë¦„: ${stockName}`);
            try {
                // ë¡œë”© í‘œì‹œ
                document.getElementById('loading-container').style.display = 'flex';
                document.getElementById('content-container').classList.add('hidden');
                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°
                fetchLastUpdateTime();

                // Marketability ë²„íŠ¼ ë§í¬ ì„¤ì •
                document.getElementById('trade-button').href = `trade-detail.html?code=${stockCode}&name=${encodeURIComponent(stockName)}`;
                console.log("Trade button href updated:", document.getElementById('trade-button').href);

                // íŠ¸ë Œë“œ ë°ì´í„° ë¡œë“œ
                const trendData = await loadStockData(stockCode, stockName);

                // í˜„ì¬ ì •ë³´ ì—…ë°ì´íŠ¸ - ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const currentInfo = await updateCurrentInfo(trendData, stockName, stockCode);

                // ì°¨íŠ¸ ë Œë”ë§
                renderCharts(trendData);

                // íˆìŠ¤í† ë¦¬ ë°ì´í„° ë Œë”ë§
                renderHistoryData(trendData);

                // ë¡œë”© ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°, ì½˜í…ì¸  í‘œì‹œ
                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('content-container').classList.remove('hidden');
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ë° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                document.getElementById('loading-container').innerHTML = `
                <div class="text-red-500 text-center">
                    <p>ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p>${error.message}</p>
                    <div class="mt-4 flex justify-center space-x-4">
                        <button onclick="window.location.reload()" class="px-4 py-2 bg-blue-500 text-white rounded">ë‹¤ì‹œ ì‹œë„</button>
                        <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-gray-500 text-white rounded">ë©”ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                </div>
            `;
            }
        }

        // loadStockData í•¨ìˆ˜ ìˆ˜ì •
        async function loadStockData(stockCode, stockName) {
            try {
                // ê¸°ë³¸ URL ì„¤ì • (GitHub Pages í™˜ê²½ ê³ ë ¤)
                const baseUrl = window.location.hostname.includes('github.io')
                    ? '/stmon'
                    : '';

                // ë°ì´í„° ìš”ì²­ URL
                const trendDataUrl = `${baseUrl}/data/trends/${stockCode}.json?t=${new Date().getTime()}`;
                console.log(`ë°ì´í„° ìš”ì²­ URL: ${trendDataUrl}`);

                const trendDataResponse = await fetch(trendDataUrl);
                if (!trendDataResponse.ok) {
                    console.error(`íŠ¸ë Œë“œ ë°ì´í„° ìš”ì²­ ì‹¤íŒ¨: ${trendDataResponse.status}`);
                    throw new Error(`íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${stockName} (${trendDataResponse.status})`);
                }

                const trendDataText = await trendDataResponse.text();
                console.log(`ì‘ë‹µ ë°ì´í„° ìƒ˜í”Œ: ${trendDataText.substring(0, 100)}...`);

                // JSON íŒŒì‹± ì „ì— "NaN" ë¬¸ìì—´ì„ nullë¡œ ëŒ€ì²´
                const cleanedTrendDataText = trendDataText
                    .replace(/"NaN"/g, 'null')
                    .replace(/NaN/g, 'null')
                    .replace(/Infinity/g, 'null')
                    .replace(/-Infinity/g, 'null');

                // ì•ˆì „í•œ JSON íŒŒì‹±
                try {
                    return JSON.parse(cleanedTrendDataText, (key, value) => {
                        // íŒŒì‹± ì¤‘ì— íŠ¹ìˆ˜ê°’ ì²˜ë¦¬
                        if (value === null || value === undefined ||
                            (typeof value === 'string' && (value === 'NaN' || value === 'Infinity' || value === '-Infinity'))) {
                            return null;
                        }
                        if (typeof value === 'number' && !isFinite(value)) {
                            return null;
                        }
                        return value;
                    });
                } catch (parseError) {
                    console.error('íŠ¸ë Œë“œ ë°ì´í„° JSON íŒŒì‹± ì˜¤ë¥˜:', parseError);
                    throw new Error(`JSON íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${parseError.message}`);
                }
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì „ì²´ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // í˜„ì¬ ì¢…ëª© ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ìˆ˜ì • - ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„ ê°œì„ 
        async function updateCurrentInfo(trendData, stockName, stockCode) {
            try {
                // 1. ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (stock_data.json)
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const stockDataUrl = `${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`;

                const response = await fetch(stockDataUrl, {
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });

                if (!response.ok) {
                    throw new Error(`ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (${response.status})`);
                }

                const stockData = await response.json();

                // 2. ì‹¤ì‹œê°„ APIë¥¼ í†µí•´ í˜„ì¬ ê°€ê²© ê°€ì ¸ì˜¤ê¸° ì‹œë„
                let realTimeData = null;
                try {
                    // ì´ ë¶€ë¶„ì„ ë„¤ì´ë²„ ê¸ˆìœµ API ëŒ€ì‹  ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚¬ìš©
                    // ë„¤ì´ë²„ ê¸ˆìœµ APIëŠ” CORS ì œí•œì´ ìˆì„ ìˆ˜ ìˆìŒ
                    realTimeData = await fetchLatestPrices(stockCode);
                } catch (rtError) {
                    console.warn('ì‹¤ì‹œê°„ ê°€ê²© ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', rtError);
                    // ì‹¤íŒ¨ ì‹œ íŠ¸ë Œë“œ ë°ì´í„°ì—ì„œ ë§ˆì§€ë§‰ ê°€ê²© ì‚¬ìš© (í´ë°±)
                    const lastIndex = trendData.dates.length - 1;
                    realTimeData = {
                        commonPrice: trendData.common_prices[lastIndex],
                        preferredPrice: trendData.preferred_prices[lastIndex]
                    };
                }

                // 3. ì¢…ëª©ëª… ì •ê·œí™” í•¨ìˆ˜ - HTML íƒœê·¸, ì•„ì´ì½˜, ê°€ì¤‘ì¹˜ ì •ë³´ ëª¨ë‘ ì œê±°
                const normalizeStockName = (name) => {
                    // HTML íƒœê·¸ ì œê±°
                    let cleanName = name.replace(/<[^>]+>/g, '');
                    // ì´ëª¨ì§€ ì•„ì´ì½˜ ì œê±° (ğŸ”´ ğŸŸ  ğŸŸ¢ ğŸ”µ)
                    cleanName = cleanName.replace(/^[\u{1F534}\u{1F7E0}\u{1F7E2}\u{1F535}]\s+/u, '');
                    // ê°€ì¤‘ì¹˜ í˜•ì‹ ì œê±° (ì˜ˆ: -0.5- ë˜ëŠ” (0.5))
                    cleanName = cleanName.replace(/-\d+(\.\d+)?-$/, '').replace(/\s*\(\d+(\.\d+)?\)$/, '');
                    return cleanName.trim();
                };

                // 4. í˜„ì¬ ì¢…ëª©ì— ëŒ€í•œ ì •ê·œí™”ëœ ì´ë¦„
                const normalizedCurrentName = normalizeStockName(stockName);
                console.log("ì •ê·œí™”ëœ í˜„ì¬ ì¢…ëª©ëª…:", normalizedCurrentName);

                // 5. ì¼ì¹˜í•˜ëŠ” ì¢…ëª© ì°¾ê¸° - ë‹¤ì–‘í•œ ë°©ì‹ìœ¼ë¡œ ì‹œë„
                let matchedSignal = null;

                // 5.1 ì •ê·œí™”ëœ ì´ë¦„ìœ¼ë¡œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í•­ëª© ì°¾ê¸°
                for (const signal of stockData.all_signals) {
                    const normalizedSignalName = normalizeStockName(signal.stock_name);
                    if (normalizedSignalName === normalizedCurrentName) {
                        matchedSignal = signal;
                        console.log("ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ì¢…ëª© ë°œê²¬:", normalizedSignalName);
                        break;
                    }
                }

                // 5.2 í¬í•¨ ê´€ê³„ë¡œ ì°¾ê¸°
                if (!matchedSignal) {
                    for (const signal of stockData.all_signals) {
                        const normalizedSignalName = normalizeStockName(signal.stock_name);
                        if (normalizedSignalName.includes(normalizedCurrentName) ||
                            normalizedCurrentName.includes(normalizedSignalName)) {
                            matchedSignal = signal;
                            console.log("ë¶€ë¶„ ì¼ì¹˜í•˜ëŠ” ì¢…ëª© ë°œê²¬:", normalizedSignalName);
                            break;
                        }
                    }
                }

                // 5.3 ì¢…ëª© ì½”ë“œë¡œ ê²€ìƒ‰ (ë§ˆì§€ë§‰ ì‹œë„)
                if (!matchedSignal && stockCode !== 'unknown') {
                    for (const signal of stockData.all_signals) {
                        const signalCode = getStockCodeByName(normalizeStockName(signal.stock_name));
                        if (signalCode === stockCode) {
                            matchedSignal = signal;
                            console.log("ì¢…ëª© ì½”ë“œë¡œ ì¼ì¹˜í•˜ëŠ” í•­ëª© ë°œê²¬:", signalCode);
                            break;
                        }
                    }
                }

                // 6. SZ ê°’ê³¼ ì‹ í˜¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                let szValue = 0;
                let signalText = '';

                if (matchedSignal) {
                    szValue = matchedSignal.sz_value || 0;
                    signalText = matchedSignal.signal || '';
                    console.log("ë§¤ì¹­ëœ ì‹ í˜¸ ì •ë³´:", { szValue, signalText });

                    // 6.1 ìµœì‹  ê°€ê²© ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°ì—ë§Œ ë§¤ì¹­ëœ ì‹ í˜¸ì—ì„œ ê°€ê²© ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    if (!realTimeData.commonPrice && matchedSignal.price_a) {
                        realTimeData.commonPrice = matchedSignal.price_a;
                    }
                    if (!realTimeData.preferredPrice && matchedSignal.price_b) {
                        realTimeData.preferredPrice = matchedSignal.price_b;
                    }
                } else {
                    console.warn("ì¼ì¹˜í•˜ëŠ” ì¢…ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:", stockName, stockCode);
                }

                // 7. ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸ - ì‹¤ì‹œê°„ ë°ì´í„° ìš°ì„  ì‚¬ìš©
                document.getElementById('common-price').textContent =
                    (realTimeData.commonPrice !== null && realTimeData.commonPrice !== undefined)
                        ? realTimeData.commonPrice.toLocaleString() + ' KRW'
                        : 'N/A';

                document.getElementById('preferred-price').textContent =
                    (realTimeData.preferredPrice !== null && realTimeData.preferredPrice !== undefined)
                        ? realTimeData.preferredPrice.toLocaleString() + ' KRW'
                        : 'N/A';

                // 8. SZ ê°’ í‘œì‹œ
                const szElement = document.getElementById('sz-value');
                szElement.textContent = szValue.toFixed(2);

                // 9. SZ ê°’ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
                szElement.classList.remove('sz-high', 'sz-medium', 'sz-low');
                if (szValue >= 2.5) {
                    szElement.classList.add('sz-high');
                } else if (szValue >= 1.5) {
                    szElement.classList.add('sz-medium');
                } else {
                    szElement.classList.add('sz-low');
                }

                // 10. ì‹ í˜¸ í‘œì‹œ
                const signalElement = document.getElementById('current-signal');
                let signalHtml = '';

                if (signalText) {
                    if (signalText.includes('R')) {
                        signalHtml += '<span class="signal-tag signal-R">R</span>';
                    }
                    if (signalText.includes('I')) {
                        signalHtml += '<span class="signal-tag signal-I">I</span>';
                    }
                    if (signalText.includes('O')) {
                        signalHtml += '<span class="signal-tag signal-O">O</span>';
                    }
                }

                signalElement.innerHTML = signalHtml || 'N/A';

                return {
                    commonPrice: realTimeData.commonPrice,
                    preferredPrice: realTimeData.preferredPrice,
                    szValue: szValue,
                    signal: signalText
                };

            } catch (error) {
                console.error('í˜„ì¬ ì •ë³´ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
                document.getElementById('common-price').textContent = 'N/A';
                document.getElementById('preferred-price').textContent = 'N/A';
                document.getElementById('sz-value').textContent = '0.00';
                document.getElementById('current-signal').textContent = 'N/A';
                return null;
            }
        }

        // ìµœì‹  ê°€ê²© ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ ì¶”ê°€
        async function fetchLatestPrices(stockCode) {
            try {
                // 1. ê¸°ë³¸ stock_data.jsonì—ì„œ price_aì™€ price_b ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const baseUrl = window.location.hostname.includes('github.io') ? '/stmon' : '';
                const response = await fetch(`${baseUrl}/data/stock_data.json?t=${new Date().getTime()}`, {
                    cache: 'no-store'
                });

                if (!response.ok) {
                    throw new Error(`ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${response.status}`);
                }

                const data = await response.json();

                // 2. ì¢…ëª© ì½”ë“œë¡œ ë§¤ì¹­ë˜ëŠ” í•­ëª© ì°¾ê¸°
                let matchedItem = null;
                for (const signal of data.all_signals) {
                    // ì½”ë“œ ë§¤í•‘ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¢…ëª© ì½”ë“œ ì°¾ê¸°
                    const signalCode = getStockCodeByName(signal.stock_name);
                    if (signalCode === stockCode) {
                        matchedItem = signal;
                        break;
                    }
                }

                // 3. ê²°ê³¼ ë°˜í™˜
                if (matchedItem && matchedItem.price_a && matchedItem.price_b) {
                    console.log("ìµœì‹  ê°€ê²© ë°ì´í„° ë°œê²¬:", {
                        commonPrice: matchedItem.price_a,
                        preferredPrice: matchedItem.price_b
                    });
                    return {
                        commonPrice: matchedItem.price_a,
                        preferredPrice: matchedItem.price_b
                    };
                }

                // 4. ì¼ì¹˜í•˜ëŠ” í•­ëª©ì´ ì—†ìœ¼ë©´ null ë°˜í™˜
                throw new Error("ì¼ì¹˜í•˜ëŠ” ê°€ê²© ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ");

            } catch (error) {
                console.warn("ìµœì‹  ê°€ê²© ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                throw error;
            }
        }

        // ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ (5ê°œì›” ë°ì´í„°ë¡œ ì œí•œ)
        function renderCharts(trendData) {
            try {
                // í™”ë©´ í¬ê¸° ê°ì§€
                const screenWidth = window.innerWidth;
                const isMobile = screenWidth <= 640;

                // ì°¨íŠ¸ ë†’ì´ì™€ í¬ì¸íŠ¸ í¬ê¸° ë™ì  ì¡°ì •
                const chartHeight = isMobile ? 250 : 300;
                const pointRadius = isMobile ? 0 : 1;

                // ìµœê·¼ ë°ì´í„° ìŠ¬ë¼ì´ìŠ¤ (5ê°œì›” ë°ì´í„°)
                const recentDates = trendData.dates.slice(-150);
                const recentCommonPrices = trendData.common_prices.slice(-150);
                const recentPreferredPrices = trendData.preferred_prices.slice(-150);

                // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                if (!recentDates.length || !recentCommonPrices.length || !recentPreferredPrices.length) {
                    throw new Error('ì°¨íŠ¸ ë Œë”ë§ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                }

                // SZ ê°’ ì°¨íŠ¸ ë Œë”ë§
                renderSZChart(trendData.dates, trendData.discount_rates, chartHeight, pointRadius);

                // ê°€ê²© ì°¨íŠ¸ ë Œë”ë§
                renderPriceChart(recentDates, recentCommonPrices, recentPreferredPrices, chartHeight, pointRadius);

                // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                console.log('ë°ì´í„° ë¡œë“œ ì„±ê³µ! ë°ì´í„° í¬ê¸°:', {
                    'ì „ì²´ ë°ì´í„° ê¸¸ì´': trendData.dates.length,
                    'ìµœê·¼ 5ê°œì›” ê¸¸ì´': recentDates.length,
                    'ìµœì´ˆ ë‚ ì§œ': trendData.dates[0],
                    'ìµœê·¼ ë‚ ì§œ': trendData.dates[trendData.dates.length - 1]
                });
            } catch (error) {
                console.error('ì°¨íŠ¸ ë Œë”ë§ ì˜¤ë¥˜:', error);
                document.getElementById('sz-chart').parentElement.innerHTML = '<p class="text-red-500 text-center">ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                document.getElementById('price-chart').parentElement.innerHTML = '<p class="text-red-500 text-center">ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        // SZ ê°’ ê³„ì‚° í•¨ìˆ˜ - ê°œì„ ëœ ë²„ì „
        function calculateSZValues(discountRates) {
            const avgPeriod = 249;
            const result = [];

            for (let i = avgPeriod + 1; i < discountRates.length; i++) {
                // ì´ì „ ê¸°ê°„ ë°ì´í„° (1ì¼ ì‹œí”„íŠ¸ ì ìš©)
                const windowData = discountRates.slice(i - avgPeriod - 1, i - 1);

                // í‰ê·  ê³„ì‚°
                const mean = windowData.reduce((sum, val) => sum + (val ?? 0), 0) / windowData.length;

                // í‘œì¤€í¸ì°¨ ê³„ì‚°
                let sumSquaredDiff = 0;
                for (let j = 0; j < windowData.length; j++) {
                    const val = windowData[j] ?? 0;
                    sumSquaredDiff += Math.pow(val - mean, 2);
                }
                const stdDev = Math.sqrt(sumSquaredDiff / windowData.length);

                // SZ ê°’ ê³„ì‚°
                const sz = stdDev !== 0 ? ((discountRates[i] ?? 0) - mean) / stdDev : 0;

                result.push({
                    index: i,
                    value: sz
                });
            }

            return result;
        }

        function processSignals(signals) {
            return signals.map(signal => {
                const processedSignal = { ...signal };
                let newSignal = '';

                // R ì‹ í˜¸ (SZ ê°’ì´ 2.0 ì´ìƒ)
                if (signal.sz_value >= 2.0) {
                    newSignal += 'R';
                }

                // I ì‹ í˜¸ (SZ ê°’ì´ 1.5 ì´ìƒì´ê³  2.5 ë¯¸ë§Œ)
                if (signal.sz_value >= 1.5 && signal.sz_value < 2.5) {
                    newSignal += 'I';
                }

                // O ì‹ í˜¸ (SZ ê°’ì´ 0.5 ë¯¸ë§Œ)
                if (signal.sz_value < 0.5) {
                    newSignal += 'O';
                }

                // ìƒˆë¡œ ê³„ì‚°ëœ ì‹ í˜¸ í• ë‹¹
                processedSignal.signal = newSignal;
                return processedSignal;
            });
        }

        // SZ ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ ìˆ˜ì •
        function renderSZChart(dates, discountRates, chartHeight, pointRadius) {
            const ctx = document.getElementById('sz-chart').getContext('2d');
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 640;

            // ê¸°ì¡´ SZ ê°’ ê³„ì‚° ë¡œì§ ìœ ì§€
            const calculatedSZ = calculateSZValues(discountRates);
            const fiveMonthsInDays = 150;
            const startIndex = Math.max(0, discountRates.length - fiveMonthsInDays);
            const recentSZ = calculatedSZ.filter(item => item.index >= startIndex);

            const chartLabels = [];
            const chartValues = [];

            for (const sz of recentSZ) {
                if (sz.index < dates.length) {
                    chartLabels.push(dates[sz.index]);
                    chartValues.push(sz.value);
                }
            }

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (window.szChart) {
                window.szChart.destroy();
            }

            // ìƒˆ ì°¨íŠ¸ ìƒì„± (ëª¨ë°”ì¼ ìµœì í™” ì˜µì…˜ ì¶”ê°€)
            window.szChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'SZ Value',
                        data: chartValues,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        pointRadius: pointRadius,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: chartHeight,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `SZ Value: ${context.raw.toFixed(2)}`;
                                }
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: '5 Month SZ Value Trend',
                            font: {
                                size: isMobile ? 12 : 16
                            }
                        }
                    },
                    elements: {
                        point: {
                            hitRadius: isMobile ? 10 : 5
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'SZ Value',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 5 : 10,
                                autoSkip: true,
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // ê°€ê²© ì°¨íŠ¸ ë Œë”ë§ í•¨ìˆ˜ë„ ìœ ì‚¬í•˜ê²Œ ìˆ˜ì •
        function renderPriceChart(dates, commonPrices, preferredPrices, chartHeight, pointRadius) {
            const ctx = document.getElementById('price-chart').getContext('2d');
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 640;

            // ê¸°ì¡´ ì°¨íŠ¸ ìƒì„± ë¡œì§ ìœ ì§€í•˜ë˜, ëª¨ë°”ì¼ ìµœì í™” ì˜µì…˜ ì¶”ê°€
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Common Stock Price',
                            data: commonPrices.map(val => val ?? 0),
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            pointRadius: pointRadius,
                            tension: 0.2
                        },
                        {
                            label: 'Preferred Stock Price',
                            data: preferredPrices.map(val => val ?? 0),
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointRadius: pointRadius,
                            tension: 0.2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    height: chartHeight,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.dataset.label}: ${context.raw.toLocaleString()} KRW`;
                                }
                            },
                            bodyFont: {
                                size: isMobile ? 10 : 12
                            }
                        },
                        title: {
                            display: true,
                            text: '5 Month Price Trend',
                            font: {
                                size: isMobile ? 12 : 16
                            }
                        }
                    },
                    elements: {
                        point: {
                            hitRadius: isMobile ? 10 : 5
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Price (KRW)',
                                font: {
                                    size: isMobile ? 10 : 12
                                }
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toLocaleString();
                                },
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 5 : 10,
                                autoSkip: true,
                                font: {
                                    size: isMobile ? 9 : 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // íˆìŠ¤í† ë¦¬ ë°ì´í„° ë Œë”ë§ - 5ê°œì›” ì œí•œ ì ìš© (ì™„ì „íˆ ê°œì„ ëœ ë²„ì „)
        function renderHistoryData(trendData) {
            try {
                const tableBody = document.getElementById('signals-table-body');
                const fiveMonthsInDays = 150;
                const startIndex = Math.max(0, trendData.dates.length - fiveMonthsInDays);
                const displayDates = [];
                for (let i = trendData.dates.length - 1; i >= startIndex; i -= 1) {
                    displayDates.push(i);
                }

                if (!trendData || !trendData.dates || trendData.dates.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ì´ ì¢…ëª©ì— ëŒ€í•œ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tableBody.innerHTML = '';

                const calculatedSZ = calculateSZValues(trendData.discount_rates);
                const szValueMap = {};
                calculatedSZ.forEach(item => {
                    szValueMap[item.index] = item.value ?? 0; // nullì„ 0ìœ¼ë¡œ ëŒ€ì²´
                });

                for (const i of displayDates) {
                    const row = document.createElement('tr');
                    const date = trendData.dates[i];
                    const szValue = szValueMap[i] ?? 0; // nullì„ 0ìœ¼ë¡œ ëŒ€ì²´

                    if (szValue === undefined) continue;

                    let szClass = 'text-green-600';
                    if (szValue >= 2.5) {
                        szClass = 'text-red-600 font-bold';
                    } else if (szValue >= 1.5) {
                        szClass = 'text-orange-600 font-bold';
                    }

                    let trendIcon = '-';
                    if (displayDates.indexOf(i) < displayDates.length - 1) {
                        const prevIndex = displayDates[displayDates.indexOf(i) + 1];
                        const prevSZ = szValueMap[prevIndex] ?? 0; // nullì„ 0ìœ¼ë¡œ ëŒ€ì²´

                        if (szValue > prevSZ) {
                            trendIcon = '<i class="fas fa-arrow-up text-red-500"></i>';
                        } else if (szValue < prevSZ) {
                            trendIcon = '<i class="fas fa-arrow-down text-green-500"></i>';
                        } else {
                            trendIcon = '<i class="fas fa-minus text-gray-500"></i>';
                        }
                    }

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${szClass}">${szValue.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">${trendIcon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(trendData.common_prices[i] ?? 0).toLocaleString()} KRW</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${(trendData.preferred_prices[i] ?? 0).toLocaleString()} KRW</td>
                    `;

                    tableBody.appendChild(row);
                }

                if (tableBody.children.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">ì´ ì¢…ëª©ì— ëŒ€í•œ íˆìŠ¤í† ë¦¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                }
            } catch (error) {
                console.error('íˆìŠ¤í† ë¦¬ ë°ì´í„° ë Œë”ë§ ì˜¤ë¥˜:', error);
                const tableBody = document.getElementById('signals-table-body');
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-red-500">íˆìŠ¤í† ë¦¬ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
    </script>
</body>

</html>