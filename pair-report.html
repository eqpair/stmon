<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>페어 트레이딩 리포트</title>
    <style>
        body {
            font-family: sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px;
        }

        th {
            background: #f3f3f3;
        }

        .exited {
            background: #e6ffe6;
        }

        .holding {
            background: #ffe6e6;
        }

        .loading {
            color: #888;
        }
    </style>
</head>

<body>
    <h1>페어 트레이딩 리포트</h1>
    <table>
        <thead>
            <tr>
                <th>페어명</th>
                <th>보통주 코드</th>
                <th>우선주 코드</th>
                <th>진입일</th>
                <th>청산일</th>
                <th>진입가(보통/우선)</th>
                <th>청산가(보통/우선)</th>
                <th>수량(보통/우선)</th>
                <th>평가손익/실현손익</th>
                <th>Floating Spread</th>
                <th>Benchmark(%)</th>
                <th>상태</th>
            </tr>
        </thead>
        <tbody id="pair-trades-body">
            <tr>
                <td colspan="12" class="loading">데이터 불러오는 중...</td>
            </tr>
        </tbody>
    </table>
    <script>
        // 네이버 실시간 가격 fetch
        async function fetchNaverPrice(code) {
            try {
                const url = `https://polling.finance.naver.com/api/realtime?query=SERVICE_ITEM:${code}`;
                const res = await fetch(url);
                const data = await res.json();
                return data.result.areas[0].datas[0].nv || null;
            } catch {
                return null;
            }
        }
        // trend 파일에서 마감가 fetch (실시간 실패시)
        async function fetchTrendClose(code) {
            try {
                const res = await fetch(`/data/trends/${code}.json`);
                const data = await res.json();
                const arr = data.common_prices || data.preferred_prices;
                if (arr && arr.length > 0) return arr[arr.length - 1];
                return null;
            } catch {
                return null;
            }
        }
        // 손익 계산 함수
        function calcPnL(entry, exit, qty, direction) {
            if (entry == null || exit == null || qty == null) return 0;
            return (direction === 'S' ? (entry - exit) : (exit - entry)) * qty;
        }
        async function renderTable() {
            const res = await fetch('/stmon/data/pair-trades.json');
            const data = await res.json();
            const tbody = document.getElementById('pair-trades-body');
            tbody.innerHTML = '';
            for (const trade of data) {
                const isExited = trade.status === "Exited";
                let commonPrice = trade.common_exit;
                let preferredPrice = trade.preferred_exit;
                // 보유중이면 실시간/마감가 fetch
                if (!isExited) {
                    commonPrice = await fetchNaverPrice(trade.common_code);
                    if (commonPrice === null) commonPrice = await fetchTrendClose(trade.common_code);
                    preferredPrice = await fetchNaverPrice(trade.preferred_code);
                    if (preferredPrice === null) preferredPrice = await fetchTrendClose(trade.preferred_code);
                }
                // 손익 계산
                let pnl = '-';
                if (commonPrice && preferredPrice) {
                    const shortPnl = calcPnL(trade.common_entry, commonPrice, trade.common_qty, 'S');
                    const longPnl = calcPnL(trade.preferred_entry, preferredPrice, trade.preferred_qty, 'L');
                    pnl = (shortPnl + longPnl).toLocaleString();
                }
                const tr = document.createElement('tr');
                tr.className = isExited ? 'exited' : 'holding';
                tr.innerHTML = `
          <td>${trade.pair_name}</td>
          <td>${trade.common_code}</td>
          <td>${trade.preferred_code}</td>
          <td>${trade.entry_date}</td>
          <td>${trade.exit_date || '-'}</td>
          <td>${trade.common_entry?.toLocaleString() || '-'}<br>${trade.preferred_entry?.toLocaleString() || '-'}</td>
          <td>${commonPrice ? commonPrice.toLocaleString() : '-'}<br>${preferredPrice ? preferredPrice.toLocaleString() : '-'}</td>
          <td>${trade.common_qty}<br>${trade.preferred_qty}</td>
          <td>${pnl}</td>
          <td>${trade.common_floating_spread_bps}<br>${trade.preferred_floating_spread_bps}</td>
          <td>${trade.benchmark_rate_pct}</td>
          <td>${trade.status}</td>
        `;
                tbody.appendChild(tr);
            }
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="12" class="loading">매매 기록이 없습니다.</td></tr>`;
            }
        }
        renderTable();
    </script>
</body>

</html>