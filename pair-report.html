<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>페어 트레이딩 리포트 (가독성 개선)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: #f8f9fa;
            margin: 0;
        }

        h1 {
            font-size: 1.4em;
            text-align: center;
            margin: 1.5em 0 1em 0;
        }

        .top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.2em;
            padding: 0.5em 0.5em 0 0.5em;
            box-sizing: border-box;
        }

        .last-update {
            font-size: 1em;
            color: #666;
            margin-left: 0.5em;
        }

        .home-btn {
            position: absolute;
            top: 22px;
            right: 26px;
            background: #fff;
            color: #1976d2;
            border: 1.5px solid #1976d2;
            border-radius: 6px;
            padding: 8px 22px;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 8px #e0e0e0;
            transition: background 0.2s, color 0.2s;
        }

        .home-btn:hover {
            background: #1976d2;
            color: #fff;
        }

        .card-list {
            display: flex;
            flex-direction: column;
            gap: 36px;
            justify-content: flex-start;
            margin: 0 auto 3em auto;
            max-width: 700px;
        }

        .pair-card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 3px 16px #e0e0e0;
            margin: 0.7em 0;
            width: 100%;
            padding: 2.3em 2.4em 2.1em 2.4em;
            display: flex;
            flex-direction: column;
            gap: 1.2em;
        }

        .pair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5em;
        }

        .pair-title {
            font-size: 1.25em;
            font-weight: 700;
            color: #1976d2;
            letter-spacing: -0.5px;
        }

        .pair-status {
            font-size: 1.08em;
            font-weight: 600;
            color: #888;
            padding: 5px 16px;
            border-radius: 7px;
            background: #f3f3f3;
        }

        .pair-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.13em;
            font-weight: 600;
            margin: 0.5em 0 1em 0;
        }

        .profit-plus {
            color: #d60000;
            font-weight: bold;
        }

        .profit-minus {
            color: #0050b3;
            font-weight: bold;
        }

        .rate-plus {
            color: #d60000;
            font-weight: bold;
        }

        .rate-minus {
            color: #0050b3;
            font-weight: bold;
        }

        .pair-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.6em;
            table-layout: fixed;
        }

        .pair-table th,
        .pair-table td {
            padding: 13px 8px;
            font-size: 1.08em;
            word-break: break-all;
            text-align: center;
            border-bottom: 1.5px solid #e0e0e0;
            background: #f9f9f9;
        }

        .pair-table th {
            background: #f3f3f3;
            font-weight: 700;
            font-size: 1.04em;
            border-top: 1.5px solid #e0e0e0;
        }

        .bold-green {
            color: #1ca93a;
            font-weight: bold;
        }

        @media (max-width: 900px) {
            .card-list {
                max-width: 100%;
            }

            .pair-card {
                min-width: 0;
                max-width: 100%;
                padding: 1.6em 0.8em 1.3em 0.8em;
            }

            .home-btn {
                right: 8px;
                top: 10px;
                padding: 6px 13px;
                font-size: 0.97em;
            }

            h1 {
                font-size: 1.13em;
            }

            .pair-title {
                font-size: 1.07em;
            }

            .pair-summary {
                font-size: 1em;
            }

            .pair-table th,
            .pair-table td {
                font-size: 0.97em;
                padding: 9px 4px;
            }
        }

        @media (max-width: 600px) {
            .pair-card {
                padding: 1.1em 0.3em 1em 0.3em;
            }

            .pair-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .pair-title {
                font-size: 1em;
            }

            .pair-summary {
                font-size: 0.96em;
            }

            .pair-table th,
            .pair-table td {
                font-size: 0.93em;
                padding: 7px 2px;
            }
        }
    </style>
</head>

<body>
    <div class="top-bar">
        <span class="last-update" id="last-update">Last update: -</span>
        <button class="home-btn" onclick="location.href='index.html'">HOME</button>
    </div>
    <h1>페어 트레이딩 리포트</h1>
    <div class="card-list" id="card-list">
        <div style="text-align:center;width:100%;">데이터 불러오는 중...</div>
    </div>
    <script>
        function calcFee(entry, exit, qty, bps) {
            if (!entry || !exit || !qty || !bps) return 0;
            return (entry * qty + exit * qty) * (bps / 10000);
        }
        function calcFloatingAmt(entry, qty, borrowFeePct, days) {
            if (!entry || !qty || !borrowFeePct || !days) return 0;
            return entry * qty * (borrowFeePct / 100) * (days / 365);
        }
        function calcPnL(entry, exit, qty, direction, floatingAmt = 0, comm_bps = 0, stamp_bps = 0) {
            if (entry == null || exit == null || qty == null) return 0;
            const base = (direction === 'S' ? (entry - exit) : (exit - entry)) * qty;
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            if (direction === 'S') {
                return base - floatingAmt - commission - stamp;
            } else {
                return base - commission - stamp;
            }
        }
        function calcReturn(entry, qty, profit) {
            if (!entry || !qty) return 0;
            return profit / (entry * qty) * 100;
        }
        function profitClass(val) {
            return val > 0 ? 'profit-plus' : (val < 0 ? 'profit-minus' : '');
        }
        function rateClass(val) {
            return val > 0 ? 'rate-plus' : (val < 0 ? 'rate-minus' : '');
        }
        // trend 파일에서 현재가(마감가) fetch
        async function fetchTrendClose(pair) {
            try {
                const res = await fetch('data/trends/' + pair.common_code + '.json');
                const data = await res.json();
                let commonClose = null, preferredClose = null;
                if (data.common_prices && data.common_prices.length > 0)
                    commonClose = data.common_prices[data.common_prices.length - 1];
                if (data.preferred_prices && data.preferred_prices.length > 0)
                    preferredClose = data.preferred_prices[data.preferred_prices.length - 1];
                return { commonClose, preferredClose };
            } catch {
                return { commonClose: null, preferredClose: null };
            }
        }
        // stock_data.json에서 last update 읽기
        async function updateLastUpdate() {
            try {
                const res = await fetch('data/stock_data.json');
                const data = await res.json();
                let last = data.last_updated || data.timestamp || '';
                if (last) {
                    document.getElementById('last-update').textContent = 'Last update: ' + last;
                }
            } catch {
                document.getElementById('last-update').textContent = 'Last update: -';
            }
        }
        async function renderCards() {
            await updateLastUpdate();
            const res = await fetch('data/pair-trades.json');
            const data = await res.json();
            const cardList = document.getElementById('card-list');
            cardList.innerHTML = '';
            const todayStr = new Date().toISOString().slice(0, 10);
            for (const trade of data) {
                const isExited = trade.status === "Exited";
                let commonPrice = trade.common_exit;
                let preferredPrice = trade.preferred_exit;
                let exitDate = trade.exit_date;
                if (!isExited) {
                    const trend = await fetchTrendClose(trade);
                    commonPrice = trend.commonClose;
                    preferredPrice = trend.preferredClose;
                    exitDate = todayStr;
                }
                const entryDate = new Date(trade.entry_date);
                const lastDate = exitDate ? new Date(exitDate) : new Date();
                const days = Math.max(1, Math.round((lastDate - entryDate) / (1000 * 60 * 60 * 24)));
                const comm_bps = trade.commission_bps || 0;
                const stamp_bps = trade.stamp_bps || 0;
                const borrowFeePct = trade.common_borrow_fee_pct || 0;
                const floatingAmt = calcFloatingAmt(trade.common_entry, trade.common_qty, borrowFeePct, days);
                const shortPnl = calcPnL(trade.common_entry, commonPrice, trade.common_qty, 'S', floatingAmt, comm_bps, stamp_bps);
                const shortRet = calcReturn(trade.common_entry, trade.common_qty, shortPnl);
                const longPnl = calcPnL(trade.preferred_entry, preferredPrice, trade.preferred_qty, 'L', 0, comm_bps, stamp_bps);
                const longRet = calcReturn(trade.preferred_entry, trade.preferred_qty, longPnl);
                const totalPnl = shortPnl + longPnl;
                const totalInvest = trade.common_entry * trade.common_qty + trade.preferred_entry * trade.preferred_qty;
                const totalRet = totalInvest ? (totalPnl / totalInvest * 100) : 0;

                // 카드 생성
                const card = document.createElement('div');
                card.className = 'pair-card';

                // Header
                card.innerHTML += `
          <div class="pair-header">
            <span class="pair-title">${trade.pair_name}</span>
            <span class="pair-status">${trade.status}</span>
          </div>
          <div class="pair-summary">
            <span>Total Profit: <span class="${profitClass(totalPnl)}">${Math.round(totalPnl).toLocaleString()}</span></span>
            <span>Total Rate: <span class="${rateClass(totalRet)}">${totalRet.toFixed(2)}%</span></span>
          </div>
        `;

                // 상세 테이블
                card.innerHTML += `
          <table class="pair-table">
            <thead>
              <tr>
                <th>Position</th>
                <th>Code</th>
                <th>Entry D.</th>
                <th>Exit D.</th>
                <th>Entry P.</th>
                <th>Exit(Current)</th>
                <th>Q'ty</th>
                <th>Profit</th>
                <th>Rate</th>
                <th>No of days</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Short</td>
                <td>${trade.common_code}</td>
                <td>${trade.entry_date}</td>
                <td>${isExited ? trade.exit_date : '-'}</td>
                <td>${trade.common_entry?.toLocaleString() || '-'}</td>
                <td${!isExited ? ' class="bold-green"' : ''}>${commonPrice != null ? commonPrice.toLocaleString() : '-'}</td>
                <td>${trade.common_qty}</td>
                <td class="${profitClass(shortPnl)}">${Math.round(shortPnl).toLocaleString()}</td>
                <td class="${rateClass(shortRet)}">${shortRet.toFixed(2)}%</td>
                <td>${days}</td>
              </tr>
              <tr>
                <td>Long</td>
                <td>${trade.preferred_code}</td>
                <td>${trade.entry_date}</td>
                <td>${isExited ? trade.exit_date : '-'}</td>
                <td>${trade.preferred_entry?.toLocaleString() || '-'}</td>
                <td${!isExited ? ' class="bold-green"' : ''}>${preferredPrice != null ? preferredPrice.toLocaleString() : '-'}</td>
                <td>${trade.preferred_qty}</td>
                <td class="${profitClass(longPnl)}">${Math.round(longPnl).toLocaleString()}</td>
                <td class="${rateClass(longRet)}">${longRet.toFixed(2)}%</td>
                <td>${days}</td>
              </tr>
            </tbody>
          </table>
        `;
                cardList.appendChild(card);
            }
            if (data.length === 0) {
                cardList.innerHTML = `<div style="text-align:center;width:100%;">매매 기록이 없습니다.</div>`;
            }
        }
        renderCards();
    </script>
</body>

</html>