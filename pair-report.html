<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>EQ Pairs Trading REPORT</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        .signal-card {
            transition: all 0.3s ease;
        }

        .signal-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .blink {
            animation: blink 2s linear infinite;
        }

        @keyframes blink {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
            /* 종목명 줄바꿈 방지 */
        }
        .report-table td:first-child {
            text-align: left;
        }

        .sz-high {
            color: #DC2626;
            font-weight: bold;
        }
        .sz-medium {
            color: #EA580C;
            font-weight: bold;
        }
        .sz-low {
            color: #16A34A;
        }

        .report-table th {
            background: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #6b7280;
        }

        /* <style> 섹션에 추가 */
        .item-group {
            border-top: 2px solid #d1d5db; /* 그룹 간 회색 테두리 */
            margin-top: 8px; /* 선택사항: 간격 추가 */
        }

        .profit-plus,
        .rate-plus {
            color: #dc2626;
            font-weight: bold;
        }

        .profit-minus,
        .rate-minus {
            color: #0284c7;
            font-weight: bold;
        }

        .open-green {
            color: #16a34a;
            font-weight: bold;
        }

        .bold-green {
            color: #16a34a;
            font-weight: bold;
        }

        .clickable-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .exited-row {
            background-color: #f3f4f6;
            /* 연회색 배경 */
        }

        @media (max-width: 1024px) {
            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid-cols-2 {
                grid-template-columns: repeat(1, 1fr);
            }

            .report-table th,
            .report-table td {
                padding: 0.6rem;
                font-size: 0.7rem;
            }
        }

        @media (max-width: 640px) {

            .report-table th,
            .report-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .text-3xl {
                font-size: 1.5rem;
            }

            .text-xl {
                font-size: 1.2rem;
            }

            button,
            a {
                min-height: 44px;
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .flex.justify-between.items-center {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EQ Pairs Trading REPORT</h1>
                <a href="index.html"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-home mr-2"></i> Home
                </a>
            </div>
            <div class="flex items-center text-sm text-gray-600">
                <span class="mr-2">Last Update:</span>
                <span id="lastUpdated" class="font-medium"></span>
            </div>
        </header>

        <div id="loading-container" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4 blink"></div>
            <p class="text-gray-600">Loading Data...</p>
        </div>

        <div id="content-container" class="bg-white rounded-lg shadow-md p-6 signal-card hidden">
            <div class="overflow-x-auto">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>SZ</th>
                            <th>T. Profit</th>
                            <th>Rate</th>
                            <th>Status</th>
                            <th>T. Invested</th>
                            <th>Pos.</th>
                            <th>Entry P.</th>
                            <th>Exit(Curr.)</th>
                            <th>Q'ty</th>
                            <th>Profit</th>
                            <th>Rate</th>
                            <th>Invested</th>
                            <th>Entry D.</th>
                            <th>Exit D.</th>
                            <th>Days</th>
                        </tr>
                    </thead>
                    <tbody id="report-body">
                        <tr>
                            <td colspan="18" style="text-align:center;">Loading Data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="bg-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>© 2025 EQ Pair Monitoring System.</p>
        </div>
    </footer>

    <script>
        let tradesData = [];

        // 종목명으로 종목 코드를 가져오는 함수
        function getStockCodeByName(stockName) {
            if (!stockName) return 'unknown';

            // HTML 태그 및 이모지 제거
            let cleanName = stockName.replace(/<[^>]+>/g, "").trim();
            cleanName = cleanName.replace(/^[^\w\s가-힣]+/, '').trim();
            cleanName = cleanName.replace(/-\d+(\.\d+)?$/, '').trim();

            // 종목 코드 맵핑
            const stockCodeMap = {
                '삼성전자': '005930',
                '코오롱모빌리티그룹': '450140',
                '태양금속': '004100',
                'NPC': '004250',
                '대한제당': '001790',
                '덕성': '004830',
                '코리아써키트': '007810',
                '코오롱': '002020',
                '현대차': '005380',
                '대신증권': '003540',
                '성신양회': '004980',
                '코오롱글로벌': '003070',
                'NH투자증권': '005940',
                '신풍제약': '019170',
                'LG전자': '066570',
                '한화솔루션': '009830',
                '세방': '004360',
                '한화투자증권': '003530',
                'LG생활건강': '051900',
                '아모레퍼시픽': '090430',
                'LG화학': '051910',
                '아모레G': '002790',
                '대한항공': '003490',
                'S-Oil': '010950',
                '한진칼': '180640',
                'SK증권': '001510',
                '한국금융지주': '071050',
                '티와이홀딩스': '363280',
                '미래에셋증권': '006800',
                '동부건설': '005960',
                '크라운제과': '264900',
                '두산': '000150',
                '남선알미늄': '008350',
                '금호석유': '011780',
                '넥센': '005720',
                'LX하우시스': '108670',
                '삼성화재': '000810',
                '대상홀딩스': '084690',
                'SK케미칼': '285130',
                '소프트센': '032680',
                '삼성전기': '009150',
                '노루홀딩스': '000320',
                'LG': '003550',
                '삼성SDI': '006400',
                '코오롱인더': '120110',
                '대원전선': '006340',
                '태영건설': '009410',
                '흥국화재': '000540',
                '대호특수강': '021040',
                '계양전기': '012200',
                '한양증권': '001750',
                '호텔신라': '008770',
                'SK이노베이션': '096770',
                '서울식품': '004410',
                '현대건설': '000720',
                'DL이앤씨': '375500',
                'GS': '078930',
                '금강공업': '014280',
                '대상': '001680',
                '금호건설': '002990',
                'CJ제일제당': '097950',
                'SK디스커버리': '006120',
                'DL': '000210',
                '노루페인트': '090350',
                '동양': '001520',
                '한화': '000880',
                'CJ': '001040',
                '크라운해태홀딩스': '005740',
                '롯데칠성': '005300',
                'SK': '034730',
                '성문전자': '014910',
                '일양약품': '007570',
                '롯데지주': '004990',
                '깨끗한나라': '004540',
                '유한양행': '000100',
                '부국증권': '001270',
                '남양유업': '003920',
                '유화증권': '003460',
                '삼양사': '145990',
                'JW중외제약': '001060',
                '하이트진로홀딩스': '000140',
                'BYC': '001460',
                '삼양홀딩스': '000070',
                '동원시스템즈': '014820'
            };

            if (stockCodeMap[cleanName]) {
                return stockCodeMap[cleanName];
            }

            for (const name in stockCodeMap) {
                if (cleanName.includes(name) || name.includes(cleanName)) {
                    console.log(`부분 일치 종목: ${name} (${stockCodeMap[name]})`);
                    return stockCodeMap[name];
                }
            }

            console.warn(`매칭되는 종목 코드를 찾을 수 없음: ${cleanName}`);
            return 'unknown';
        }

        // 종목명 정규화 함수
        function normalizeStockName(name) {
            if (!name) return '';
            let cleanName = name.replace(/<[^>]+>/g, '').trim();
            cleanName = cleanName.replace(/^[^\w\s가-힣]+/, '').trim();
            cleanName = cleanName.replace(/-\d+(\.\d+)?$/, '').trim();
            return cleanName;
        }

        // 수수료 계산 함수 (기존 함수 유지)
        function calcFee(entry, exit, qty, bps) {
            if (!entry || !exit || !qty || !bps) return 0;
            return (entry * qty + exit * qty) * (bps / 10000);
        }

        // 차입 비용 계산 함수 (기존 함수 유지)
        function calcBorrowFee(entry, qty, borrowFeePct, days) {
            if (!entry || !qty || !borrowFeePct || !days) return 0;
            return entry * qty * (borrowFeePct / 100) * (days / 365);
        }

        // 숏 포지션 손익 계산 함수 (기존 함수 유지)
        function calcShortPnL(entry, exit, qty, borrowFeePct, days, comm_bps, stamp_bps) {
            const base = (entry - exit) * qty;
            const borrowFee = calcBorrowFee(entry, qty, borrowFeePct, days);
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return base - borrowFee - commission - stamp;
        }

        // 롱 포지션 손익 계산 함수 (기존 함수 유지)
        function calcLongPnL(entry, exit, qty, comm_bps, stamp_bps) {
            const base = (exit - entry) * qty;
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return base - commission - stamp;
        }

        // 새로운 함수: 숏 포지션 투자금액 계산
        function calcShortInvested(entry, qty) {
            // 숏 포지션은 주식을 빌려서 판매하는 것이므로 판매 금액이 투자금액임
            return entry * qty;
        }

        // 새로운 함수: 롱 포지션 투자금액 계산
        function calcLongInvested(entry, qty, comm_bps, stamp_bps) {
            // 롱 포지션은 주식을 구매하는 것이므로 구매 금액 + 수수료가 투자금액임
            const base = entry * qty;
            const commission = (base * comm_bps) / 10000;
            const stamp = (base * stamp_bps) / 10000;
            return base + commission + stamp;
        }

        // 새로운 함수: 숏 포지션 실현금액 계산
        function calcShortRealized(entry, exit, qty, borrowFeePct, days, comm_bps, stamp_bps) {
            // 숏 포지션의 실현금액 = 판매 금액(entry * qty) - 매수 비용(exit * qty) - 차입 비용 - 수수료
            const sellAmount = entry * qty;
            const buyAmount = exit * qty;
            const borrowFee = calcBorrowFee(entry, qty, borrowFeePct, days);
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return sellAmount - buyAmount - borrowFee - commission - stamp;
        }

        // 새로운 함수: 롱 포지션 실현금액 계산
        function calcLongRealized(entry, exit, qty, comm_bps, stamp_bps) {
            // 롱 포지션의 실현금액 = 판매 금액(exit * qty) - 구매 비용(entry * qty) - 수수료
            const buyAmount = entry * qty;
            const sellAmount = exit * qty;
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return sellAmount - buyAmount - commission - stamp;
        }

        // 수익률 계산 함수 (기존 함수 유지)
        function calcReturn(entry, qty, profit) {
            if (!entry || !qty) return 0;
            return profit / (entry * qty) * 100;
        }

        function profitClass(val) {
            return val > 0 ? 'profit-plus' : (val < 0 ? 'profit-minus' : '');
        }

        function rateClass(val) {
            return val > 0 ? 'rate-plus' : (val < 0 ? 'rate-minus' : '');
        }

        async function fetchTrendClose(pair) {
            try {
                const res = await fetch(`data/trends/${pair.common_code}.json?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`트렌드 데이터 로드 실패: ${res.status}`);
                const data = await res.json();
                let commonClose = null, preferredClose = null;
                if (data.common_prices && data.common_prices.length > 0)
                    commonClose = data.common_prices[data.common_prices.length - 1];
                if (data.preferred_prices && data.preferred_prices.length > 0)
                    preferredClose = data.preferred_prices[data.preferred_prices.length - 1];
                return { commonClose, preferredClose };
            } catch (error) {
                console.error('fetchTrendClose 오류:', error);
                return { commonClose: null, preferredClose: null };
            }
        }

        async function updateLastUpdate() {
            try {
                const res = await fetch(`data/stock_data.json?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`마지막 업데이트 데이터 로드 실패: ${res.status}`);
                const data = await res.json();
                let last = data.last_updated || data.timestamp || '';
                if (last) {
                    const formattedDate = new Date(last).toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    document.getElementById('lastUpdated').textContent = formattedDate;
                }
            } catch (error) {
                console.error('updateLastUpdate 오류:', error);
                document.getElementById('lastUpdated').textContent = '알 수 없음';
            }
        }

        async function fetchTradesData() {
            try {
                const res = await fetch(`data/pair-trades.json?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`매매 데이터 로드 실패: ${res.status}`);
                tradesData = await res.json();
                console.log('tradesData 로드됨:', tradesData);
                return tradesData;
            } catch (error) {
                console.error('fetchTradesData 오류:', error);
                tradesData = [];
                return [];
            }
        }
        
        // stock_data.json 로드 함수
        async function fetchStockData() {
            try {
                const res = await fetch(`data/stock_data.json?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`stock_data 로드 실패: ${res.status}`);
                const data = await res.json();
                return data.all_signals || [];
            } catch (error) {
                console.error('fetchStockData 오류:', error);
                return [];
            }
        }

        // 테이블 렌더링 함수 (수정)
        async function renderTable() {
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = '';

            if (tradesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="18" style="text-align:center;">매매 기록이 없습니다.</td></tr>';
                return;
            }

            const todayStr = new Date().toISOString().slice(0, 10);
            for (const trade of tradesData) {
                const isExited = trade.status === "Exited";
                let commonPrice = trade.common_exit; // 보통주 퇴장 가격
                let preferredPrice = trade.preferred_exit; // 우선주 퇴장 가격
                let exitDate = trade.exit_date;

                if (!isExited) {
                    const trend = await fetchTrendClose(trade);
                    commonPrice = trend.commonClose;
                    preferredPrice = trend.preferredClose;
                    exitDate = todayStr;
                }

                const entryDate = new Date(trade.entry_date);
                const lastDate = exitDate ? new Date(exitDate) : new Date();
                const days = Math.max(1, Math.round((lastDate - entryDate) / (1000 * 60 * 60 * 24)));
                const comm_bps = trade.commission_bps || 0;
                const stamp_bps = trade.stamp_bps || 0;
                const borrowFeePct = trade.common_borrow_fee_pct || 0;

                // 손익 계산 (기존 코드 유지)
                const shortPnl = calcShortPnL(
                    trade.common_entry, commonPrice, trade.common_qty,
                    borrowFeePct, days, comm_bps, stamp_bps
                );
                const longPnl = calcLongPnL(
                    trade.preferred_entry, preferredPrice, trade.preferred_qty,
                    comm_bps, stamp_bps
                );
                const totalPnl = shortPnl + longPnl;

                // 투자금액 계산 (수정)
                const commonInvested = calcShortInvested(trade.common_entry, trade.common_qty);
                const preferredInvested = calcLongInvested(trade.preferred_entry, trade.preferred_qty, comm_bps, stamp_bps);
                const totalInvested = commonInvested + preferredInvested;

                // 실현금액 계산 (수정)
                const commonRealized = isExited ?
                    calcShortRealized(trade.common_entry, commonPrice, trade.common_qty, borrowFeePct, days, comm_bps, stamp_bps) : 0;
                const preferredRealized = isExited ?
                    calcLongRealized(trade.preferred_entry, preferredPrice, trade.preferred_qty, comm_bps, stamp_bps) : 0;
                const totalRealized = isExited ? commonRealized + preferredRealized : 0;

                // 수익률 계산
                const totalRet = totalInvested ? (totalPnl / totalInvested * 100) : 0;
                const shortRet = calcReturn(trade.common_entry, trade.common_qty, shortPnl);
                const longRet = calcReturn(trade.preferred_entry, trade.preferred_qty, longPnl);

                // 종목명 처리
                let displayStockName = trade.pair_name || '-';
                let baseStockName = normalizeStockName(displayStockName);
                const stockCode = getStockCodeByName(baseStockName);

                // sz_value 매핑
                const tradeName = normalizeStockName(trade.pair_name).toLowerCase();
                const matchedSignal = stockSignals.find(s => normalizeStockName(s.stock_name).toLowerCase() === tradeName);
                const szValue = matchedSignal?.sz_value ?? null;
                let szClass = '';
                if (szValue !== null) {
                    szClass = szValue >= 2.5 ? 'sz-high' : szValue >= 1.5 ? 'sz-medium' : 'sz-low';
                }

                // Short(보통주) 행
                const trShort = document.createElement('tr');
                trShort.classList.add('item-group'); // item-group 클래스 추가
                if (isExited) {
                    trShort.classList.add('exited-row');
                }
                trShort.innerHTML = `
                <td rowspan="2" class="clickable-item">
                    <a href="trade-detail.html?code=${stockCode}&name=${encodeURIComponent(baseStockName)}"
                        class="hover:text-blue-600 hover:underline">
                        <b>${displayStockName}</b>
                    </a>
                </td>
                <td rowspan="2" class="${szClass}">${szValue !== null ? szValue.toFixed(2) : '-'}</td> <!-- Sz 열 -->
                <td rowspan="2" class="${profitClass(totalPnl)}">${Math.round(totalPnl).toLocaleString()}</td>
                <td rowspan="2" class="${rateClass(totalRet)}">${totalRet.toFixed(2)}%</td>
                <td rowspan="2" class="${trade.status === 'Open' ? 'open-green' : ''}">${trade.status}</td>
                <td rowspan="2">${Math.round(totalInvested).toLocaleString()}</td>
                <td class="center-align"><b>S</b></td>
                <td>${trade.common_entry?.toLocaleString() || '-'}</td>
                <td${!isExited ? ' class="bold-green"' : ''}>${commonPrice != null ? commonPrice.toLocaleString() : '-'}</td>
                <td>${trade.common_qty}</td>
                <td class="${profitClass(shortPnl)}">${Math.round(shortPnl).toLocaleString()}</td>
                <td class="${rateClass(shortRet)}">${shortRet.toFixed(2)}%</td>
                <td>${Math.round(commonInvested).toLocaleString()}</td>
                <td>${trade.entry_date}</td>
                <td>${isExited ? trade.exit_date : '-'}</td>
                <td>${days}</td>
            `;
                tbody.appendChild(trShort);

                // Long(우선주) 행
                const trLong = document.createElement('tr');
                if (isExited) {
                    trLong.classList.add('exited-row');
                }
                trLong.innerHTML = `
                <td></td> <!-- Sz 열은 Long 행에서 비워둠 -->
                <td style="text-align: center;"><b>L</b></td>
                <td>${trade.preferred_entry?.toLocaleString() || '-'}</td>
                <td${!isExited ? ' class="bold-green"' : ''}>${preferredPrice != null ? preferredPrice.toLocaleString() : '-'}</td>
                <td>${trade.preferred_qty}</td>
                <td class="${profitClass(longPnl)}">${Math.round(longPnl).toLocaleString()}</td>
                <td class="${rateClass(longRet)}">${longRet.toFixed(2)}%</td>
                <td>${Math.round(preferredInvested).toLocaleString()}</td>
                <td>${trade.entry_date}</td>
                <td>${isExited ? trade.exit_date : '-'}</td>
                <td>${days}</td>
            `;
                tbody.appendChild(trLong);
            }
        }

        async function init() {
            try {
                document.getElementById('loading-container').style.display = 'flex';
                document.getElementById('content-container').classList.add('hidden');

                await updateLastUpdate();
                await fetchTradesData();
                const stockSignals = await fetchStockData(); // stock_data.json 로드
                await renderTable();

                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('content-container').classList.remove('hidden');
            } catch (error) {
                console.error('초기화 오류:', error);
                document.getElementById('loading-container').innerHTML = `
                    <div class="text-red-500 text-center">
                        <p>데이터를 로드할 수 없습니다.</p>
                        <p>${error.message}</p>
                        <button onclick="window.location.reload()" class="Item" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">
                            다시 시도
                        </button>
                        <button onclick="window.location.href='index.html'" class="mt-4 ml-2 px-4 py-2 bg-gray-500 text-white rounded">
                            메인 페이지로 돌아가기
                        </button>
                    </div>
                `;
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>