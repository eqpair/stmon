<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>EQ Pairs Trading REPORT</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        .signal-card {
            transition: all 0.3s ease;
        }
        .signal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .blink {
            animation: blink 2s linear infinite;
        }
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        .report-table th,
        .report-table td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap; /* 종목명 줄바꿈 방지 */
        }
        .report-table th {
            background: #f9fafb;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            color: #6b7280;
        }
        .profit-plus, .rate-plus {
            color: #dc2626;
            font-weight: bold;
        }
        .profit-minus, .rate-minus {
            color: #0284c7;
            font-weight: bold;
        }
        .open-green {
            color: #16a34a;
            font-weight: bold;
        }
        .bold-green {
        color: #16a34a;
        font-weight: bold;
        }
        .exited-row {
        background-color: #f3f4f6; /* 연회색 배경 */
        }
        @media (max-width: 1024px) {
            .grid-cols-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-cols-2 { grid-template-columns: repeat(1, 1fr); }
        }
        @media (max-width: 640px) {
            .report-table th, .report-table td {
                padding: 0.5rem;
                font-size: 0.75rem;
            }
            .text-3xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.2rem; }
            button, a { min-height: 44px; padding: 0.75rem 1rem; font-size: 0.875rem; }
            .flex.justify-between.items-center { flex-direction: column; gap: 10px; align-items: flex-start; }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">EQ Pairs Trading REPORT</h1>
                <p class="text-sm text-gray-600">Last update: <span id="last-update">Loading...</span></p>
            </div>
            <div class="flex space-x-2">
                <a href="index.html"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-home mr-2"></i> Home
                </a>
            </div>
        </header>

        <div id="loading-container" class="flex flex-col items-center justify-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mb-4 blink"></div>
            <p class="text-gray-600">Loading Data...</p>
        </div>

        <div id="content-container" class="bg-white rounded-lg shadow-md p-6 signal-card hidden">
            <div class="overflow-x-auto">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>ITEM</th>
                            <th>T. Profit</th>
                            <th>Rate</th>
                            <th>Status</th>
                            <th>Pos.</th>
                            <th>Code</th>
                            <th>Entry D.</th>
                            <th>Exit D.</th>
                            <th>Entry P.</th>
                            <th>Exit(Curr.)</th>
                            <th>Q'ty</th>
                            <th>Profit</th>
                            <th>Rate</th>
                            <th>Days</th>
                        </tr>
                    </thead>
                    <tbody id="report-body">
                        <tr>
                            <td colspan="14" style="text-align:center;">Loading Data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="bg-white py-6 mt-8">
        <div class="container mx-auto px-4 text-center text-gray-600 text-sm">
            <p>© 2025 EQ Pair Monitoring System.</p>
        </div>
    </footer>

    <script>
        let tradesData = [];

        function calcFee(entry, exit, qty, bps) {
            if (!entry || !exit || !qty || !bps) return 0;
            return (entry * qty + exit * qty) * (bps / 10000);
        }
        function calcBorrowFee(entry, qty, borrowFeePct, days) {
            if (!entry || !qty || !borrowFeePct || !days) return 0;
            return entry * qty * (borrowFeePct / 100) * (days / 365);
        }
        function calcShortPnL(entry, exit, qty, borrowFeePct, days, comm_bps, stamp_bps) {
            const base = (entry - exit) * qty;
            const borrowFee = calcBorrowFee(entry, qty, borrowFeePct, days);
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return base - borrowFee - commission - stamp;
        }
        function calcLongPnL(entry, exit, qty, comm_bps, stamp_bps) {
            const base = (exit - entry) * qty;
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return base - commission - stamp;
        }
        function calcReturn(entry, qty, profit) {
            if (!entry || !qty) return 0;
            return profit / (entry * qty) * 100;
        }
        function profitClass(val) {
            return val > 0 ? 'profit-plus' : (val < 0 ? 'profit-minus' : '');
        }
        function rateClass(val) {
            return val > 0 ? 'rate-plus' : (val < 0 ? 'rate-minus' : '');
        }
        async function fetchTrendClose(pair) {
            try {
                const res = await fetch(`data/trends/${pair.common_code}.json?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`트렌드 데이터 로드 실패: ${res.status}`);
                const data = await res.json();
                let commonClose = null, preferredClose = null;
                if (data.common_prices && data.common_prices.length > 0)
                    commonClose = data.common_prices[data.common_prices.length - 1];
                if (data.preferred_prices && data.preferred_prices.length > 0)
                    preferredClose = data.preferred_prices[data.preferred_prices.length - 1];
                return { commonClose, preferredClose };
            } catch (error) {
                console.error('fetchTrendClose 오류:', error);
                return { commonClose: null, preferredClose: null };
            }
        }
        
        async function updateLastUpdate() {
            try {
                const res = await fetch(`data/stock_data.json?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`마지막 업데이트 데이터 로드 실패: ${res.status}`);
                const data = await res.json();
                let last = data.last_updated || data.timestamp || '';
                if (last) {
                    const formattedDate = new Date(last).toLocaleString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    document.getElementById('last-update').textContent = formattedDate;
                }
            } catch (error) {
                console.error('updateLastUpdate 오류:', error);
                document.getElementById('last-update').textContent = '알 수 없음';
            }
        }

        async function fetchTradesData() {
            try {
                const res = await fetch(`data/pair-trades.json?t=${new Date().getTime()}`);
                if (!res.ok) throw new Error(`매매 데이터 로드 실패: ${res.status}`);
                tradesData = await res.json();
                console.log('tradesData 로드됨:', tradesData);
                return tradesData;
            } catch (error) {
                console.error('fetchTradesData 오류:', error);
                tradesData = [];
                return [];
            }
        }

        async function renderTable() {
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = ''; // 초기 메시지 제거 후 테이블 비우기

            if (tradesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" style="text-align:center;">매매 기록이 없습니다.</td></tr>';
                return;
            }

            const todayStr = new Date().toISOString().slice(0, 10);
            for (const trade of tradesData) {
                const isExited = trade.status === "Exited";
                let commonPrice = trade.common_exit;
                let preferredPrice = trade.preferred_exit;
                let exitDate = trade.exit_date;
                if (!isExited) {
                    const trend = await fetchTrendClose(trade);
                    commonPrice = trend.commonClose;
                    preferredPrice = trend.preferredClose;
                    exitDate = todayStr;
                }
                const entryDate = new Date(trade.entry_date);
                const lastDate = exitDate ? new Date(exitDate) : new Date();
                const days = Math.max(1, Math.round((lastDate - entryDate) / (1000 * 60 * 60 * 24)));
                const comm_bps = trade.commission_bps || 0;
                const stamp_bps = trade.stamp_bps || 0;
                const borrowFeePct = trade.common_borrow_fee_pct || 0;

                const shortPnl = calcShortPnL(
                    trade.common_entry, commonPrice, trade.common_qty,
                    borrowFeePct, days, comm_bps, stamp_bps
                );
                const longPnl = calcLongPnL(
                    trade.preferred_entry, preferredPrice, trade.preferred_qty,
                    comm_bps, stamp_bps
                );
                const totalPnl = shortPnl + longPnl;
                const totalInvest = trade.common_entry * trade.common_qty + trade.preferred_entry * trade.preferred_qty;
                const totalRet = totalInvest ? (totalPnl / totalInvest * 100) : 0;
                const shortRet = calcReturn(trade.common_entry, trade.common_qty, shortPnl);
                const longRet = calcReturn(trade.preferred_entry, trade.preferred_qty, longPnl);

                // Short(보통주) 행
                const trShort = document.createElement('tr');
                if (isExited) {
                    trShort.classList.add('exited-row');
                }
                trShort.innerHTML = `
                    <td rowspan="2">${trade.pair_name}</td>
                    <td rowspan="2" class="${profitClass(totalPnl)}">${Math.round(totalPnl).toLocaleString()}</td>
                    <td rowspan="2" class="${rateClass(totalRet)}">${totalRet.toFixed(2)}%</td>
                    <td rowspan="2" class="${trade.status === 'Open' ? 'open-green' : ''}">${trade.status}</td>
                    <td>Short</td>
                    <td>${trade.common_code}</td>
                    <td>${trade.entry_date}</td>
                    <td>${isExited ? trade.exit_date : '-'}</td>
                    <td>${trade.common_entry?.toLocaleString() || '-'}</td>
                    <td${!isExited ? ' class="bold-green"' : ''}>${commonPrice != null ? commonPrice.toLocaleString() : '-'}</td>
                    <td>${trade.common_qty}</td>
                    <td class="${profitClass(shortPnl)}">${Math.round(shortPnl).toLocaleString()}</td>
                    <td class="${rateClass(shortRet)}">${shortRet.toFixed(2)}%</td>
                    <td>${days}</td>
                `;
                tbody.appendChild(trShort);

                // Long(우선주) 행
                const trLong = document.createElement('tr');
                if (isExited) {
                    trLong.classList.add('exited-row');
                }
                trLong.innerHTML = `
                    <td>Long</td>
                    <td>${trade.preferred_code}</td>
                    <td>${trade.entry_date}</td>
                    <td>${isExited ? trade.exit_date : '-'}</td>
                    <td>${trade.preferred_entry?.toLocaleString() || '-'}</td>
                    <td${!isExited ? ' class="bold-green"' : ''}>${preferredPrice != null ? preferredPrice.toLocaleString() : '-'}</td>
                    <td>${trade.preferred_qty}</td>
                    <td class="${profitClass(longPnl)}">${Math.round(longPnl).toLocaleString()}</td>
                    <td class="${rateClass(longRet)}">${longRet.toFixed(2)}%</td>
                    <td>${days}</td>
                `;
                tbody.appendChild(trLong);
            }
        }

        async function init() {
            try {
                document.getElementById('loading-container').style.display = 'flex';
                document.getElementById('content-container').classList.add('hidden');

                await updateLastUpdate();
                await fetchTradesData();
                await renderTable();

                document.getElementById('loading-container').style.display = 'none';
                document.getElementById('content-container').classList.remove('hidden');
            } catch (error) {
                console.error('초기화 오류:', error);
                document.getElementById('loading-container').innerHTML = `
                    <div class="text-red-500 text-center">
                        <p>데이터를 로드할 수 없습니다.</p>
                        <p>${error.message}</p>
                        <button onclick="window.location.reload()" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded">
                            다시 시도
                        </button>
                        <button onclick="window.location.href='index.html'" class="mt-4 ml-2 px-4 py-2 bg-gray-500 text-white rounded">
                            메인 페이지로 돌아가기
                        </button>
                    </div>
                `;
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>