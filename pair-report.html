<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>페어 트레이딩 리포트 (cal.xlsx 방식)</title>
    <style>
        body {
            font-family: sans-serif;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px;
        }

        th {
            background: #f3f3f3;
        }

        .pair-summary {
            background: #e6f7ff;
            font-weight: bold;
        }

        .stock-row {
            background: #f9f9f9;
        }

        .center {
            text-align: center;
        }

        .right {
            text-align: right;
        }

        .profit-plus {
            color: #d60000;
            font-weight: bold;
        }

        .profit-minus {
            color: #0050b3;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>페어 트레이딩 리포트 (cal.xlsx 방식)</h1>
    <table>
        <thead>
            <tr>
                <th rowspan="2">Item</th>
                <th rowspan="2">Total Profit</th>
                <th rowspan="2">Total Rate</th>
                <th>Position</th>
                <th>Code</th>
                <th>Entry D.</th>
                <th>Exit D.</th>
                <th>Entry P.</th>
                <th>Exit(Current)</th>
                <th>Q'ty</th>
                <th>Profit</th>
                <th>Rate</th>
                <th>Floating Amt</th>
                <th>Floating Rate</th>
                <th>Sprd.</th>
                <th>No of days</th>
            </tr>
        </thead>
        <tbody id="report-body">
            <tr>
                <td colspan="16" class="center">데이터 불러오는 중...</td>
            </tr>
        </tbody>
    </table>
    <script>
        function calcFloatingAmt(entry, qty, borrowFeePct, days) {
            if (!entry || !qty || !borrowFeePct || !days) return 0;
            return entry * qty * (borrowFeePct / 100) * (days / 365);
        }
        function calcPnL(entry, exit, qty, direction, floatingAmt = 0) {
            if (entry == null || exit == null || qty == null) return 0;
            const base = (direction === 'S' ? (entry - exit) : (exit - entry)) * qty;
            return direction === 'S' ? base - floatingAmt : base;
        }
        function calcReturn(entry, qty, profit) {
            if (!entry || !qty) return 0;
            return profit / (entry * qty) * 100;
        }
        function profitClass(val) {
            return val > 0 ? 'profit-plus' : (val < 0 ? 'profit-minus' : '');
        }
        function calcSprd(commonEntry, preferredEntry) {
            if (!commonEntry) return 0;
            return (commonEntry - preferredEntry) / commonEntry;
        }
        async function fetchTrendClose(pair) {
            try {
                const res = await fetch('data/trends/' + pair.common_code + '.json');
                const data = await res.json();
                let commonClose = null, preferredClose = null;
                if (data.common_prices && data.common_prices.length > 0)
                    commonClose = data.common_prices[data.common_prices.length - 1];
                if (data.preferred_prices && data.preferred_prices.length > 0)
                    preferredClose = data.preferred_prices[data.preferred_prices.length - 1];
                return { commonClose, preferredClose };
            } catch {
                return { commonClose: null, preferredClose: null };
            }
        }
        async function renderReport() {
            const res = await fetch('data/pair-trades.json');
            const data = await res.json();
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = '';
            const todayStr = new Date().toISOString().slice(0, 10);
            for (const trade of data) {
                const isExited = trade.status === "Exited";
                let commonPrice = trade.common_exit;
                let preferredPrice = trade.preferred_exit;
                let exitDate = trade.exit_date;
                if (!isExited) {
                    const trend = await fetchTrendClose(trade);
                    commonPrice = trend.commonClose;
                    preferredPrice = trend.preferredClose;
                    exitDate = todayStr;
                }
                // 날짜 계산
                const entryDate = new Date(trade.entry_date);
                const lastDate = exitDate ? new Date(exitDate) : new Date();
                const days = Math.max(1, Math.round((lastDate - entryDate) / (1000 * 60 * 60 * 24)));

                // Floating Amt/Rate/Sprd
                const floatingAmt = calcFloatingAmt(trade.common_entry, trade.common_qty, trade.common_borrow_fee_pct || 0, days);
                const floatingRate = (trade.common_borrow_fee_pct || 0) / 100;
                const sprd = calcSprd(trade.common_entry, trade.preferred_entry);

                // 개별 손익/수익률
                const shortPnl = calcPnL(trade.common_entry, commonPrice, trade.common_qty, 'S', floatingAmt);
                const shortRet = calcReturn(trade.common_entry, trade.common_qty, shortPnl);
                const longPnl = calcPnL(trade.preferred_entry, preferredPrice, trade.preferred_qty, 'L');
                const longRet = calcReturn(trade.preferred_entry, trade.preferred_qty, longPnl);

                // 합계 손익/수익률
                const totalPnl = shortPnl + longPnl;
                const totalInvest = trade.common_entry * trade.common_qty + trade.preferred_entry * trade.preferred_qty;
                const totalRet = totalInvest ? (totalPnl / totalInvest * 100) : 0;

                // 요약(합계) 행
                const summaryTr = document.createElement('tr');
                summaryTr.className = 'pair-summary';
                summaryTr.innerHTML = `
          <td>${trade.pair_name}</td>
          <td class="right">${Math.round(totalPnl).toLocaleString()}</td>
          <td class="right">${totalRet.toFixed(2)}%</td>
          <td colspan="13"></td>
        `;
                tbody.appendChild(summaryTr);

                // 보통주 상세 행
                const commonTr = document.createElement('tr');
                commonTr.className = 'stock-row';
                commonTr.innerHTML = `
          <td></td>
          <td></td>
          <td></td>
          <td>Short</td>
          <td>${trade.common_code}</td>
          <td>${trade.entry_date}</td>
          <td>${isExited ? trade.exit_date : '-'}</td>
          <td class="right">${trade.common_entry?.toLocaleString() || '-'}</td>
          <td class="right">${commonPrice != null ? commonPrice.toLocaleString() : '-'}</td>
          <td class="right">${trade.common_qty}</td>
          <td class="right ${profitClass(shortPnl)}">${Math.round(shortPnl).toLocaleString()}</td>
          <td class="right ${profitClass(shortRet)}">${shortRet.toFixed(2)}%</td>
          <td class="right">${Math.round(floatingAmt).toLocaleString()}</td>
          <td class="right">${floatingRate.toFixed(4)}</td>
          <td class="right">${sprd.toFixed(4)}</td>
          <td class="right">${days}</td>
        `;
                tbody.appendChild(commonTr);

                // 우선주 상세 행
                const preferredTr = document.createElement('tr');
                preferredTr.className = 'stock-row';
                preferredTr.innerHTML = `
          <td></td>
          <td></td>
          <td></td>
          <td>Long</td>
          <td>${trade.preferred_code}</td>
          <td>${trade.entry_date}</td>
          <td>${isExited ? trade.exit_date : '-'}</td>
          <td class="right">${trade.preferred_entry?.toLocaleString() || '-'}</td>
          <td class="right">${preferredPrice != null ? preferredPrice.toLocaleString() : '-'}</td>
          <td class="right">${trade.preferred_qty}</td>
          <td class="right ${profitClass(longPnl)}">${Math.round(longPnl).toLocaleString()}</td>
          <td class="right ${profitClass(longRet)}">${longRet.toFixed(2)}%</td>
          <td class="right">0</td>
          <td class="right">0</td>
          <td class="right">${(-sprd).toFixed(4)}</td>
          <td class="right">${days}</td>
        `;
                tbody.appendChild(preferredTr);
            }
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="16" class="center">매매 기록이 없습니다.</td></tr>`;
            }
        }
        renderReport();
    </script>
</body>

</html>