<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>페어 트레이딩 리포트</title>
    <style>
        body {
            font-family: 'Noto Sans KR', Arial, sans-serif;
            background: #f6f8fa;
            color: #222;
            margin: 0;
            padding: 0;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px 0 18px 0;
            margin-bottom: 28px;
            background: #fff;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.03);
            position: relative;
        }

        .center-title {
            margin: 0;
            font-size: 1.45em;
            letter-spacing: -1px;
            text-align: center;
            flex: 1;
            font-weight: 700;
            color: #222;
            word-break: keep-all;
        }

        .home-btn {
            position: absolute;
            right: 28px;
            top: 50%;
            transform: translateY(-50%);
            background: #1976d2;
            color: #fff;
            border: none;
            border-radius: 9px;
            padding: 9px 22px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.06);
        }

        .home-btn:hover {
            background: #1251a0;
        }

        .pair-table-wrap {
            max-width: 1100px;
            margin: 0 auto 30px auto;
            padding: 0 8px;
        }

        .pair-table {
            border-collapse: separate;
            border-spacing: 0 10px;
            width: 100%;
            background: none;
            font-size: 0.97em;
        }

        .pair-table th,
        .pair-table td {
            padding: 9px 7px;
            text-align: center;
            border: none;
            font-size: 0.97em;
            white-space: nowrap;
        }

        .pair-table th {
            background: #e9f0fa;
            color: #444;
            font-weight: 700;
            border-radius: 10px 10px 0 0;
            letter-spacing: 0.02em;
            font-size: 0.97em;
        }

        .pair-table tr.main-row,
        .pair-table tr.sub-row {
            box-shadow: 0 2px 10px rgba(25, 118, 210, 0.03);
            border-radius: 13px;
            background: #fff;
            transition: background 0.2s;
        }

        .pair-table tr.main-row {
            font-weight: bold;
            background: #f3f7fd;
            border-top: 2px solid #1976d2;
        }

        .pair-table tr.main-row.alt {
            background: #f8fafc;
            border-top: 2px solid #d32f2f;
        }

        .pair-table tr.sub-row {
            background: #fff;
            font-size: 0.96em;
        }

        .pair-table tr.sub-row.bold {
            font-weight: bold;
            color: #1976d2;
            background: #f7faff;
        }

        .positive {
            color: #e53935;
            font-weight: bold;
        }

        .negative {
            color: #1976d2;
            font-weight: bold;
        }

        .pair-table td,
        .pair-table th {
            border-bottom: none;
        }

        .small {
            font-size: 0.85em;
            color: #888;
            font-weight: normal;
        }

        @media (max-width: 1000px) {
            .pair-table-wrap {
                max-width: 100vw;
            }

            .pair-table th,
            .pair-table td {
                font-size: 0.92em;
                padding: 7px 3px;
            }

            .center-title {
                font-size: 1.05em;
            }

            .home-btn {
                font-size: 0.97em;
                padding: 7px 10px;
                right: 10px;
            }
        }

        @media (max-width: 600px) {

            .pair-table,
            .pair-table thead,
            .pair-table tbody,
            .pair-table th,
            .pair-table td,
            .pair-table tr {
                display: block;
            }

            .pair-table thead {
                display: none;
            }

            .pair-table tr {
                margin-bottom: 16px;
                border: none !important;
                background: none !important;
                box-shadow: none !important;
            }

            .pair-table td {
                position: relative;
                padding-left: 44%;
                text-align: left;
                border: none;
                border-bottom: 1px solid #e0e7ef;
                background: #fff !important;
                font-size: 0.97em;
                word-break: keep-all;
            }

            .pair-table td:before {
                position: absolute;
                left: 10px;
                top: 8px;
                width: 40%;
                white-space: nowrap;
                font-weight: bold;
                color: #888;
                content: attr(data-label);
            }

            .center-title {
                font-size: 1em;
            }

            .home-btn {
                font-size: 0.93em;
                padding: 7px 7px;
                right: 5px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1 class="center-title">페어 트레이딩 리포트</h1>
        <!-- <button class="home-btn">홈으로</button> -->
    </header>
    <div class="pair-table-wrap">
        <table class="pair-table">
            <thead>
                <tr>
                    <th>종목명</th>
                    <th>합산수익</th>
                    <th>합산수익률</th>
                    <th>구분</th>
                    <th>진입일</th>
                    <th>진입가</th>
                    <th>수량</th>
                    <th>현재/청산가</th>
                    <th>수익</th>
                    <th>수익률</th>
                    <th>청산일(소요일수)</th>
                    <th>상태</th>
                </tr>
            </thead>
            <tbody id="pairTableBody">
                <!-- 자바스크립트가 테이블 항목 렌더링 -->
            </tbody>
        </table>
    </div>
    <script>
        // 숫자 포매팅 함수
        function formatNumber(num) {
            if (num === null || num === undefined || num === "-") return "-";
            if (isNaN(num)) return num;
            return Number(num).toLocaleString("en-US");
        }
        // 장중 여부 체크
        function isMarketTime() {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();
            const minute = now.getMinutes();
            const isWeekday = day >= 1 && day <= 5;
            const afterOpen = hour > 8 || (hour === 8 && minute >= 30);
            const beforeClose = hour < 16 || (hour === 16 && minute <= 30);
            return isWeekday && afterOpen && beforeClose;
        }
        // (선택) 실시간/마감가 fetch 예시 - 실제 운영 시 필요에 맞게 수정!
        async function fetchClosingPrice(stockCode, isCommon) {
            // 여기에 데이터 제공 로직이 있다면 추가
            return "-";
        }
        async function fetchRealtimePrice(stockCode) {
            // 여기에 데이터 제공 로직이 있다면 추가
            return "-";
        }
        async function getCurrentOrClosingPrice(stockCode, isCommon) {
            // 실제 장중/장외 데이터가 필요하다면 위 함수에 맞게 구현!
            return "-";
        }
        // 금리 계산
        function getFloatingRate(benchmark_rate_pct, floating_spread_bps) {
            const base = Number(benchmark_rate_pct) || 0;
            const spread = Number(floating_spread_bps) / 100 || 0;
            return base + spread;
        }
        // 소요일수 구하기
        function calcDays(entryDate, exitDate) {
            if (!entryDate) return "-";
            const start = new Date(entryDate);
            const end = exitDate ? new Date(exitDate) : new Date();
            const diffDays = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;
            return diffDays > 0 ? diffDays : "-";
        }
        // Short 포지션 손익
        function calcShortPnL(entry, exit, qty, floatingRate, spread, days) {
            if (!entry || !exit || !qty || entry === "-" || exit === "-") return { pnl: 0, pnlStr: "-", ret: "-" };
            const entryAmt = entry * qty;
            const exitAmt = exit * qty;
            const borrowRate = Number(floatingRate) + (Number(spread) || 0);
            const borrowFee = entryAmt * (borrowRate / 100) * (days / 365);
            const equityPnL = entryAmt - exitAmt;
            const pnl = equityPnL - borrowFee;
            const ret = entryAmt !== 0 ? (pnl / entryAmt * 100).toFixed(2) + "%" : "-";
            return { pnl, pnlStr: formatNumber(Math.round(pnl)), ret };
        }
        // Long 포지션 손익
        function calcLongPnL(entry, exit, qty, floatingRate, spread, days) {
            if (!entry || !exit || !qty || entry === "-" || exit === "-") return { pnl: 0, pnlStr: "-", ret: "-" };
            const entryAmt = entry * qty;
            const exitAmt = exit * qty;
            const lendRate = Number(floatingRate) + (Number(spread) || 0);
            const lendFee = entryAmt * (lendRate / 100) * (days / 365);
            const equityPnL = exitAmt - entryAmt;
            const pnl = equityPnL - lendFee;
            const ret = entryAmt !== 0 ? (pnl / entryAmt * 100).toFixed(2) + "%" : "-";
            return { pnl, pnlStr: formatNumber(Math.round(pnl)), ret };
        }
        // 페어 트레이드 데이터 fetch
        async function fetchPairs() {
            const resp = await fetch('data/pair-trades.json');
            return await resp.json();
        }
        // 테이블 그리기
        async function renderTable() {
            const pairs = await fetchPairs();
            const tbody = document.getElementById("pairTableBody");
            tbody.innerHTML = "";
            let alt = 0;
            for (const entry of pairs) {
                let cNow = "-", pNow = "-";
                let days = calcDays(entry.entry_date, entry.exit_date);
                let daysNum = days === "-" ? 0 : Number(days);
                // 실제 실시간/마감가 필요하면 아래 부분 수정
                if (entry.status === "Open") {
                    cNow = await getCurrentOrClosingPrice(entry.common_code, true);
                    pNow = await getCurrentOrClosingPrice(entry.preferred_code, false);
                } else {
                    cNow = entry.common_exit !== null && entry.common_exit !== undefined ? entry.common_exit : "-";
                    pNow = entry.preferred_exit !== null && entry.preferred_exit !== undefined ? entry.preferred_exit : "-";
                }
                const short = calcShortPnL(
                    entry.common_entry, cNow, entry.common_qty,
                    entry.benchmark_rate_pct, entry.common_floating_spread_bps, daysNum
                );
                const long = calcLongPnL(
                    entry.preferred_entry, pNow, entry.preferred_qty,
                    entry.benchmark_rate_pct, entry.preferred_floating_spread_bps, daysNum
                );
                const pairProfit = (typeof short.pnl === "number" ? short.pnl : 0) + (typeof long.pnl === "number" ? long.pnl : 0);
                const pairEntry = (entry.common_entry && entry.common_qty ? entry.common_entry * entry.common_qty : 0) + (entry.preferred_entry && entry.preferred_qty ? entry.preferred_entry * entry.preferred_qty : 0);
                const pairReturn = pairEntry !== 0 ? (pairProfit / pairEntry * 100).toFixed(2) + "%" : "-";
                const pairProfitStr = formatNumber(Math.round(pairProfit));
                const pairProfitClass = pairProfit > 0 ? "positive" : (pairProfit < 0 ? "negative" : "");
                const pairRetClass = pairReturn !== "-" && parseFloat(pairReturn) > 0 ? "positive" : (pairReturn !== "-" && parseFloat(pairReturn) < 0 ? "negative" : "");
                // 청산일이 있으면 소요일수 표시
                let daysInfo = "";
                if (entry.exit_date && entry.entry_date) {
                    const days = calcDays(entry.entry_date, entry.exit_date);
                    daysInfo = `(${days}일)`;
                }
                tbody.innerHTML += `
          <tr class="main-row ${alt % 2 === 1 ? 'alt' : ''}">
            <td rowspan="2">${entry.pair_name}</td>
            <td rowspan="2" class="${pairProfitClass}">${pairProfitStr}</td>
            <td rowspan="2" class="${pairRetClass}">${pairReturn}</td>
            <td>보통주(short)</td>
            <td>${entry.entry_date || "-"}</td>
            <td>${formatNumber(entry.common_entry)}</td>
            <td>${formatNumber(entry.common_qty)}</td>
            <td>${formatNumber(cNow)}</td>
            <td>${short.pnlStr}</td>
            <td>${short.ret}</td>
            <td>${entry.exit_date ? entry.exit_date : "-"}${daysInfo}</td>
            <td rowspan="2">${entry.status}</td>
          </tr>
          <tr class="sub-row">
            <td>우선주(long)</td>
            <td>${entry.entry_date || "-"}</td>
            <td>${formatNumber(entry.preferred_entry)}</td>
            <td>${formatNumber(entry.preferred_qty)}</td>
            <td>${formatNumber(pNow)}</td>
            <td>${long.pnlStr}</td>
            <td>${long.ret}</td>
            <td>${entry.exit_date ? entry.exit_date : "-"}${daysInfo}</td>
          </tr>
        `;
                alt++;
            }
        }
        window.addEventListener('DOMContentLoaded', renderTable);
    </script>
</body>

</html>