<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>EQ Pair Trading REPORT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* 웹폰트 추가 */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Noto Sans KR", sans-serif;
            background: #f8f9fa;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
        }

        h1 {
            font-size: 1.875rem; /* index.html의 text-3xl과 동일 */
            font-weight: 700;
            color: #1F2937; /* index.html의 text-gray-800과 동일 */
            text-align: left;
            margin: 2rem 0 0.5rem 0;
            letter-spacing: -1px;
            width: 100%;
            max-width: 1500px;
        }

        .last-update-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1em;
            width: 100%;
            max-width: 1500px;
            padding: 0 5px;
            /* 좌우 패딩 추가 */
        }

        .last-update {
            font-size: 0.875rem; /* index.html의 text-sm과 동일 */
            color: #4B5563; /* index.html의 text-gray-600과 동일 */
        }

        .last-update #last-update {
            font-weight: 500; /* index.html의 font-medium과 동일 */
        }

        .report-table-wrap {
            width: 100%;
            max-width: 1500px;
            /* 1100px에서 1300px로 증가 */
            margin: 0 auto 3em auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: auto;
            /* 전체 테이블을 스크롤 가능하게 설정 */
        }

        table.report-table {
            width: 100%;
            min-width: 1300px;
            /* 1000px에서 1200px로 증가 */
            margin: 0 auto;
            border-collapse: separate;
            border-spacing: 0 10px;
            table-layout: auto;
            background: none;
        }

        .report-table th,
        .report-table td {
            padding: 16px 8px;
            /* 4px에서 8px로 셀 패딩 증가 */
            font-size: 1em;
            text-align: center;
            background: #fff;
            border-bottom: 1.5px solid #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .report-table th {
            background: #f3f3f3;
            font-weight: 700;
            font-size: 1.07em;
            border-top: 1.5px solid #e0e0e0;
        }

        .profit-plus {
            color: #d60000;
            font-weight: bold;
        }

        .profit-minus {
            color: #0050b3;
            font-weight: bold;
        }

        .rate-plus {
            color: #d60000;
            font-weight: bold;
        }

        .rate-minus {
            color: #0050b3;
            font-weight: bold;
        }

        .bold-green {
            color: #1ca93a;
            font-weight: bold;
        }

        .open-green {
            color: #1ca93a !important;
            font-weight: bold !important;
            letter-spacing: 0.5px;
        }

        @media (max-width: 1200px) {
            h1 {
                max-width: 95%;
                font-size: 1.5rem; /* 작은 화면에서 약간 작게 */
            }

            .last-update-wrapper {
                max-width: 95%;
                padding: 0 10px;
                box-sizing: border-box;
            }

            .last-update {
                font-size: 0.75rem; /* 작은 화면에서 조정 */
            }

            .report-table th,
            .report-table td {
                font-size: 0.9em;
                padding: 8px 2px;
            }
        }

        @media (max-width: 700px) {
            h1 {
                font-size: 1.25rem; /* 모바일에서 더 작게 */
            }

            .last-update {
                font-size: 0.7rem;
            }

            .report-table th,
            .report-table td {
                font-size: 0.8em;
                padding: 6px 1px;
            }

            .report-table-wrap {
                margin: 0 auto 1em auto;
            }
        }
    </style>
</head>

<body>
    <h1>EQ Pair Trading REPORT</h1>
    <div class="report-table-wrap">
        <div class="last-update-wrapper">
            <span class="last-update" id="last-update">Last update: -</span>
            <a href="index.html" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-home mr-2"></i> Home
            </a>
        </div>
        <table class="report-table" id="report-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Total Profit</th>
                    <th>Rate</th>
                    <th>Status</th>
                    <th>Pos.</th>
                    <th>Code</th>
                    <th>Entry D.</th>
                    <th>Exit D.</th>
                    <th>Entry P.</th>
                    <th>Exit(Curr.)</th>
                    <th>Q'ty</th>
                    <th>Profit</th>
                    <th>Rate</th>
                    <th>Days</th>
                </tr>
            </thead>
            <tbody id="report-body">
                <tr>
                    <td colspan="14" style="text-align:center;">Loading Data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    <script>
        function calcFee(entry, exit, qty, bps) {
            if (!entry || !exit || !qty || !bps) return 0;
            return (entry * qty + exit * qty) * (bps / 10000);
        }
        function calcBorrowFee(entry, qty, borrowFeePct, days) {
            if (!entry || !qty || !borrowFeePct || !days) return 0;
            return entry * qty * (borrowFeePct / 100) * (days / 365);
        }
        function calcShortPnL(entry, exit, qty, borrowFeePct, days, comm_bps, stamp_bps) {
            const base = (entry - exit) * qty;
            const borrowFee = calcBorrowFee(entry, qty, borrowFeePct, days);
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return base - borrowFee - commission - stamp;
        }
        function calcLongPnL(entry, exit, qty, comm_bps, stamp_bps) {
            const base = (exit - entry) * qty;
            const commission = calcFee(entry, exit, qty, comm_bps);
            const stamp = calcFee(entry, exit, qty, stamp_bps);
            return base - commission - stamp;
        }
        function calcReturn(entry, qty, profit) {
            if (!entry || !qty) return 0;
            return profit / (entry * qty) * 100;
        }
        function profitClass(val) {
            return val > 0 ? 'profit-plus' : (val < 0 ? 'profit-minus' : '');
        }
        function rateClass(val) {
            return val > 0 ? 'rate-plus' : (val < 0 ? 'rate-minus' : '');
        }
        async function fetchTrendClose(pair) {
            try {
                const res = await fetch('data/trends/' + pair.common_code + '.json');
                const data = await res.json();
                let commonClose = null, preferredClose = null;
                if (data.common_prices && data.common_prices.length > 0)
                    commonClose = data.common_prices[data.common_prices.length - 1];
                if (data.preferred_prices && data.preferred_prices.length > 0)
                    preferredClose = data.preferred_prices[data.preferred_prices.length - 1];
                return { commonClose, preferredClose };
            } catch {
                return { commonClose: null, preferredClose: null };
            }
        }
        async function updateLastUpdate() {
            try {
                const res = await fetch('data/stock_data.json');
                const data = await res.json();
                let last = data.last_updated || data.timestamp || '';
                if (last) {
                    document.getElementById('last-update').textContent = 'Last update: ' + last;
                }
            } catch {
                document.getElementById('last-update').textContent = 'Last update: -';
            }
        }
        async function renderTable() {
            await updateLastUpdate();
            const res = await fetch('data/pair-trades.json');
            const data = await res.json();
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = '';
            const todayStr = new Date().toISOString().slice(0, 10);
            for (const trade of data) {
                const isExited = trade.status === "Exited";
                let commonPrice = trade.common_exit;
                let preferredPrice = trade.preferred_exit;
                let exitDate = trade.exit_date;
                if (!isExited) {
                    const trend = await fetchTrendClose(trade);
                    commonPrice = trend.commonClose;
                    preferredPrice = trend.preferredClose;
                    exitDate = todayStr;
                }
                const entryDate = new Date(trade.entry_date);
                const lastDate = exitDate ? new Date(exitDate) : new Date();
                const days = Math.max(1, Math.round((lastDate - entryDate) / (1000 * 60 * 60 * 24)));
                const comm_bps = trade.commission_bps || 0;
                const stamp_bps = trade.stamp_bps || 0;
                const borrowFeePct = trade.common_borrow_fee_pct || 0;

                const shortPnl = calcShortPnL(
                    trade.common_entry, commonPrice, trade.common_qty,
                    borrowFeePct, days, comm_bps, stamp_bps
                );
                const longPnl = calcLongPnL(
                    trade.preferred_entry, preferredPrice, trade.preferred_qty,
                    comm_bps, stamp_bps
                );
                const totalPnl = shortPnl + longPnl;
                const totalInvest = trade.common_entry * trade.common_qty + trade.preferred_entry * trade.preferred_qty;
                const totalRet = totalInvest ? (totalPnl / totalInvest * 100) : 0;
                const shortRet = calcReturn(trade.common_entry, trade.common_qty, shortPnl);
                const longRet = calcReturn(trade.preferred_entry, trade.preferred_qty, longPnl);

                // Short(보통주) 행
                const trShort = document.createElement('tr');
                trShort.innerHTML = `
          <td rowspan="2">${trade.pair_name}</td>
          <td rowspan="2" class="${profitClass(totalPnl)}">${Math.round(totalPnl).toLocaleString()}</td>
          <td rowspan="2" class="${rateClass(totalRet)}">${totalRet.toFixed(2)}%</td>
          <td rowspan="2" class="${trade.status === 'Open' ? 'open-green' : ''}">${trade.status}</td>
          <td>Short</td>
          <td>${trade.common_code}</td>
          <td>${trade.entry_date}</td>
          <td>${isExited ? trade.exit_date : '-'}</td>
          <td>${trade.common_entry?.toLocaleString() || '-'}</td>
          <td${!isExited ? ' class="bold-green"' : ''}>${commonPrice != null ? commonPrice.toLocaleString() : '-'}</td>
          <td>${trade.common_qty}</td>
          <td class="${profitClass(shortPnl)}">${Math.round(shortPnl).toLocaleString()}</td>
          <td class="${rateClass(shortRet)}">${shortRet.toFixed(2)}%</td>
          <td>${days}</td>
        `;
                tbody.appendChild(trShort);

                // Long(우선주) 행
                const trLong = document.createElement('tr');
                trLong.innerHTML = `
          <td>Long</td>
          <td>${trade.preferred_code}</td>
          <td>${trade.entry_date}</td>
          <td>${isExited ? trade.exit_date : '-'}</td>
          <td>${trade.preferred_entry?.toLocaleString() || '-'}</td>
          <td${!isExited ? ' class="bold-green"' : ''}>${preferredPrice != null ? preferredPrice.toLocaleString() : '-'}</td>
          <td>${trade.preferred_qty}</td>
          <td class="${profitClass(longPnl)}">${Math.round(longPnl).toLocaleString()}</td>
          <td class="${rateClass(longRet)}">${longRet.toFixed(2)}%</td>
          <td>${days}</td>
        `;
                tbody.appendChild(trLong);
            }
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="14" style="text-align:center;">매매 기록이 없습니다.</td></tr>`;
            }
        }
        renderTable();
    </script>
</body>

</html>